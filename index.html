<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Acad√©mico Administraci√≥n - UNMSM PRO</title>
    <!-- Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* Colores UNMSM Light */
            --primary: #8a0303; 
            --accent: #f1c40f; 
            --bg-body: #f4f6f8; 
            --bg-card: #ffffff; 
            --text-main: #2c3e50; 
            --border: #e0e0e0;
            --grid-line: #eee;
            
            /* Colores Ramas */
            --c-fin: #27ae60; --c-mkt: #e67e22; --c-rrhh: #8e44ad; --c-op: #2980b9;
        }

        body.dark-mode {
            /* Colores Dark */
            --primary: #c0392b; 
            --accent: #f39c12; 
            --bg-body: #1a1a2e; 
            --bg-card: #16213e; 
            --text-main: #e0e0e0; 
            --border: #333;
            --grid-line: #2c3e50;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 60px; transition: background 0.3s, color 0.3s; }
        * { box-sizing: border-box; transition: all 0.2s ease; outline: none; }

        /* --- NAV --- */
        .navbar {
            background: var(--primary); color: white; height: 70px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-bottom: 4px solid var(--accent);
        }
        /* Modificaci√≥n: Ajuste para logo e imagen */
        .nav-brand { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .nav-logo-img { height: 50px; width: auto; background: white; border-radius: 50%; padding: 2px; }

        .nav-menu { display: flex; gap: 10px; align-items: center; }
        .nav-btn { 
            background: rgba(255,255,255,0.1); border: none; color: white; 
            padding: 8px 15px; cursor: pointer; border-radius: 20px; 
            display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 0.9rem;
        }
        .nav-btn:hover, .nav-btn.active { background: white; color: var(--primary); }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; margin-left: 10px; }

        /* --- LAYOUT --- */
        .page-section { display: none; padding: 25px; max-width: 1800px; margin: 0 auto; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MALLA STYLES --- */
        .malla-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg-card); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid var(--primary); }
        .malla-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 30px; align-items: flex-start; }
        .cycle-col { min-width: 250px; max-width: 250px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
        .cycle-title { text-align: center; background: #333; color: white; padding: 8px; border-radius: 4px; font-weight: bold; border-bottom: 3px solid var(--accent); }
        
        .course-card { background: var(--bg-card); border: 1px solid var(--border); border-left: 5px solid #999; padding: 10px; border-radius: 6px; cursor: pointer; min-height: 85px; font-size: 0.85rem; position: relative; }
        .course-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .course-card.completed { background: #e8f5e9; border-color: var(--primary); border-left-color: var(--primary); }
        .course-card.locked { opacity: 0.6; background: #f5f5f5; cursor: not-allowed; filter: grayscale(1); }
        .course-card.completed::after { content: '‚úî'; position: absolute; top: 5px; right: 5px; color: var(--primary); font-weight: bold; }
        
        body.dark-mode .course-card.completed { background: #1b4d3e; color: #fff; }
        body.dark-mode .course-card.locked { background: #222; opacity: 0.4; }

        .type-O { border-left-color: var(--primary); } 
        .type-E { border-left-color: var(--accent); }
        
        .grade-badge { position: absolute; bottom: 5px; right: 5px; background: #333; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }

        /* --- DASHBOARD PROGRESO --- */
        .dashboard-container { display: grid; grid-template-columns: 1fr 350px; gap: 25px; margin-bottom: 30px; }
        .chart-card { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
        .stats-card { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .stat-row { margin-bottom: 20px; }
        .stat-label { display: flex; justify-content: space-between; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: #777; }
        .stat-bar-bg { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; }
        .stat-bar-fill { height: 100%; transition: width 1s ease; border-radius: 6px; }
        
        .projection-box { margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 5px solid #2196f3; border-radius: 4px; color: #333; }
        .projection-title { font-weight: bold; color: #1565c0; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        body.dark-mode .projection-box { background: #1a2639; color: #eee; }
        
        .btn-export { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; margin-top: 20px; width: 100%; justify-content: center; }
        .btn-export:hover { background: #000; }
        .btn-ics { background: #2980b9; }
        .btn-ics:hover { background: #1c5980; }

        /* --- ANALITICA STYLES MODIFICADO --- */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* --- SKILLS STYLES --- */
        .profile-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .profile-card { padding: 15px; border-radius: 8px; background: #fafafa; border: 1px solid var(--border); }
        body.dark-mode .profile-card { background: #252a40; }
        .profile-title { font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .profile-percent { font-size: 2rem; font-weight: bold; float: right; margin-top: -35px; opacity: 0.2; }
        .profile-bar-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .profile-bar-fill { height: 100%; width: 0%; transition: width 0.6s ease; }
        .tools-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .tool-chip { background: var(--bg-card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tool-chip.active { background: #e3f2fd; border-color: #2196f3; color: #0d47a1; font-weight: 600; }
        .tool-check { width: 18px; height: 18px; border-radius: 4px; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; flex-shrink: 0; }
        .tool-chip.active .tool-check { background: #2196f3; border-color: #2196f3; }

        /* --- SIMULADOR STYLES --- */
        .scheduler-container { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
        .scheduler-controls { flex: 1; min-width: 300px; background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid var(--accent); }
        .scheduler-grid-wrapper { flex: 3; min-width: 600px; overflow-x: auto; background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .form-select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; background: var(--bg-card); color: var(--text-main); }
        .btn-add { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .time-grid { display: grid; grid-template-columns: 60px repeat(6, 1fr); border: 1px solid var(--border); }
        .grid-header { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; }
        .grid-time-cell { border-bottom: 1px solid var(--grid-line); border-right: 1px solid var(--grid-line); height: 50px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #666; background: rgba(0,0,0,0.02); }
        .grid-cell { border-bottom: 1px solid var(--grid-line); border-right: 1px solid var(--grid-line); height: 50px; position: relative; }
        .course-block { position: absolute; width: 95%; left: 2.5%; padding: 5px; border-radius: 4px; color: white; font-size: 0.75rem; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .remove-course { position: absolute; top: 2px; right: 2px; cursor: pointer; font-weight: bold; font-size: 10px; background: rgba(0,0,0,0.2); border-radius: 50%; width: 15px; height: 15px; line-height: 15px; }

        /* --- CALCULADORA STYLES --- */
        .calc-wrapper { display: flex; gap: 30px; flex-wrap: wrap; }
        .calc-inputs { flex: 1; min-width: 320px; background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .calc-results { flex: 1; min-width: 320px; background: #fffbe6; border: 2px solid #ffe58f; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; position: relative; color:#333; }
        body.dark-mode .calc-results { background: #2c2c2c; border-color: #444; color: #eee; }
        
        .grade-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; animation: fadeIn 0.3s; }
        .grade-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .weight-input { width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .btn-del-row { color: #c0392b; cursor: pointer; padding: 5px; background: none; border: none; font-weight: bold; font-size: 1.2rem; }
        
        .btn-calc-action { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-calc-main { background: #4a148c; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; font-size: 1.1rem; }
        .result-big { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }

        @media (max-width: 768px) {
            .navbar { flex-direction: column; height: auto; padding: 10px; }
            .nav-menu { margin-top: 10px; flex-wrap: wrap; justify-content: center; }
            .scheduler-container, .dashboard-container, .calc-wrapper, .analytics-grid { grid-template-columns: 1fr; flex-direction: column; }
            .scheduler-grid-wrapper { min-width: 100%; }
        }
    </style>
</head>
<body>

    <!-- ========================================== -->
    <!-- PANTALLA DE LOGIN CON GOOGLE (FIREBASE)  -->
    <!-- ========================================== -->
    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#8a0303; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; transition:opacity 0.5s;">
        <div style="background:white; padding:40px; border-radius:15px; text-align:center; color:#333; box-shadow:0 10px 30px rgba(0,0,0,0.3); max-width:400px; width:90%;">
            <img src="unmsm.png" style="height:80px; margin-bottom:20px;">
            <h2 style="margin:0 0 10px 0; color:#8a0303;">Acceso Restringido</h2>
            <p style="margin-bottom:25px; color:#666;">Ingresa con tu correo autorizado.</p>
            
            <button id="google-login-btn" style="background:#4285F4; color:white; border:none; padding:12px 25px; border-radius:50px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size:1rem; box-shadow:0 2px 5px rgba(0,0,0,0.2); width:100%;">
                <span style="background:white; border-radius:50%; padding:2px; display:flex;"><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="18"></span>
                Iniciar sesi√≥n con Google
            </button>
            <p id="login-error" style="color:red; margin-top:15px; font-size:0.9rem; display:none; font-weight:bold;"></p>
        </div>
        <div style="margin-top:20px; font-size:0.8rem; opacity:0.7;">Esta plataforma es una herramienta de organizaci√≥n personal. No es una p√°gina oficial de la universidad</div>
    </div>
    <!-- ========================================== -->
     
    <nav class="navbar">
        <div class="nav-brand">
            <!-- MODIFICACI√ìN: IMAGEN UNMSM -->
            <img src="unmsm.png" alt="UNMSM" class="nav-logo-img">
            <span>Administraci√≥n UNMSM</span>
        </div>
        <div class="nav-menu">
            <!-- Bot√≥n Configuraci√≥n (NUEVO) -->
            <button class="nav-btn" onclick="showPage('config')"><span class="material-icons">settings_suggest</span> Mi Carrera</button>
            
            <button class="nav-btn" onclick="showPage('estrategia')"><span class="material-icons">psychology_alt</span> Estrategia IA</button>
            <button class="nav-btn active" onclick="showPage('malla')"><span class="material-icons">grid_view</span> Malla</button>
            <button class="nav-btn" onclick="showPage('progreso')"><span class="material-icons">trending_up</span> Progreso</button>
            <button class="nav-btn" onclick="showPage('analitica')"><span class="material-icons">analytics</span> Anal√≠tica</button>
            <button class="nav-btn" onclick="showPage('calculadora')"><span class="material-icons">calculate</span> Notas</button>
            <button class="nav-btn" onclick="showPage('skills')"><span class="material-icons">psychology</span> Skills</button>
            <button class="nav-btn" onclick="showPage('simulador')"><span class="material-icons">schedule</span> Simulador</button>
            <button class="nav-btn" onclick="showPage('recursos')"><span class="material-icons">link</span> Recursos</button>
            
            <!-- Bot√≥n Salir (NUEVO) -->
            <button class="nav-btn" style="background:#c0392b;" onclick="logout()"><span class="material-icons">logout</span></button>
        </div>
    </nav>

    <!-- P√ÅGINA 1: MALLA -->
    <div id="page-malla" class="page-section active">
        <div class="malla-header">
            <div>
                <span style="font-size:1.5rem; font-weight:bold; color:var(--primary)" id="credits-display">0</span>
                <small>Cr√©ditos | </small>
                <span style="font-size:1.5rem; font-weight:bold; color:var(--c-op)" id="pps-display">0.00</span>
                <small>P.P.S. Aprox</small>
            </div>
            <div style="font-size:0.9rem; color:#666;">
                <span style="display:inline-block; width:10px; height:10px; background:var(--primary);"></span> Obligatorio
                <span style="display:inline-block; width:10px; height:10px; background:var(--accent); margin-left:10px;"></span> Electivo
            </div>
            <div>
                <button onclick="resetMalla()" style="background:#c0392b; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Reiniciar Todo</button>
            </div>
        </div>
        <div class="malla-container" id="malla-grid"></div>
    </div>

    <!-- P√ÅGINA 2: DASHBOARD PROGRESO -->
    <div id="page-progreso" class="page-section">
        <div id="export-content">
            <h2 style="text-align:center; margin-bottom:20px;">Reporte de Progreso Acad√©mico</h2>
            
            <div class="dashboard-container">
                <!-- Gr√°fico Dona -->
                <div class="chart-card">
                    <h3>Avance para Egresar</h3>
                    <div style="height:250px; width:250px;">
                        <canvas id="progressChart"></canvas>
                    </div>
                    <p style="margin-top:15px; font-weight:bold; color:var(--primary);" id="chart-text">0% Completado</p>
                </div>

                <!-- Estad√≠sticas y Proyecci√≥n -->
                <div class="stats-card">
                    <h3>Cr√©ditos vs Meta (220)</h3>
                    <p style="font-size:0.8rem; color:#666;">Se requieren 220 Cr√©ditos para egresar, independientemente de cu√°ntos electivos extra lleves.</p>
                    
                    <div class="stat-row">
                        <div class="stat-label"><span>Progreso Real</span> <span id="stat-total">0 / 220</span></div>
                        <div class="stat-bar-bg"><div class="stat-bar-fill" id="bar-total" style="width:0%; background:var(--primary);"></div></div>
                    </div>

                    <div class="projection-box">
                        <div class="projection-title"><span class="material-icons">timer</span> Tiempo Restante</div>
                        <p id="grad-projection" style="font-size:1.1rem; margin:0; font-weight:500;">Calculando...</p>
                        <small style="display:block; margin-top:5px; opacity:0.8;">*C√°lculo basado en 21 cr√©ditos por ciclo.</small>
                    </div>
                    
                    <div style="margin-top:20px; text-align:center; padding:15px; background:rgba(0,0,0,0.03); border-radius:8px;">
                        <div style="font-size:2rem; font-weight:bold; color:var(--primary)" id="pps-dashboard">0.00</div>
                        <small>Promedio Ponderado Acumulado Estimado</small>
                    </div>
                </div>
            </div>
        </div>
        <!-- MODIFICACI√ìN: SE ELIMIN√ì BOT√ìN CV -->
        <div style="display:flex; gap:10px; justify-content: center;">
            <button class="btn-export" onclick="exportPDF()"><span class="material-icons">picture_as_pdf</span> Descargar Reporte Completo</button>
        </div>
    </div>

    <!-- P√ÅGINA 2.5: ANAL√çTICA (MODIFICADO) -->
    <div id="page-analitica" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Inteligencia de Negocios Personal</h2>
        
        <div class="analytics-grid">
            <!-- Gr√°fico Lineal: Rendimiento por Ciclo -->
            <div class="chart-card">
                <h3>Historial de Promedio (PPS) por Ciclo</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="ppsHistoryChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico Polar/Pie: Distribuci√≥n de Cursos -->
            <div class="chart-card">
                <h3>Perfil de Especializaci√≥n</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="skillsRadarChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Basado en cursos aprobados de cada rama.</small>
            </div>
            
            <!-- NUEVO: Comparativa por √Åreas -->
            <div class="chart-card">
                <h3>Avance de Cr√©ditos por √Årea</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="areaProgressChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Cr√©ditos aprobados vs Total disponible por rama.</small>
            </div>

            <!-- NUEVO: Distribuci√≥n de Notas -->
            <div class="chart-card">
                <h3>Distribuci√≥n de Rendimiento</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="gradesDistChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Clasificaci√≥n de notas obtenidas.</small>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 3: CALCULADORA -->
    <div id="page-calculadora" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">Calculadora de Notas</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Proyecta tu nota final ingresando tus calificaciones parciales.</p>

        <div class="calc-wrapper">
            <div class="calc-inputs">
                <div id="grades-container"></div>
                <button class="btn-calc-action" onclick="addGradeRow()">+ Agregar nota</button>
                <div style="margin-top:25px; padding-top:15px; border-top:1px solid #eee;">
                    <label class="form-label">Nota Aprobatoria (UNMSM):</label>
                    <input type="number" id="calc-min-pass" class="form-select" value="11" style="text-align:center; font-weight:bold;">
                </div>
                <button class="btn-calc-main" onclick="calculateGrades()">Calcular Promedio</button>
                <button onclick="resetCalculator()" style="width:100%; margin-top:10px; background:none; border:none; text-decoration:underline; cursor:pointer; color:#777;">Limpiar datos</button>
            </div>

            <div class="calc-results">
                <h3>Resultados</h3>
                <div style="margin-bottom:10px; font-size:0.9rem; opacity:0.8;">Promedio Actual:</div>
                <div id="res-current-avg" class="result-big">0.00</div>
                <div id="res-analysis" style="font-size:1.1rem; line-height:1.5;">Ingresa tus notas...</div>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 4: SKILLS DASHBOARD -->
    <div id="page-skills" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Perfil Profesional (Skills)</h2>
        <div class="profile-dashboard">
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-fin)"><span class="material-icons">attach_money</span> Finanzas</div>
                <div class="profile-percent" id="pct-fin">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-fin" style="background:var(--c-fin)"></div></div>
            </div>
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-mkt)"><span class="material-icons">campaign</span> Marketing</div>
                <div class="profile-percent" id="pct-mkt">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-mkt" style="background:var(--c-mkt)"></div></div>
            </div>
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-rrhh)"><span class="material-icons">groups</span> RRHH</div>
                <div class="profile-percent" id="pct-rrhh">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-rrhh" style="background:var(--c-rrhh)"></div></div>
            </div>
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-op)"><span class="material-icons">settings</span> Gesti√≥n/Ops</div>
                <div class="profile-percent" id="pct-op">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-op" style="background:var(--c-op)"></div></div>
            </div>
        </div>
        <h3 style="margin-bottom:15px; color:#555;">Marcar Herramientas Dominadas:</h3>
        <div class="tools-container" id="tools-grid"></div>
    </div>

    <!-- P√ÅGINA 5: SIMULADOR HORARIO -->
    <div id="page-simulador" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
            <h2 style="margin:0;">Simulador de Matr√≠cula</h2>
            <div style="display:flex; gap:10px;">
                <!-- MODIFICACI√ìN: BOT√ìN ICS GOOGLE CALENDAR -->
                <button class="btn-export btn-ics" style="margin:0; font-size:0.9rem;" onclick="downloadICS()">
                    <span class="material-icons">event</span> Exportar Google Calendar
                </button>
                <button class="btn-export" style="margin:0; font-size:0.9rem;" onclick="exportSchedulePDF()">
                    <span class="material-icons">download</span> Descargar PDF
                </button>
            </div>
        </div>
        
        <div class="scheduler-container">
            <div class="scheduler-controls">
                <h3>Agregar Curso</h3>
                <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Solo cursos disponibles (requisitos OK).</p>
                <div class="form-group"><label class="form-label">Curso:</label><select id="sched-course" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">D√≠a:</label><select id="sched-day" class="form-select"><option value="1">Lunes</option><option value="2">Martes</option><option value="3">Mi√©rcoles</option><option value="4">Jueves</option><option value="5">Viernes</option><option value="6">S√°bado</option></select></div>
                <div class="form-group" style="display:flex; gap:10px;"><div style="flex:1"><label class="form-label">Inicio:</label><select id="sched-start" class="form-select"></select></div><div style="flex:1"><label class="form-label">Fin:</label><select id="sched-end" class="form-select"></select></div></div>
                <div style="margin-bottom:20px; padding:10px; background:rgba(0,0,0,0.05); border-radius:8px;"><strong>Cr√©ditos: </strong> <span id="sim-credits">0</span></div>
                <button class="btn-add" onclick="addToSchedule()">AGREGAR</button>
                <button onclick="clearSchedule()" style="width:100%; margin-top:10px; background:none; border:1px solid #ccc; padding:10px; border-radius:6px; cursor:pointer; color:var(--text-main);">Limpiar</button>
            </div>
            <div class="scheduler-grid-wrapper" id="schedule-export-area">
                <div class="time-grid" id="schedule-grid">
                    <div class="grid-header">Hora</div><div class="grid-header">Lun</div><div class="grid-header">Mar</div><div class="grid-header">Mi√©</div><div class="grid-header">Jue</div><div class="grid-header">Vie</div><div class="grid-header">S√°b</div>
                </div>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 6: RECURSOS -->
    <div id="page-recursos" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Recursos Institucionales</h2>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
            <a href="https://sum.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #8a0303; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">SUM</h3><p style="font-size:0.85rem; color:#666;">Sistema √önico de Matr√≠cula</p>
                </div>
            </a>
            <a href="https://sisbib.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #2980b9; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">Biblioteca</h3><p style="font-size:0.85rem; color:#666;">Repositorio y Tesis</p>
                </div>
            </a>
            <a href="https://administracion.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #27ae60; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">Facultad</h3><p style="font-size:0.85rem; color:#666;">Web FCA UNMSM</p>
                </div>
            </a>
        </div>
        <div style="margin-top:30px; background:rgba(255, 193, 7, 0.2); padding:20px; border-radius:8px; border:1px solid rgba(255, 193, 7, 0.5);">
            <h4 style="margin-top:0; color:#b7791f;"><span class="material-icons" style="vertical-align:middle">info</span> Tips para Matr√≠cula</h4>
            <ul style="margin-bottom:0; padding-left:20px; font-size:0.9rem; color:#b7791f;">
                <li>Para matr√≠cula regular necesitas un PPS aprobado (>11).</li>
                <li>Los cursos electivos requieren m√≠nimo 20 alumnos para abrirse.</li>
                <li>Valida tus pr√°cticas pre-profesionales a partir del 8vo ciclo.</li>
            </ul>
        </div>
    </div>

    <!-- P√ÅGINA 7: ESTRATEGIA & IA (NUEVO) -->
    <div id="page-estrategia" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">Planificaci√≥n Estrat√©gica & Asistente Virtual</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Detecta tus "Semanas del Infierno" y recibe asesor√≠a t√°ctica basada en tus datos.</p>

        <div class="strategy-layout">
            
            <!-- COLUMNA IZQUIERDA: MAPA DE CALOR -->
            <div class="heatmap-panel">
                <div class="panel-header">
                    <h3><span class="material-icons">local_fire_department</span> Mapa de Calor Acad√©mico</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="date" id="cycle-start-date" class="form-select" style="padding:5px; width:130px;" title="Inicio de Ciclo">
                        <button class="btn-export btn-ics" style="margin:0; padding:5px 10px; font-size:0.8rem;" onclick="downloadDeadlinesICS()">
                            <span class="material-icons">event</span> G. Calendar
                        </button>
                    </div>
                </div>

                <!-- Inputs para agregar eventos -->
                <div class="add-event-box">
                    <div style="display:grid; grid-template-columns: 80px 1fr 100px auto; gap:10px; align-items:center;">
                        <input type="number" id="evt-week" placeholder="Semana (1-16)" class="form-select" min="1" max="16">
                        <input type="text" id="evt-name" placeholder="Ej: Parcial Microeconom√≠a" class="form-select">
                        <select id="evt-type" class="form-select">
                            <option value="3">Examen (3pts)</option>
                            <option value="2">Trabajo (2pts)</option>
                            <option value="1">Tarea (1pt)</option>
                        </select>
                        <button class="btn-add" style="padding:10px;" onclick="addHellEvent()">+</button>
                    </div>
                </div>

                <!-- Grilla de Semanas -->
                <div id="hell-grid" class="hell-weeks-grid">
                    <!-- Se genera con JS -->
                </div>
                
                <div class="legend">
                    <span class="dot" style="background:#4caf50"></span> Relax
                    <span class="dot" style="background:#f1c40f"></span> Moderado
                    <span class="dot" style="background:#e67e22"></span> Pesado
                    <span class="dot" style="background:#c0392b"></span> INFIERNO
                </div>
            </div>

            <!-- COLUMNA DERECHA: IA CONTEXTUAL (VERSI√ìN AUTOM√ÅTICA) -->
            <div class="ai-panel">
                <div class="ai-header">
                    <span class="material-icons" style="font-size:2rem; color:#4dd0e1;">psychology</span>
                    <div style="flex:1;">
                        <div style="font-weight:bold; display:flex; align-items:center; gap:10px;">
                            San Marcos BOT
                        </div>
                    </div>
                    
                </div>
                
                <div id="chat-history" class="chat-area">
                    <div class="msg-ai">
                        Hola, colega. Soy tu asistente acad√©mico UNMSM.<br>
                        Puedo analizar tu <b>Mapa de Calor</b>, tus <b>Notas</b> y resolver dudas.
                    </div>
                </div>

                <!-- Indicador de pensando -->
                <div id="ai-loading" style="display:none; padding:10px; font-size:0.8rem; color:#aaa; font-style:italic;">
                    <span class="material-icons" style="font-size:1rem; vertical-align:middle; animation:spin 1s linear infinite;">sync</span> Consultando servidor IA...
                </div>
                
                <div class="chat-input-area">
                    <input type="text" id="user-msg" placeholder="Ej: Expl√≠came el WACC con un ejemplo peruano..." onkeypress="handleChatEnter(event)">
                    <button onclick="sendMessage()"><span class="material-icons">send</span></button>
                </div>
                
                <div class="quick-actions">
                    <button class="chip" onclick="askAI('finance')">üí∞ Concepto Financiero</button>
                    <button class="chip" onclick="askAI('risk')">‚ö†Ô∏è An√°lisis de Riesgo</button>
                    <button class="chip" onclick="askAI('email')">‚úâÔ∏è Redactar Correo</button>
                </div>
            </div>

        <!-- Modal para Configurar API Key -->
        <style>
            @keyframes spin { 100% { transform: rotate(360deg); } }
            /* Markdown b√°sico para respuestas IA */
            .msg-ai strong { color: #d35400; }
            .msg-ai ul { padding-left: 20px; margin: 5px 0; }
            .msg-ai code { background: #eee; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        </style>

        </div>
    </div>

    <style>
        /* ESTILOS ESPEC√çFICOS PARA LA NUEVA SECCI√ìN */
        .strategy-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; height: 750px; }
        
        /* Heatmap Styles */
        .heatmap-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--grid-line); padding-bottom: 10px; }
        .add-event-box { background: rgba(0,0,0,0.02); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        
        .hell-weeks-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; overflow-y: auto; padding-right: 5px; flex: 1; }
        .week-box { border: 1px solid var(--border); border-radius: 8px; padding: 10px; position: relative; min-height: 120px; transition: all 0.3s; display: flex; flex-direction: column; }
        .week-box:hover { transform: scale(1.02); z-index: 5; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .week-header { font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .week-score { font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; color: white; }
        
        .event-item { font-size: 0.75rem; margin-bottom: 3px; padding: 3px; border-radius: 3px; background: rgba(255,255,255,0.7); color: #333; display: flex; justify-content: space-between; }
        .event-item .del-evt { cursor: pointer; color: red; font-weight: bold; display: none; }
        .week-box:hover .del-evt { display: block; }

        /* Colores de Intensidad */
        .level-0 { background: #e8f5e9; border-color: #a5d6a7; } /* Low */
        .level-1 { background: #fff9c4; border-color: #fff59d; } /* Mid */
        .level-2 { background: #ffccbc; border-color: #ffab91; } /* High */
        .level-3 { background: #ffcdd2; border-color: #ef9a9a; animation: pulseRed 2s infinite; } /* HELL */
        .level-3 .week-header { color: #c62828; }

        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); } }

        .legend { display: flex; gap: 15px; margin-top: 10px; font-size: 0.8rem; justify-content: center; color: #666; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* AI Chat Styles */
        .ai-panel { background: #2c3e50; color: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .ai-header { padding: 20px; background: #1a252f; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #34495e; }
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: url('https://www.transparenttextures.com/patterns/cubes.png'); /* Pattern sutil */ }
        
        .msg-ai, .msg-user { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .msg-ai { background: white; color: #333; border-top-left-radius: 0; align-self: flex-start; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .msg-user { background: var(--accent); color: #000; border-top-right-radius: 0; align-self: flex-end; font-weight: 500; }
        
        .chat-input-area { padding: 15px; background: #1a252f; display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; padding: 12px; border-radius: 20px; border: none; font-family: inherit; }
        .chat-input-area button { background: var(--primary); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .chat-input-area button:hover { transform: scale(1.1); }

        .quick-actions { padding: 10px 15px; background: #1a252f; display: flex; gap: 8px; overflow-x: auto; padding-top: 0; }
        .chip { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ddd; padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; }
        .chip:hover { background: white; color: #333; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        @media (max-width: 900px) {
            .strategy-layout { grid-template-columns: 1fr; height: auto; }
            .heatmap-panel, .ai-panel { height: 600px; }
            .hell-weeks-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>

    <!-- ========================================== -->
    <!-- P√ÅGINA 8: KANBAN EMPLEABILIDAD (CHAMBA)    -->
    <!-- ========================================== -->
    <div id="page-kanban" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">Gestor de Postulaciones Laborales</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Organiza tu b√∫squeda de pr√°cticas pre y profesionales.</p>

        <!-- Formulario R√°pido -->
        <div style="background:var(--bg-card); padding:20px; border-radius:12px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; align-items:end; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <div style="flex:1; min-width:200px;">
                <label class="form-label">Empresa</label>
                <input type="text" id="job-company" class="form-select" placeholder="Ej: BCP, Alicorp...">
            </div>
            <div style="flex:1; min-width:200px;">
                <label class="form-label">Puesto</label>
                <input type="text" id="job-role" class="form-select" placeholder="Ej: Practicante de Finanzas">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">Plataforma</label>
                <select id="job-source" class="form-select">
                    <option>LinkedIn</option>
                    <option>Computrabajo</option>
                    <option>Bolsa UNMSM</option>
                    <option>Referido</option>
                </select>
            </div>
            <button class="btn-add" style="width:auto; min-width:120px;" onclick="addJob()">POSTULAR</button>
        </div>

        <!-- Tablero Kanban -->
        <div class="kanban-board">
            <!-- Columna 1 -->
            <div class="kanban-col">
                <div class="col-header header-todo">üìù Por Postular</div>
                <div id="col-todo" class="col-body"></div>
            </div>
            <!-- Columna 2 -->
            <div class="kanban-col">
                <div class="col-header header-process">‚è≥ En Proceso</div>
                <div id="col-process" class="col-body"></div>
            </div>
            <!-- Columna 3 -->
            <div class="kanban-col">
                <div class="col-header header-offer">üéâ Oferta / Ingreso</div>
                <div id="col-offer" class="col-body"></div>
            </div>
            <!-- Columna 4 -->
            <div class="kanban-col">
                <div class="col-header header-reject">‚ùå Rechazado</div>
                <div id="col-reject" class="col-body"></div>
            </div>
        </div>
    </div>

    <style>
        /* ESTILOS DEL KANBAN */
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; min-height: 500px; }
        .kanban-col { background: rgba(0,0,0,0.03); border-radius: 8px; display: flex; flex-direction: column; }
        .col-header { padding: 15px; font-weight: bold; color: white; border-radius: 8px 8px 0 0; text-align: center; }
        .col-body { padding: 10px; flex: 1; min-height: 100px; }
        
        .header-todo { background: #7f8c8d; }
        .header-process { background: #f39c12; }
        .header-offer { background: #27ae60; }
        .header-reject { background: #c0392b; }

        .job-card { background: var(--bg-card); padding: 15px; border-radius: 6px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #333; position: relative; animation: fadeIn 0.3s; transition: transform 0.2s; }
        .job-card:hover { transform: translateY(-2px); }
        .job-company { font-weight: bold; font-size: 1rem; }
        .job-role { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .job-source { font-size: 0.75rem; background: #eee; padding: 2px 6px; border-radius: 4px; display: inline-block; color: #555; }
        .btn-move-group { margin-top: 10px; display: flex; justify-content: space-between; gap: 5px; }
        .btn-move { border: none; background: none; cursor: pointer; color: var(--text-main); font-size: 1.1rem; padding: 2px; border-radius:4px; }
        .btn-move:hover { background: rgba(0,0,0,0.1); }
        .btn-delete-job { position: absolute; top: 10px; right: 10px; color: #999; cursor: pointer; border: none; background: none; font-weight:bold; }
        .btn-delete-job:hover { color: red; }
    </style>

    <!-- ========================================== -->
    <!-- P√ÅGINA 9: CONFIGURACI√ìN (MULTI-CARRERA)    -->
    <!-- ========================================== -->
    <div id="page-config" class="page-section">
        <div style="max-width:800px; margin:0 auto;">
            <h2 style="text-align:center;">Gesti√≥n de Carrera & Malla</h2>
            <p style="text-align:center; color:#666;">Cambia de carrera, crea tu propia malla o importa la de un amigo. <br><b>Nota:</b> Al cambiar de malla, tus notas se adaptar√°n o reiniciar√°n.</p>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-top:30px;">
                
                <!-- OPCI√ìN 1: CARGAR MALLA EXISTENTE -->
                <div class="stats-card">
                    <h3>üìÇ Cargar Malla Oficial</h3>
                    <p style="font-size:0.9rem; color:#666;">Carreras precargadas en el sistema.</p>
                    <select id="preset-career" class="form-select" style="margin-bottom:15px;">
                        <option value="admin">Administraci√≥n (FCA - 2023)</option>
                        <option value="conta">Contabilidad (Ejemplo)</option>
                        <option value="ing_ind">Ingenier√≠a Industrial (Ejemplo)</option>
                    </select>
                    <button class="btn-add" onclick="loadPresetMalla()">Cargar Carrera</button>
                </div>

                <!-- OPCI√ìN 2: IMPORTAR / EXPORTAR -->
                <div class="stats-card">
                    <h3>üîÑ Compartir Malla (JSON)</h3>
                    <p style="font-size:0.9rem; color:#666;">Copia tu malla para d√°rsela a un amigo o pega una aqu√≠.</p>
                    <textarea id="json-malla-area" style="width:100%; height:80px; border:1px solid #ccc; border-radius:6px; font-family:monospace; font-size:0.8rem; margin-bottom:10px; padding:5px;" placeholder='[{"id":"CURSO1", "name":"..."}]'></textarea>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-export" style="margin:0; flex:1;" onclick="importMallaJSON()">üì• Importar</button>
                        <button class="btn-export btn-ics" style="margin:0; flex:1;" onclick="exportMallaJSON()">üì§ Copiar Malla</button>
                    </div>
                </div>
            </div>

            <!-- VISUALIZADOR DE DATOS DE LA CUENTA -->
            <div style="margin-top:30px; padding:20px; background:#e3f2fd; border-radius:12px; border:1px solid #90caf9; color:#0d47a1;">
                <h3 style="margin-top:0;">‚òÅÔ∏è Sincronizaci√≥n en la Nube</h3>
                <p>Conectado como: <b id="user-email-display">...</b></p>
                <p style="font-size:0.9rem;">Tus datos (Notas, Malla, Empleabilidad) se guardan autom√°ticamente en Google Cloud. Puedes entrar desde tu celular y ver√°s lo mismo que en tu PC.</p>
            </div>
        </div>
    </div>


<script type="module">
    // =================================================================
    // 1. CONFIGURACI√ìN E IMPORTACIONES DE FIREBASE
    // =================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- TUS CLAVES REALES DE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDBq8ExQaOE1QLdVqedmesz1jxdwv2dR5Y",
        authDomain: "unmsm-administracion.firebaseapp.com",
        projectId: "unmsm-administracion",
        storageBucket: "unmsm-administracion.firebasestorage.app",
        messagingSenderId: "885762425594",
        appId: "1:885762425594:web:a514af6db93fef4be6bf43",
        measurementId: "G-16KXE5N8ZD"
    };

    // --- LISTA BLANCA DE ACCESO ---
    const ALLOWED_EMAILS = [
        "andersonpedroescobar292@gmail.com",
        "20231490@lamolina.edu.pe"
    ];

    // INICIALIZAR SERVICIOS
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null; // Guardar√° al usuario logueado

    // =================================================================
    // 2. DATOS POR DEFECTO (MALLA ADMINISTRACI√ìN 2023)
    // =================================================================
    // Esta lista se usa si el usuario es nuevo o resetea su carrera
    const DEFAULT_ADMIN_COURSES = [
        {id:'EGO1O1', name:'Lenguaje', cr:4, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O2', name:'M√©todos de Estudio Universitario', cr:3, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O3', name:'Historia del Per√∫', cr:3, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O4', name:'Matem√°tica I', cr:4, c:1, t:'O', req:[], tags:['fin']},
        {id:'EGO1O5', name:'Desarrollo Personal', cr:3, c:1, t:'O', req:[], tags:['rrhh']},
        {id:'EGO1O6', name:'Ingl√©s I', cr:2, c:1, t:'O', req:[], tags:[]},
        {id:'EGO2O1', name:'Investigaci√≥n Acad√©mica', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O2', name:'Filosof√≠a y √âtica', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O3', name:'Realidad Nacional y Mundial', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O4', name:'Matem√°tica II', cr:4, c:2, t:'O', req:['EGO1O4'], tags:['fin']},
        {id:'EGO2O5', name:'Derechos Fundamentales', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O6', name:'Ingl√©s II', cr:2, c:2, t:'O', req:['EGO1O6'], tags:[]},
        {id:'ADO23301', name:'Estad√≠stica Descriptiva', cr:4, c:3, t:'O', req:[], tags:['mkt']},
        {id:'ADO23302', name:'Microeconom√≠a', cr:3, c:3, t:'O', req:[], tags:['fin']},
        {id:'ADO23303', name:'Visi√≥n para el Desarrollo', cr:3, c:3, t:'O', req:['EGO2O1'], tags:[]},
        {id:'ADO23304', name:'Fundamentos de Administraci√≥n', cr:4, c:3, t:'O', req:[], tags:['op']},
        {id:'ADO23305', name:'TICs para la Gesti√≥n', cr:3, c:3, t:'O', req:[], tags:['op']},
        {id:'ADO23306', name:'Fundamentos de Contabilidad', cr:3, c:3, t:'O', req:[], tags:['fin']},
        {id:'ADO23307', name:'Desarrollo Sostenible', cr:2, c:3, t:'O', req:[], tags:[]},
        {id:'ADO23401', name:'Estad√≠stica Inferencial', cr:4, c:4, t:'O', req:['ADO23301'], tags:['mkt']},
        {id:'ADO23402', name:'Macroeconom√≠a', cr:3, c:4, t:'O', req:['ADO23302'], tags:['fin']},
        {id:'ADO23403', name:'Derecho Empresarial', cr:3, c:4, t:'O', req:[], tags:['op']},
        {id:'ADO23404', name:'Investigaci√≥n Cient√≠fica', cr:3, c:4, t:'O', req:['ADO23303'], tags:[]},
        {id:'ADO23405', name:'Procesos Administrativos', cr:4, c:4, t:'O', req:['ADO23304'], tags:['op']},
        {id:'ADO23406', name:'Costos y Presupuestos', cr:3, c:4, t:'O', req:['ADO23306'], tags:['fin']},
        {id:'ADO23407', name:'Matem√°tica Financiera', cr:4, c:4, t:'O', req:[], tags:['fin']},
        {id:'ADO23501', name:'Derecho Laboral', cr:2, c:5, t:'O', req:['ADO23403'], tags:['rrhh']},
        {id:'ADO23502', name:'Administraci√≥n de la Calidad', cr:3, c:5, t:'O', req:['ADO23405'], tags:['op']},
        {id:'ADO23503', name:'Fundamentos del Talento Humano', cr:3, c:5, t:'O', req:[], tags:['rrhh']},
        {id:'ADO23504', name:'Finanzas Corporativas I', cr:3, c:5, t:'O', req:['ADO23407'], tags:['fin']},
        {id:'ADO23505', name:'Herramientas Desarrollo Proyectos', cr:3, c:5, t:'O', req:[], tags:['op']},
        {id:'ADO23506', name:'Fundamentos de Marketing', cr:3, c:5, t:'O', req:[], tags:['mkt']},
        {id:'ADO23507', name:'Cadenas de Suministros', cr:3, c:5, t:'O', req:[], tags:['op']},
        {id:'ADO23508', name:'Emprendimiento e Innovaci√≥n', cr:3, c:5, t:'O', req:[], tags:['op']},
        {id:'ADE23601', name:'Reclutamiento y Selecci√≥n', cr:3, c:6, t:'E', req:['ADO23503'], tags:['rrhh']},
        {id:'ADE23602', name:'Seguridad y Salud en el Trabajo', cr:3, c:6, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23603', name:'Finanzas Corporativas II', cr:3, c:6, t:'E', req:['ADO23504'], tags:['fin']},
        {id:'ADE23604', name:'Form. y Eval. Proyectos Inversi√≥n', cr:3, c:6, t:'E', req:['ADO23505'], tags:['fin', 'op']},
        {id:'ADE23605', name:'Marketing Digital', cr:3, c:6, t:'E', req:['ADO23506'], tags:['mkt']},
        {id:'ADE23606', name:'Comportamiento del Consumidor', cr:3, c:6, t:'E', req:[], tags:['mkt']},
        {id:'ADE23607', name:'Planeaci√≥n Demanda/Pron√≥sticos', cr:3, c:6, t:'E', req:['ADO23507'], tags:['op']},
        {id:'ADE23608', name:'Inv. Desarrollo e Innovaci√≥n', cr:3, c:6, t:'E', req:[], tags:['op']},
        {id:'ADO23601', name:'M√©todos Cuantitativos', cr:3, c:6, t:'O', req:['ADO23401'], tags:['op']},
        {id:'ADO23602', name:'Investigaci√≥n de Mercados', cr:3, c:6, t:'O', req:[], tags:['mkt']},
        {id:'ADO23603', name:'Derecho Tributario', cr:2, c:6, t:'O', req:['ADO23501'], tags:['fin']},
        {id:'ADO23604', name:'T√©cnicas de Inv. Cualitativa', cr:3, c:6, t:'O', req:['ADO23404'], tags:['mkt', 'rrhh']},
        {id:'ADO23605', name:'Reestructuraci√≥n Empresarial', cr:3, c:6, t:'O', req:['ADO23502'], tags:['op']},
        {id:'ADE23701', name:'Capacitaci√≥n y Desarrollo Talento', cr:3, c:7, t:'E', req:['ADE23601'], tags:['rrhh']},
        {id:'ADE237010', name:'Aprovisionamiento y Negociaci√≥n', cr:3, c:7, t:'E', req:[], tags:['op']},
        {id:'ADE23702', name:'Gesti√≥n Clima y Cultura Org.', cr:3, c:7, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23703', name:'Mercado de Capitales', cr:3, c:7, t:'E', req:['ADE23603'], tags:['fin']},
        {id:'ADE23704', name:'Derivados Financieros', cr:3, c:7, t:'E', req:[], tags:['fin']},
        {id:'ADE23705', name:'Form. Eval. Proyectos Sociales I', cr:3, c:7, t:'E', req:['ADE23604'], tags:['op']},
        {id:'ADE23706', name:'Gesti√≥n de Riesgos Proyectos', cr:3, c:7, t:'E', req:[], tags:['op']},
        {id:'ADE23707', name:'Marketing de Servicios', cr:3, c:7, t:'E', req:['ADE23605'], tags:['mkt']},
        {id:'ADE23708', name:'Programaci√≥n Neuroling√º√≠stica', cr:3, c:7, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23709', name:'Operaciones I', cr:3, c:7, t:'E', req:['ADE23607'], tags:['op']},
        {id:'ADO23701', name:'Negocios Internacionales', cr:4, c:7, t:'O', req:[], tags:['op', 'fin']},
        {id:'ADO23702', name:'T√©cnicas de Inv. Cuantitativa', cr:3, c:7, t:'O', req:['ADO23604'], tags:['mkt']},
        {id:'ADO23703', name:'Prospectiva Empresarial', cr:3, c:7, t:'O', req:['ADO23605'], tags:['op']},
        {id:'ADE23801', name:'Evaluaci√≥n del Desempe√±o', cr:3, c:8, t:'E', req:['ADE23701'], tags:['rrhh']},
        {id:'ADE238010', name:'Gesti√≥n Almacenes e Inventarios', cr:3, c:8, t:'E', req:[], tags:['op']},
        {id:'ADE23802', name:'Inteligencia Emocional y Social', cr:3, c:8, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23803', name:'Finanzas Internacionales', cr:3, c:8, t:'E', req:['ADE23703'], tags:['fin']},
        {id:'ADE23804', name:'Econometr√≠a Financiera', cr:3, c:8, t:'E', req:[], tags:['fin']},
        {id:'ADE23805', name:'Form. Eval. Proyectos Sociales II', cr:3, c:8, t:'E', req:['ADE23705'], tags:['op']},
        {id:'ADE23806', name:'Gesti√≥n Proyectos P√∫b/Priv', cr:3, c:8, t:'E', req:[], tags:['op']},
        {id:'ADE23807', name:'Marketing Internacional', cr:3, c:8, t:'E', req:['ADE23707'], tags:['mkt']},
        {id:'ADE23808', name:'Publicidad y Branding', cr:3, c:8, t:'E', req:[], tags:['mkt']},
        {id:'ADE23809', name:'Operaciones II', cr:3, c:8, t:'E', req:['ADE23709'], tags:['op']},
        {id:'ADO23801', name:'Integraci√≥n Econ√≥mica', cr:3, c:8, t:'O', req:['ADO23701'], tags:['op']},
        {id:'ADO23802', name:'Proyecto de Investigaci√≥n', cr:3, c:8, t:'O', req:['ADO23702'], tags:['op']},
        {id:'ADO23803', name:'Planeamiento Estrat√©gico', cr:3, c:8, t:'O', req:['ADO23703'], tags:['op']},
        {id:'ADO23804', name:'Gesti√≥n P√∫blica', cr:3, c:8, t:'O', req:[], tags:['op']},
        {id:'ADE23901', name:'Valoraci√≥n Puestos/Compensaciones', cr:3, c:9, t:'E', req:['ADE23801'], tags:['rrhh']},
        {id:'ADE23902', name:'Gesti√≥n Talento Sector P√∫blico', cr:3, c:9, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23903', name:'Gesti√≥n Riesgos Financieros', cr:3, c:9, t:'E', req:['ADE23803'], tags:['fin']},
        {id:'ADE23904', name:'Finanzas P√∫blicas', cr:3, c:9, t:'E', req:[], tags:['fin']},
        {id:'ADE23905', name:'Gerencia de Proyectos', cr:3, c:9, t:'E', req:['ADE23905'], tags:['op']},
        {id:'ADE23906', name:'Gerencia de Ventas', cr:3, c:9, t:'E', req:['ADE23807'], tags:['mkt']},
        {id:'ADE23907', name:'Negociaci√≥n Comercial', cr:3, c:9, t:'E', req:[], tags:['mkt']},
        {id:'ADE23908', name:'Log√≠stica Sector P√∫blico', cr:3, c:9, t:'E', req:['ADE23809'], tags:['op']},
        {id:'ADE23909', name:'Distribuci√≥n y Transporte', cr:3, c:9, t:'E', req:[], tags:['op']},
        {id:'ADO23901', name:'Desarrollo de Investigaci√≥n I', cr:3, c:9, t:'O', req:['ADO23802'], tags:[]},
        {id:'ADO23902', name:'Direcci√≥n Estrat√©gica', cr:3, c:9, t:'O', req:['ADO23803'], tags:['op']},
        {id:'ADO23903', name:'Des. y Lanzamiento Nuevos Prod.', cr:3, c:9, t:'O', req:[], tags:['mkt']},
        {id:'ADO23904', name:'Cadena de Valor', cr:3, c:9, t:'O', req:[], tags:['op']},
        {id:'ADE23101', name:'Gerencia Estrat√©gica Talento', cr:3, c:10, t:'E', req:['ADE23901'], tags:['rrhh']},
        {id:'ADE23102', name:'Auditor√≠a Gesti√≥n Talento', cr:3, c:10, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23103', name:'Direcci√≥n Financiera', cr:3, c:10, t:'E', req:['ADE23903'], tags:['fin']},
        {id:'ADE23104', name:'Taller de Proyectos', cr:3, c:10, t:'E', req:['ADE23905'], tags:['op']},
        {id:'ADE23105', name:'Gerencia de Marketing', cr:3, c:10, t:'E', req:['ADE23906'], tags:['mkt']},
        {id:'ADE23106', name:'Neuromarketing', cr:3, c:10, t:'E', req:[], tags:['mkt']},
        {id:'ADE23107', name:'Gerencia Log√≠stica', cr:3, c:10, t:'E', req:['ADE23908'], tags:['op']},
        {id:'ADE23108', name:'Log√≠stica Internacional', cr:3, c:10, t:'E', req:[], tags:['op']},
        {id:'ADO23101', name:'Desarrollo de Investigaci√≥n II', cr:3, c:10, t:'O', req:['ADO23901'], tags:[]},
        {id:'ADO23102', name:'Gerencia General y Alta Dir.', cr:3, c:10, t:'O', req:['ADO23902'], tags:['op']},
        {id:'ADO23103', name:'Gesti√≥n de PYMES', cr:3, c:10, t:'O', req:[], tags:['op']}
    ];

    // Variables de Estado (Ahora se cargan desde Firebase)
    let courses = []; 
    let approved = new Set();
    let approvedGrades = {}; 
    let acquiredSkills = new Set();
    let mySchedule = []; 
    let deadlineEvents = [];
    let jobApplications = []; // Nuevo para Kanban

    // =================================================================
    // 3. LOGICA DE AUTENTICACI√ìN Y BASE DE DATOS
    // =================================================================

    const loginBtn = document.getElementById('google-login-btn');
    if(loginBtn) {
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(err => {
                console.error(err);
                alert("Error al iniciar sesi√≥n: " + err.message);
            });
        });
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Verificar lista blanca (en min√∫sculas)
            if (ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
                currentUser = user;
                // Ocultar login
                document.getElementById('login-overlay').style.display = 'none';
                if(document.getElementById('user-email-display')) {
                    document.getElementById('user-email-display').innerText = user.email;
                }
                
                // Cargar datos de la nube
                await loadCloudData();
                initApp();
            } else {
                alert("Acceso denegado. Tu correo no est√° autorizado.");
                signOut(auth);
            }
        } else {
            // Mostrar login
            document.getElementById('login-overlay').style.display = 'flex';
        }
    });

    window.logout = () => {
        if(confirm("¬øCerrar sesi√≥n?")) {
            signOut(auth).then(() => location.reload());
        }
    };

    // --- GUARDAR EN FIRESTORE ---
    async function saveCloudData() {
        if(!currentUser) return;
        
        const userRef = doc(db, "users", currentUser.email);
        
        // Preparamos el objeto a guardar
        const dataToSave = {
            // Guardamos la malla completa por si el usuario la personaliz√≥
            courses: JSON.stringify(courses),
            
            // Guardamos el progreso
            approved: JSON.stringify([...approved]),
            grades: JSON.stringify(approvedGrades),
            skills: JSON.stringify([...acquiredSkills]),
            
            // Guardamos herramientas
            schedule: JSON.stringify(mySchedule),
            deadlines: JSON.stringify(deadlineEvents),
            jobs: JSON.stringify(jobApplications) // Kanban
        };
        
        try {
            await setDoc(userRef, dataToSave, { merge: true });
            console.log("Sincronizado con la nube ‚òÅÔ∏è");
        } catch (e) {
            console.error("Error guardando:", e);
        }
    }

    // --- CARGAR DE FIRESTORE ---
    async function loadCloudData() {
        try {
            const userRef = doc(db, "users", currentUser.email);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // 1. Cargar Malla
                if(data.courses) courses = JSON.parse(data.courses);
                else courses = JSON.parse(JSON.stringify(DEFAULT_ADMIN_COURSES));

                // 2. Cargar Datos
                if(data.approved) approved = new Set(JSON.parse(data.approved));
                if(data.grades) approvedGrades = JSON.parse(data.grades);
                if(data.skills) acquiredSkills = new Set(JSON.parse(data.skills));
                if(data.schedule) mySchedule = JSON.parse(data.schedule);
                if(data.deadlines) deadlineEvents = JSON.parse(data.deadlines);
                if(data.jobs) jobApplications = JSON.parse(data.jobs);

            } else {
                // USUARIO NUEVO: Cargar defaults y crear registro
                courses = JSON.parse(JSON.stringify(DEFAULT_ADMIN_COURSES));
                approved = new Set();
                approvedGrades = {};
                // Guardamos inicial
                await saveCloudData();
            }
        } catch (e) {
            console.error("Error cargando datos:", e);
            alert("Error de conexi√≥n con la base de datos.");
        }
    }

    // =================================================================
    // 4. FUNCIONES DE GESTI√ìN (MALLAS, KANBAN, ETC)
    // =================================================================

    function initApp() {
        renderMalla();
        renderSkills();
        renderHellGrid();
        renderKanban();
        initSchedule(); // Inicializar dropdowns del simulador
        initCalculator();
        updateStats();
    }

    // --- IMPORTAR / EXPORTAR MALLAS ---
    window.exportMallaJSON = () => {
        const json = JSON.stringify(courses, null, 2);
        document.getElementById('json-malla-area').value = json;
        navigator.clipboard.writeText(json);
        alert("JSON copiado. P√°saselo a un amigo.");
    };

    window.importMallaJSON = () => {
        try {
            const json = document.getElementById('json-malla-area').value;
            const newCourses = JSON.parse(json);
            if(!Array.isArray(newCourses) || !newCourses[0].id) throw new Error("Formato inv√°lido");

            if(confirm("‚ö†Ô∏è Importar una nueva malla borrar√° tu progreso actual (notas). ¬øSeguro?")) {
                courses = newCourses;
                approved = new Set();
                approvedGrades = {};
                saveCloudData();
                location.reload();
            }
        } catch (e) {
            alert("JSON inv√°lido.");
        }
    };

    window.loadPresetMalla = () => {
        const val = document.getElementById('preset-career').value;
        if(val === 'admin') {
            if(confirm("¬øReiniciar a Administraci√≥n? Se borrar√° el progreso.")) {
                courses = JSON.parse(JSON.stringify(DEFAULT_ADMIN_COURSES));
                approved = new Set();
                approvedGrades = {};
                saveCloudData();
                location.reload();
            }
        } else {
            alert("Pr√≥ximamente m√°s carreras oficiales. Por ahora usa 'Importar JSON'.");
        }
    };

    // --- KANBAN ---
    window.addJob = () => {
        const co = document.getElementById('job-company').value;
        const ro = document.getElementById('job-role').value;
        const src = document.getElementById('job-source').value;
        if(!co || !ro) return alert("Faltan datos");

        jobApplications.push({
            id: Date.now(),
            company: co, role: ro, source: src,
            status: 'todo',
            date: new Date().toLocaleDateString()
        });
        saveCloudData();
        renderKanban();
        // Limpiar
        document.getElementById('job-company').value = '';
        document.getElementById('job-role').value = '';
    };

    window.moveJob = (id, newStatus) => {
        const job = jobApplications.find(j => j.id === id);
        if(job) {
            job.status = newStatus;
            saveCloudData();
            renderKanban();
            if(newStatus === 'offer') alert("¬°FELICIDADES! üéâ");
        }
    };

    window.deleteJob = (id) => {
        if(confirm("¬øEliminar?")) {
            jobApplications = jobApplications.filter(j => j.id !== id);
            saveCloudData();
            renderKanban();
        }
    };

    function renderKanban() {
        ['todo', 'process', 'offer', 'reject'].forEach(s => {
            const col = document.getElementById('col-'+s);
            if(col) col.innerHTML = '';
        });

        jobApplications.forEach(job => {
            const col = document.getElementById('col-' + job.status);
            if(!col) return;

            const card = document.createElement('div');
            card.className = 'job-card';
            
            let actions = '';
            if(job.status === 'todo') actions = `<button class="btn-move" onclick="moveJob(${job.id}, 'process')">‚û°Ô∏è</button>`;
            if(job.status === 'process') actions = `<button class="btn-move" onclick="moveJob(${job.id}, 'todo')">‚¨ÖÔ∏è</button> <button class="btn-move" onclick="moveJob(${job.id}, 'offer')">‚úÖ</button> <button class="btn-move" onclick="moveJob(${job.id}, 'reject')">‚ùå</button>`;
            if(job.status === 'offer') actions = `<button class="btn-move" onclick="moveJob(${job.id}, 'process')">‚¨ÖÔ∏è</button>`;
            if(job.status === 'reject') actions = `<button class="btn-move" onclick="moveJob(${job.id}, 'todo')">üîÑ</button>`;

            card.innerHTML = `
                <button class="btn-delete-job" onclick="deleteJob(${job.id})">√ó</button>
                <div class="job-company">${job.company}</div>
                <div class="job-role">${job.role}</div>
                <div class="job-source">${job.source}</div>
                <div style="font-size:0.7rem; color:#aaa;">${job.date}</div>
                <div class="btn-move-group">${actions}</div>
            `;
            col.appendChild(card);
        });
    }

    // --- SKILLS DIN√ÅMICOS ---
    function renderSkills() {
        const grid = document.getElementById('tools-grid');
        const profileDash = document.querySelector('.profile-dashboard');
        if(!profileDash) return;

        // Limpiar y regenerar barras basadas en TAGS de la malla actual
        profileDash.innerHTML = '';
        const areasMap = {}; 
        const tagNames = {
            'fin': 'Finanzas', 'mkt': 'Marketing', 'rrhh': 'RRHH', 'op': 'Operaciones', 
            'ti': 'Sistemas', 'inv': 'Investigaci√≥n', 'leg': 'Legal', 'econ': 'Econom√≠a'
        };

        courses.forEach(c => {
            if(c.tags) c.tags.forEach(tag => {
                if(!areasMap[tag]) areasMap[tag] = { name: tagNames[tag] || tag.toUpperCase(), total: 0, app: 0 };
                areasMap[tag].total += c.cr;
                if(approved.has(c.id)) areasMap[tag].app += c.cr;
            });
        });

        const colors = ['#27ae60', '#e67e22', '#8e44ad', '#2980b9', '#c0392b', '#16a085'];
        let colorIdx = 0;

        Object.keys(areasMap).forEach(key => {
            const area = areasMap[key];
            const pct = area.total > 0 ? Math.round((area.app / area.total) * 100) : 0;
            const color = colors[colorIdx % colors.length];
            colorIdx++;

            const card = document.createElement('div');
            card.className = 'profile-card';
            card.innerHTML = `
                <div class="profile-title" style="color:${color}">${area.name}</div>
                <div class="profile-percent">${pct}%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" style="background:${color}; width:${pct}%"></div></div>
            `;
            profileDash.appendChild(card);
        });

        // Tools (Manuales por ahora, o podr√≠as guardarlas en DB tambi√©n)
        // Por simplicidad, renderizamos una lista est√°tica b√°sica si quieres
        if(grid) grid.innerHTML = ''; 
        // (Aqu√≠ podr√≠as restaurar tu lista skillsDB original si deseas que sea fija)
    }

    // --- MALLA ---
    window.renderMalla = function() {
        const grid = document.getElementById('malla-grid');
        if(!grid) return;
        grid.innerHTML = '';
        
        const maxCiclo = courses.length > 0 ? Math.max(...courses.map(c => c.c)) : 10;

        for(let i=1; i<=maxCiclo; i++) {
            const col = document.createElement('div');
            col.className = 'cycle-col';
            col.innerHTML = `<div class="cycle-title">Ciclo ${i}</div>`;
            
            courses.filter(c => c.c === i).forEach(c => {
                const card = document.createElement('div');
                card.className = `course-card type-${c.t}`;
                card.id = c.id;
                
                const passed = approved.has(c.id);
                // Verificar requisitos din√°micamente
                const reqMet = c.req ? c.req.every(r => approved.has(r)) : true;

                if(passed) card.classList.add('completed');
                else if(!reqMet) { card.classList.add('locked'); card.title = "Falta requisito"; }

                let gradeHtml = (passed && approvedGrades[c.id]) ? `<div class="grade-badge">${approvedGrades[c.id]}</div>` : '';

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666">
                        <strong>${c.id}</strong> <span>${c.cr} Cr.</span>
                    </div>
                    <b>${c.name}</b>
                    <div style="font-size:0.75rem; color:#999; margin-top:5px; text-align:right">${c.t==='O'?'Oblig.':'Elect.'}</div>
                    ${gradeHtml}
                `;
                card.onclick = () => toggleCourse(c, reqMet);
                col.appendChild(card);
            });
            grid.appendChild(col);
        }
    };

    window.toggleCourse = function(c, reqMet) {
        if(approved.has(c.id)) {
            const dep = courses.find(x => x.req && x.req.includes(c.id) && approved.has(x.id));
            if(dep) return alert(`Bloquea a: ${dep.name}`);
            approved.delete(c.id);
            delete approvedGrades[c.id];
        } else {
            if(!reqMet) return;
            let grade = prompt("Nota final (Opcional):", "14");
            if(grade !== null) {
                approved.add(c.id);
                if(grade && !isNaN(grade)) approvedGrades[c.id] = parseInt(grade);
            } else return;
        }
        updateStats();
        renderMalla();
        renderSkills();
        saveCloudData(); // Guardar cambios
    };

    window.updateStats = function() {
        let cr = 0, sum = 0, count = 0;
        courses.forEach(c => {
            if(approved.has(c.id)) {
                cr += c.cr;
                if(approvedGrades[c.id]) { sum += approvedGrades[c.id]*c.cr; count += c.cr; }
            }
        });
        const pps = count > 0 ? (sum/count).toFixed(2) : "0.00";
        
        if(document.getElementById('credits-display')) {
            document.getElementById('credits-display').innerText = cr;
            document.getElementById('pps-display').innerText = pps;
            document.getElementById('pps-dashboard').innerText = pps;
        }
    };

    window.resetMalla = function() {
        if(confirm("¬øBorrar todo el progreso de esta carrera?")) {
            approved = new Set();
            approvedGrades = {};
            saveCloudData();
            location.reload();
        }
    };

    // --- IA ADAPTATIVA ---
    window.sendMessage = async function() {
        const input = document.getElementById('user-msg');
        const text = input.value.trim();
        if(!text) return;

        addAIMessage(text, 'user');
        input.value = '';
        
        const loader = document.getElementById('ai-loading');
        if(loader) loader.style.display = 'block';

        // Contexto Din√°mico
        let mallaResumen = "";
        const maxCiclo = courses.length > 0 ? Math.max(...courses.map(c => c.c)) : 10;
        for(let i=1; i<=maxCiclo; i++) {
            const list = courses.filter(c => c.c === i).map(c => c.name).join(', ');
            if(list) mallaResumen += `[Ciclo ${i}]: ${list}\n`;
        }

        const ctx = {
            pps: document.getElementById('pps-dashboard').innerText,
            cr: document.getElementById('credits-display').innerText
        };

        const systemPrompt = `
            Act√∫a como un Asesor Acad√©mico Universitario.
            MALLA ACTUAL DEL ALUMNO (Cursos por ciclo):
            ${mallaResumen}
            
            ESTADO ALUMNO: PPS: ${ctx.pps}, Cr√©ditos: ${ctx.cr}.
            PREGUNTA: "${text}"
            
            INSTRUCCIONES:
            - Responde usando SOLO la informaci√≥n de la malla de arriba.
            - Si preguntan "qu√© llevo en ciclo X", lee la lista.
            - Usa HTML (<b>, <br>) para formato.
        `;

        try {
            const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(systemPrompt)}?model=openai`);
            let raw = await response.text();
            addAIMessage(raw.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>'), 'ai');
        } catch(e) {
            addAIMessage("Error de conexi√≥n IA.", 'ai');
        }
        if(loader) loader.style.display = 'none';
    };

    function addAIMessage(html, type) {
        const chat = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = type === 'user' ? 'msg-user' : 'msg-ai';
        div.innerHTML = html;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    // --- MAPA DE CALOR (STRATEGY) ---
    window.renderHellGrid = function() {
        const grid = document.getElementById('hell-grid');
        if(!grid) return;
        grid.innerHTML = '';

        for(let w=1; w<=16; w++) {
            const events = deadlineEvents.filter(e => e.week === w);
            const load = events.reduce((acc, e) => acc + e.type, 0);
            let cls = 'level-0';
            if(load >= 2) cls = 'level-1';
            if(load >= 5) cls = 'level-2';
            if(load >= 8) cls = 'level-3';

            let items = events.map((evt, idx) => `
                <div class="event-item">
                    <span>${evt.type===3?'‚ö°':evt.type===2?'üìù':'üìå'} ${evt.name}</span>
                    <span class="del-evt" onclick="removeHellEvent(${idx})">√ó</span>
                </div>
            `).join('');

            const box = document.createElement('div');
            box.className = `week-box ${cls}`;
            box.innerHTML = `
                <div class="week-header"><span>Semana ${w}</span><span class="week-score">${load} pts</span></div>
                <div style="flex:1; overflow-y:auto; padding-right:2px;" class="custom-scroll">${items}</div>
            `;
            grid.appendChild(box);
        }
    };

    window.addHellEvent = function() {
        const w = parseInt(document.getElementById('evt-week').value);
        const n = document.getElementById('evt-name').value;
        const t = parseInt(document.getElementById('evt-type').value);
        if(!w || !n) return alert("Datos inv√°lidos");
        
        deadlineEvents.push({week:w, name:n, type:t});
        deadlineEvents.sort((a,b) => a.week - b.week);
        saveCloudData();
        renderHellGrid();
    };

    window.removeHellEvent = function(i) {
        deadlineEvents.splice(i, 1);
        saveCloudData();
        renderHellGrid();
    };

    // --- EXPORTAR FUNCIONES AL HTML ---
    window.showPage = showPage;
    window.toggleTheme = toggleTheme;
    // ... mapea el resto si es necesario ...
    // Para simplificar, como usamos window.function = ..., ya son p√∫blicas arriba.

    // --- FUNCIONES LEGACY (SIMULADOR, CALCULADORA) ---
    // (P√©galas aqu√≠ si faltan, como addGradeRow, etc. asegurando que sean window.algo)
    
    window.addGradeRow = function() {
        const container = document.getElementById('grades-container');
        const row = document.createElement('div'); row.className = 'grade-row';
        row.innerHTML = `<input type="number" class="grade-input" placeholder="Nota"><input type="number" class="weight-input" placeholder="%"><button onclick="this.parentElement.remove()">√ó</button>`;
        container.appendChild(row);
    };
    
    window.calculateGrades = function() { /* ... tu l√≥gica antigua ... */ };
    window.initCalculator = function() { /* ... */ };
    
    // --- EXPORTAR PDF / ICS (Simplificado) ---
    window.exportPDF = function() {
        const el = document.getElementById('export-content');
        html2pdf().from(el).save();
    };
    window.downloadICS = function() { alert("Funci√≥n disponible (Reimplementar l√≥gica de schedule)"); }; 
    // Nota: Copia tu l√≥gica de downloadICS antigua aqu√≠ adentro si la quieres.

</script>
</body>
</html>