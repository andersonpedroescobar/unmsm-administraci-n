<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Acad√©mico Administraci√≥n - UNMSM PRO</title>
    <!-- Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* Colores UNMSM Light */
            --primary: #8a0303; 
            --accent: #f1c40f; 
            --bg-body: #f4f6f8; 
            --bg-card: #ffffff; 
            --text-main: #2c3e50; 
            --border: #e0e0e0;
            --grid-line: #eee;
            
            /* Colores Ramas */
            --c-fin: #27ae60; --c-mkt: #e67e22; --c-rrhh: #8e44ad; --c-op: #2980b9;
        }

        body.dark-mode {
            /* Colores Dark */
            --primary: #c0392b; 
            --accent: #f39c12; 
            --bg-body: #1a1a2e; 
            --bg-card: #16213e; 
            --text-main: #e0e0e0; 
            --border: #333;
            --grid-line: #2c3e50;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 60px; transition: background 0.3s, color 0.3s; }
        * { box-sizing: border-box; transition: all 0.2s ease; outline: none; }

        /* --- NAV --- */
        .navbar {
            background: var(--primary); color: white; height: 70px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-bottom: 4px solid var(--accent);
        }
        /* Modificaci√≥n: Ajuste para logo e imagen */
        .nav-brand { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .nav-logo-img { height: 50px; width: auto; background: white; border-radius: 50%; padding: 2px; }

        .nav-menu { display: flex; gap: 10px; align-items: center; }
        .nav-btn { 
            background: rgba(255,255,255,0.1); border: none; color: white; 
            padding: 8px 15px; cursor: pointer; border-radius: 20px; 
            display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 0.9rem;
        }
        .nav-btn:hover, .nav-btn.active { background: white; color: var(--primary); }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; margin-left: 10px; }

        /* --- LAYOUT --- */
        .page-section { display: none; padding: 25px; max-width: 1800px; margin: 0 auto; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MALLA STYLES --- */
        .malla-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg-card); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid var(--primary); }
        .malla-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 30px; align-items: flex-start; }
        .cycle-col { min-width: 250px; max-width: 250px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
        .cycle-title { text-align: center; background: #333; color: white; padding: 8px; border-radius: 4px; font-weight: bold; border-bottom: 3px solid var(--accent); }
        
        .course-card { background: var(--bg-card); border: 1px solid var(--border); border-left: 5px solid #999; padding: 10px; border-radius: 6px; cursor: pointer; min-height: 85px; font-size: 0.85rem; position: relative; }
        .course-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .course-card.completed { background: #e8f5e9; border-color: var(--primary); border-left-color: var(--primary); }
        .course-card.locked { opacity: 0.6; background: #f5f5f5; cursor: not-allowed; filter: grayscale(1); }
        .course-card.completed::after { content: '‚úî'; position: absolute; top: 5px; right: 5px; color: var(--primary); font-weight: bold; }
        
        body.dark-mode .course-card.completed { background: #1b4d3e; color: #fff; }
        body.dark-mode .course-card.locked { background: #222; opacity: 0.4; }

        .type-O { border-left-color: var(--primary); } 
        .type-E { border-left-color: var(--accent); }
        
        .grade-badge { position: absolute; bottom: 5px; right: 5px; background: #333; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }

        /* --- DASHBOARD PROGRESO --- */
        .dashboard-container { display: grid; grid-template-columns: 1fr 350px; gap: 25px; margin-bottom: 30px; }
        .chart-card { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
        .stats-card { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .stat-row { margin-bottom: 20px; }
        .stat-label { display: flex; justify-content: space-between; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: #777; }
        .stat-bar-bg { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; }
        .stat-bar-fill { height: 100%; transition: width 1s ease; border-radius: 6px; }
        
        .projection-box { margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 5px solid #2196f3; border-radius: 4px; color: #333; }
        .projection-title { font-weight: bold; color: #1565c0; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        body.dark-mode .projection-box { background: #1a2639; color: #eee; }
        
        .btn-export { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; margin-top: 20px; width: 100%; justify-content: center; }
        .btn-export:hover { background: #000; }
        .btn-ics { background: #2980b9; }
        .btn-ics:hover { background: #1c5980; }

        /* --- ANALITICA STYLES MODIFICADO --- */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* --- SKILLS STYLES --- */
        .profile-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .profile-card { padding: 15px; border-radius: 8px; background: #fafafa; border: 1px solid var(--border); }
        body.dark-mode .profile-card { background: #252a40; }
        .profile-title { font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .profile-percent { font-size: 2rem; font-weight: bold; float: right; margin-top: -35px; opacity: 0.2; }
        .profile-bar-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .profile-bar-fill { height: 100%; width: 0%; transition: width 0.6s ease; }
        .tools-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .tool-chip { background: var(--bg-card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tool-chip.active { background: #e3f2fd; border-color: #2196f3; color: #0d47a1; font-weight: 600; }
        .tool-check { width: 18px; height: 18px; border-radius: 4px; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; flex-shrink: 0; }
        .tool-chip.active .tool-check { background: #2196f3; border-color: #2196f3; }

        /* --- SIMULADOR STYLES --- */
        .scheduler-container { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
        .scheduler-controls { flex: 1; min-width: 300px; background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid var(--accent); }
        .scheduler-grid-wrapper { flex: 3; min-width: 600px; overflow-x: auto; background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .form-select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; background: var(--bg-card); color: var(--text-main); }
        .btn-add { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .time-grid { display: grid; grid-template-columns: 60px repeat(6, 1fr); border: 1px solid var(--border); }
        .grid-header { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; }
        .grid-time-cell { border-bottom: 1px solid var(--grid-line); border-right: 1px solid var(--grid-line); height: 50px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #666; background: rgba(0,0,0,0.02); }
        .grid-cell { border-bottom: 1px solid var(--grid-line); border-right: 1px solid var(--grid-line); height: 50px; position: relative; }
        .course-block { position: absolute; width: 95%; left: 2.5%; padding: 5px; border-radius: 4px; color: white; font-size: 0.75rem; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .remove-course { position: absolute; top: 2px; right: 2px; cursor: pointer; font-weight: bold; font-size: 10px; background: rgba(0,0,0,0.2); border-radius: 50%; width: 15px; height: 15px; line-height: 15px; }

        /* --- CALCULADORA STYLES --- */
        .calc-wrapper { display: flex; gap: 30px; flex-wrap: wrap; }
        .calc-inputs { flex: 1; min-width: 320px; background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .calc-results { flex: 1; min-width: 320px; background: #fffbe6; border: 2px solid #ffe58f; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; position: relative; color:#333; }
        body.dark-mode .calc-results { background: #2c2c2c; border-color: #444; color: #eee; }
        
        .grade-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; animation: fadeIn 0.3s; }
        .grade-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .weight-input { width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .btn-del-row { color: #c0392b; cursor: pointer; padding: 5px; background: none; border: none; font-weight: bold; font-size: 1.2rem; }
        
        .btn-calc-action { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-calc-main { background: #4a148c; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; font-size: 1.1rem; }
        .result-big { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }

        @media (max-width: 768px) {
            .navbar { flex-direction: column; height: auto; padding: 10px; }
            .nav-menu { margin-top: 10px; flex-wrap: wrap; justify-content: center; }
            .scheduler-container, .dashboard-container, .calc-wrapper, .analytics-grid { grid-template-columns: 1fr; flex-direction: column; }
            .scheduler-grid-wrapper { min-width: 100%; }
        }
    </style>
</head>
<body>

    <!-- ========================================== -->
    <!-- PANTALLA DE LOGIN CON GOOGLE (FIREBASE)  -->
    <!-- ========================================== -->
    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#8a0303; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; transition:opacity 0.5s;">
        <div style="background:white; padding:40px; border-radius:15px; text-align:center; color:#333; box-shadow:0 10px 30px rgba(0,0,0,0.3); max-width:400px; width:90%;">
            <img src="unmsm.png" style="height:80px; margin-bottom:20px;">
            <h2 style="margin:0 0 10px 0; color:#8a0303;">Acceso Restringido</h2>
            <p style="margin-bottom:25px; color:#666;">Ingresa con tu correo autorizado.</p>
            
            <button id="google-login-btn" style="background:#4285F4; color:white; border:none; padding:12px 25px; border-radius:50px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size:1rem; box-shadow:0 2px 5px rgba(0,0,0,0.2); width:100%;">
                <span style="background:white; border-radius:50%; padding:2px; display:flex;"><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="18"></span>
                Iniciar sesi√≥n con Google
            </button>
            <p id="login-error" style="color:red; margin-top:15px; font-size:0.9rem; display:none; font-weight:bold;"></p>
        </div>
        <div style="margin-top:20px; font-size:0.8rem; opacity:0.7;">Seguridad</div>
    </div>
    <!-- ========================================== -->
     
    <nav class="navbar">
        <div class="nav-brand">
            <!-- MODIFICACI√ìN: IMAGEN UNMSM -->
            <img src="unmsm.png" alt="UNMSM" class="nav-logo-img">
            <span>Administraci√≥n UNMSM</span>
        </div>
        <div class="nav-menu">
            <button class="nav-btn" onclick="showPage('estrategia')"><span class="material-icons">psychology_alt</span> Estrategia IA</button>
            <button class="nav-btn active" onclick="showPage('malla')"><span class="material-icons">grid_view</span> Malla</button>
            <button class="nav-btn" onclick="showPage('progreso')"><span class="material-icons">trending_up</span> Progreso</button>
            <button class="nav-btn" onclick="showPage('analitica')"><span class="material-icons">analytics</span> Anal√≠tica</button>
            <button class="nav-btn" onclick="showPage('calculadora')"><span class="material-icons">calculate</span> Notas</button>
            <button class="nav-btn" onclick="showPage('skills')"><span class="material-icons">psychology</span> Skills</button>
            <button class="nav-btn" onclick="showPage('simulador')"><span class="material-icons">schedule</span> Simulador</button>
            <button class="nav-btn" onclick="showPage('recursos')"><span class="material-icons">link</span> Recursos</button>
            <button class="icon-btn" onclick="toggleTheme()" title="Modo Oscuro"><span class="material-icons">dark_mode</span></button>
        </div>
    </nav>

    <!-- P√ÅGINA 1: MALLA -->
    <div id="page-malla" class="page-section active">
        <div class="malla-header">
            <div>
                <span style="font-size:1.5rem; font-weight:bold; color:var(--primary)" id="credits-display">0</span>
                <small>Cr√©ditos | </small>
                <span style="font-size:1.5rem; font-weight:bold; color:var(--c-op)" id="pps-display">0.00</span>
                <small>P.P.S. Aprox</small>
            </div>
            <div style="font-size:0.9rem; color:#666;">
                <span style="display:inline-block; width:10px; height:10px; background:var(--primary);"></span> Obligatorio
                <span style="display:inline-block; width:10px; height:10px; background:var(--accent); margin-left:10px;"></span> Electivo
            </div>
            <div>
                <button onclick="resetMalla()" style="background:#c0392b; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Reiniciar Todo</button>
            </div>
        </div>
        <div class="malla-container" id="malla-grid"></div>
    </div>

    <!-- P√ÅGINA 2: DASHBOARD PROGRESO -->
    <div id="page-progreso" class="page-section">
        <div id="export-content">
            <h2 style="text-align:center; margin-bottom:20px;">Reporte de Progreso Acad√©mico</h2>
            
            <div class="dashboard-container">
                <!-- Gr√°fico Dona -->
                <div class="chart-card">
                    <h3>Avance para Egresar</h3>
                    <div style="height:250px; width:250px;">
                        <canvas id="progressChart"></canvas>
                    </div>
                    <p style="margin-top:15px; font-weight:bold; color:var(--primary);" id="chart-text">0% Completado</p>
                </div>

                <!-- Estad√≠sticas y Proyecci√≥n -->
                <div class="stats-card">
                    <h3>Cr√©ditos vs Meta (220)</h3>
                    <p style="font-size:0.8rem; color:#666;">Se requieren 220 Cr√©ditos para egresar, independientemente de cu√°ntos electivos extra lleves.</p>
                    
                    <div class="stat-row">
                        <div class="stat-label"><span>Progreso Real</span> <span id="stat-total">0 / 220</span></div>
                        <div class="stat-bar-bg"><div class="stat-bar-fill" id="bar-total" style="width:0%; background:var(--primary);"></div></div>
                    </div>

                    <div class="projection-box">
                        <div class="projection-title"><span class="material-icons">timer</span> Tiempo Restante</div>
                        <p id="grad-projection" style="font-size:1.1rem; margin:0; font-weight:500;">Calculando...</p>
                        <small style="display:block; margin-top:5px; opacity:0.8;">*C√°lculo basado en 21 cr√©ditos por ciclo.</small>
                    </div>
                    
                    <div style="margin-top:20px; text-align:center; padding:15px; background:rgba(0,0,0,0.03); border-radius:8px;">
                        <div style="font-size:2rem; font-weight:bold; color:var(--primary)" id="pps-dashboard">0.00</div>
                        <small>Promedio Ponderado Acumulado Estimado</small>
                    </div>
                </div>
            </div>
        </div>
        <!-- MODIFICACI√ìN: SE ELIMIN√ì BOT√ìN CV -->
        <div style="display:flex; gap:10px; justify-content: center;">
            <button class="btn-export" onclick="exportPDF()"><span class="material-icons">picture_as_pdf</span> Descargar Reporte Completo</button>
        </div>
    </div>

    <!-- P√ÅGINA 2.5: ANAL√çTICA (MODIFICADO) -->
    <div id="page-analitica" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Inteligencia de Negocios Personal</h2>
        
        <div class="analytics-grid">
            <!-- Gr√°fico Lineal: Rendimiento por Ciclo -->
            <div class="chart-card">
                <h3>Historial de Promedio (PPS) por Ciclo</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="ppsHistoryChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico Polar/Pie: Distribuci√≥n de Cursos -->
            <div class="chart-card">
                <h3>Perfil de Especializaci√≥n</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="skillsRadarChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Basado en cursos aprobados de cada rama.</small>
            </div>
            
            <!-- NUEVO: Comparativa por √Åreas -->
            <div class="chart-card">
                <h3>Avance de Cr√©ditos por √Årea</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="areaProgressChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Cr√©ditos aprobados vs Total disponible por rama.</small>
            </div>

            <!-- NUEVO: Distribuci√≥n de Notas -->
            <div class="chart-card">
                <h3>Distribuci√≥n de Rendimiento</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="gradesDistChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Clasificaci√≥n de notas obtenidas.</small>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 3: CALCULADORA -->
    <div id="page-calculadora" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">Calculadora de Notas</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Proyecta tu nota final ingresando tus calificaciones parciales.</p>

        <div class="calc-wrapper">
            <div class="calc-inputs">
                <div id="grades-container"></div>
                <button class="btn-calc-action" onclick="addGradeRow()">+ Agregar nota</button>
                <div style="margin-top:25px; padding-top:15px; border-top:1px solid #eee;">
                    <label class="form-label">Nota Aprobatoria (UNMSM):</label>
                    <input type="number" id="calc-min-pass" class="form-select" value="11" style="text-align:center; font-weight:bold;">
                </div>
                <button class="btn-calc-main" onclick="calculateGrades()">Calcular Promedio</button>
                <button onclick="resetCalculator()" style="width:100%; margin-top:10px; background:none; border:none; text-decoration:underline; cursor:pointer; color:#777;">Limpiar datos</button>
            </div>

            <div class="calc-results">
                <h3>Resultados</h3>
                <div style="margin-bottom:10px; font-size:0.9rem; opacity:0.8;">Promedio Actual:</div>
                <div id="res-current-avg" class="result-big">0.00</div>
                <div id="res-analysis" style="font-size:1.1rem; line-height:1.5;">Ingresa tus notas...</div>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 4: SKILLS DASHBOARD -->
    <div id="page-skills" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Perfil Profesional (Skills)</h2>
        <div class="profile-dashboard">
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-fin)"><span class="material-icons">attach_money</span> Finanzas</div>
                <div class="profile-percent" id="pct-fin">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-fin" style="background:var(--c-fin)"></div></div>
            </div>
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-mkt)"><span class="material-icons">campaign</span> Marketing</div>
                <div class="profile-percent" id="pct-mkt">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-mkt" style="background:var(--c-mkt)"></div></div>
            </div>
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-rrhh)"><span class="material-icons">groups</span> RRHH</div>
                <div class="profile-percent" id="pct-rrhh">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-rrhh" style="background:var(--c-rrhh)"></div></div>
            </div>
            <div class="profile-card">
                <div class="profile-title" style="color:var(--c-op)"><span class="material-icons">settings</span> Gesti√≥n/Ops</div>
                <div class="profile-percent" id="pct-op">0%</div>
                <div class="profile-bar-bg"><div class="profile-bar-fill" id="bar-op" style="background:var(--c-op)"></div></div>
            </div>
        </div>
        <h3 style="margin-bottom:15px; color:#555;">Marcar Herramientas Dominadas:</h3>
        <div class="tools-container" id="tools-grid"></div>
    </div>

    <!-- P√ÅGINA 5: SIMULADOR HORARIO -->
    <div id="page-simulador" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
            <h2 style="margin:0;">Simulador de Matr√≠cula</h2>
            <div style="display:flex; gap:10px;">
                <!-- MODIFICACI√ìN: BOT√ìN ICS GOOGLE CALENDAR -->
                <button class="btn-export btn-ics" style="margin:0; font-size:0.9rem;" onclick="downloadICS()">
                    <span class="material-icons">event</span> Exportar Google Calendar
                </button>
                <button class="btn-export" style="margin:0; font-size:0.9rem;" onclick="exportSchedulePDF()">
                    <span class="material-icons">download</span> Descargar PDF
                </button>
            </div>
        </div>
        
        <div class="scheduler-container">
            <div class="scheduler-controls">
                <h3>Agregar Curso</h3>
                <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Solo cursos disponibles (requisitos OK).</p>
                <div class="form-group"><label class="form-label">Curso:</label><select id="sched-course" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">D√≠a:</label><select id="sched-day" class="form-select"><option value="1">Lunes</option><option value="2">Martes</option><option value="3">Mi√©rcoles</option><option value="4">Jueves</option><option value="5">Viernes</option><option value="6">S√°bado</option></select></div>
                <div class="form-group" style="display:flex; gap:10px;"><div style="flex:1"><label class="form-label">Inicio:</label><select id="sched-start" class="form-select"></select></div><div style="flex:1"><label class="form-label">Fin:</label><select id="sched-end" class="form-select"></select></div></div>
                <div style="margin-bottom:20px; padding:10px; background:rgba(0,0,0,0.05); border-radius:8px;"><strong>Cr√©ditos: </strong> <span id="sim-credits">0</span></div>
                <button class="btn-add" onclick="addToSchedule()">AGREGAR</button>
                <button onclick="clearSchedule()" style="width:100%; margin-top:10px; background:none; border:1px solid #ccc; padding:10px; border-radius:6px; cursor:pointer; color:var(--text-main);">Limpiar</button>
            </div>
            <div class="scheduler-grid-wrapper" id="schedule-export-area">
                <div class="time-grid" id="schedule-grid">
                    <div class="grid-header">Hora</div><div class="grid-header">Lun</div><div class="grid-header">Mar</div><div class="grid-header">Mi√©</div><div class="grid-header">Jue</div><div class="grid-header">Vie</div><div class="grid-header">S√°b</div>
                </div>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 6: RECURSOS -->
    <div id="page-recursos" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Recursos Institucionales</h2>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
            <a href="https://sum.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #8a0303; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">SUM</h3><p style="font-size:0.85rem; color:#666;">Sistema √önico de Matr√≠cula</p>
                </div>
            </a>
            <a href="https://sisbib.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #2980b9; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">Biblioteca</h3><p style="font-size:0.85rem; color:#666;">Repositorio y Tesis</p>
                </div>
            </a>
            <a href="https://administracion.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #27ae60; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">Facultad</h3><p style="font-size:0.85rem; color:#666;">Web FCA UNMSM</p>
                </div>
            </a>
        </div>
        <div style="margin-top:30px; background:rgba(255, 193, 7, 0.2); padding:20px; border-radius:8px; border:1px solid rgba(255, 193, 7, 0.5);">
            <h4 style="margin-top:0; color:#b7791f;"><span class="material-icons" style="vertical-align:middle">info</span> Tips para Matr√≠cula</h4>
            <ul style="margin-bottom:0; padding-left:20px; font-size:0.9rem; color:#b7791f;">
                <li>Para matr√≠cula regular necesitas un PPS aprobado (>11).</li>
                <li>Los cursos electivos requieren m√≠nimo 20 alumnos para abrirse.</li>
                <li>Valida tus pr√°cticas pre-profesionales a partir del 8vo ciclo.</li>
            </ul>
        </div>
    </div>

    <!-- P√ÅGINA 7: ESTRATEGIA & IA (NUEVO) -->
    <div id="page-estrategia" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">Planificaci√≥n Estrat√©gica & Asistente Virtual</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Detecta tus "Semanas del Infierno" y recibe asesor√≠a t√°ctica basada en tus datos.</p>

        <div class="strategy-layout">
            
            <!-- COLUMNA IZQUIERDA: MAPA DE CALOR -->
            <div class="heatmap-panel">
                <div class="panel-header">
                    <h3><span class="material-icons">local_fire_department</span> Mapa de Calor Acad√©mico</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="date" id="cycle-start-date" class="form-select" style="padding:5px; width:130px;" title="Inicio de Ciclo">
                        <button class="btn-export btn-ics" style="margin:0; padding:5px 10px; font-size:0.8rem;" onclick="downloadDeadlinesICS()">
                            <span class="material-icons">event</span> G. Calendar
                        </button>
                    </div>
                </div>

                <!-- Inputs para agregar eventos -->
                <div class="add-event-box">
                    <div style="display:grid; grid-template-columns: 80px 1fr 100px auto; gap:10px; align-items:center;">
                        <input type="number" id="evt-week" placeholder="Semana (1-16)" class="form-select" min="1" max="16">
                        <input type="text" id="evt-name" placeholder="Ej: Parcial Microeconom√≠a" class="form-select">
                        <select id="evt-type" class="form-select">
                            <option value="3">Examen (3pts)</option>
                            <option value="2">Trabajo (2pts)</option>
                            <option value="1">Tarea (1pt)</option>
                        </select>
                        <button class="btn-add" style="padding:10px;" onclick="addHellEvent()">+</button>
                    </div>
                </div>

                <!-- Grilla de Semanas -->
                <div id="hell-grid" class="hell-weeks-grid">
                    <!-- Se genera con JS -->
                </div>
                
                <div class="legend">
                    <span class="dot" style="background:#4caf50"></span> Relax
                    <span class="dot" style="background:#f1c40f"></span> Moderado
                    <span class="dot" style="background:#e67e22"></span> Pesado
                    <span class="dot" style="background:#c0392b"></span> INFIERNO
                </div>
            </div>

            <!-- COLUMNA DERECHA: IA CONTEXTUAL (VERSI√ìN AUTOM√ÅTICA) -->
            <div class="ai-panel">
                <div class="ai-header">
                    <span class="material-icons" style="font-size:2rem; color:#4dd0e1;">psychology</span>
                    <div style="flex:1;">
                        <div style="font-weight:bold; display:flex; align-items:center; gap:10px;">
                            San Marcos BOT
                        </div>
                    </div>
                    
                </div>
                
                <div id="chat-history" class="chat-area">
                    <div class="msg-ai">
                        Hola, colega. Soy tu asistente acad√©mico UNMSM.<br>
                        Puedo analizar tu <b>Mapa de Calor</b>, tus <b>Notas</b> y resolver dudas complejas de Finanzas o Gesti√≥n.
                    </div>
                </div>

                <!-- Indicador de pensando -->
                <div id="ai-loading" style="display:none; padding:10px; font-size:0.8rem; color:#aaa; font-style:italic;">
                    <span class="material-icons" style="font-size:1rem; vertical-align:middle; animation:spin 1s linear infinite;">sync</span> Consultando servidor IA...
                </div>
                
                <div class="chat-input-area">
                    <input type="text" id="user-msg" placeholder="Ej: Expl√≠came el WACC con un ejemplo peruano..." onkeypress="handleChatEnter(event)">
                    <button onclick="sendMessage()"><span class="material-icons">send</span></button>
                </div>
                
                <div class="quick-actions">
                    <button class="chip" onclick="askAI('finance')">üí∞ Concepto Financiero</button>
                    <button class="chip" onclick="askAI('risk')">‚ö†Ô∏è An√°lisis de Riesgo</button>
                    <button class="chip" onclick="askAI('email')">‚úâÔ∏è Redactar Correo</button>
                </div>
            </div>

        <!-- Modal para Configurar API Key -->
        <style>
            @keyframes spin { 100% { transform: rotate(360deg); } }
            /* Markdown b√°sico para respuestas IA */
            .msg-ai strong { color: #d35400; }
            .msg-ai ul { padding-left: 20px; margin: 5px 0; }
            .msg-ai code { background: #eee; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        </style>

        </div>
    </div>

    <style>
        /* ESTILOS ESPEC√çFICOS PARA LA NUEVA SECCI√ìN */
        .strategy-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; height: 750px; }
        
        /* Heatmap Styles */
        .heatmap-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--grid-line); padding-bottom: 10px; }
        .add-event-box { background: rgba(0,0,0,0.02); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        
        .hell-weeks-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; overflow-y: auto; padding-right: 5px; flex: 1; }
        .week-box { border: 1px solid var(--border); border-radius: 8px; padding: 10px; position: relative; min-height: 120px; transition: all 0.3s; display: flex; flex-direction: column; }
        .week-box:hover { transform: scale(1.02); z-index: 5; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .week-header { font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .week-score { font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; color: white; }
        
        .event-item { font-size: 0.75rem; margin-bottom: 3px; padding: 3px; border-radius: 3px; background: rgba(255,255,255,0.7); color: #333; display: flex; justify-content: space-between; }
        .event-item .del-evt { cursor: pointer; color: red; font-weight: bold; display: none; }
        .week-box:hover .del-evt { display: block; }

        /* Colores de Intensidad */
        .level-0 { background: #e8f5e9; border-color: #a5d6a7; } /* Low */
        .level-1 { background: #fff9c4; border-color: #fff59d; } /* Mid */
        .level-2 { background: #ffccbc; border-color: #ffab91; } /* High */
        .level-3 { background: #ffcdd2; border-color: #ef9a9a; animation: pulseRed 2s infinite; } /* HELL */
        .level-3 .week-header { color: #c62828; }

        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); } }

        .legend { display: flex; gap: 15px; margin-top: 10px; font-size: 0.8rem; justify-content: center; color: #666; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* AI Chat Styles */
        .ai-panel { background: #2c3e50; color: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .ai-header { padding: 20px; background: #1a252f; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #34495e; }
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: url('https://www.transparenttextures.com/patterns/cubes.png'); /* Pattern sutil */ }
        
        .msg-ai, .msg-user { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .msg-ai { background: white; color: #333; border-top-left-radius: 0; align-self: flex-start; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .msg-user { background: var(--accent); color: #000; border-top-right-radius: 0; align-self: flex-end; font-weight: 500; }
        
        .chat-input-area { padding: 15px; background: #1a252f; display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; padding: 12px; border-radius: 20px; border: none; font-family: inherit; }
        .chat-input-area button { background: var(--primary); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .chat-input-area button:hover { transform: scale(1.1); }

        .quick-actions { padding: 10px 15px; background: #1a252f; display: flex; gap: 8px; overflow-x: auto; padding-top: 0; }
        .chip { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ddd; padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; }
        .chip:hover { background: white; color: #333; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        @media (max-width: 900px) {
            .strategy-layout { grid-template-columns: 1fr; height: auto; }
            .heatmap-panel, .ai-panel { height: 600px; }
            .hell-weeks-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>

<script type="module">
    // ================= SEGURIDAD FIREBASE (TUS CLAVES) =================
    
    // 1. IMPORTAR FIREBASE DESDE LA NUBE (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // 2. TU LISTA BLANCA (MODIFICAR LOS CORREOS REALES)
    const ALLOWED_EMAILS = [
        "andersonpedroescobar292@gmail.com",
        "20231490@lamolina.edu.pe"
    ];

    // 3. CONFIGURACI√ìN 
    const firebaseConfig = {
        apiKey: "AIzaSyDBq8ExQaOE1QLdVqedmesz1jxdwv2dR5Y",
        authDomain: "unmsm-administracion.firebaseapp.com",
        projectId: "unmsm-administracion",
        storageBucket: "unmsm-administracion.firebasestorage.app",
        messagingSenderId: "885762425594",
        appId: "1:885762425594:web:a514af6db93fef4be6bf43",
        measurementId: "G-16KXE5N8ZD"
    };

    // 4. INICIALIZAR
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // 5. FUNCI√ìN DE LOGIN
    const loginBtn = document.getElementById('google-login-btn');
    if(loginBtn) {
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    checkUserAccess(result.user);
                })
                .catch((error) => {
                    console.error("Error Login:", error);
                    showError("Error de conexi√≥n con Google.");
                });
        });
    }

    // 6. VERIFICAR PERMISOS
    function checkUserAccess(user) {
        // Convertimos a min√∫sculas para evitar errores
        if (ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
            // ¬°ACCESO CONCEDIDO!
            const overlay = document.getElementById('login-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);
            console.log("Bienvenido: " + user.email);
        } else {
            // ¬°ACCESO DENEGADO!
            showError(`üö´ Acceso Denegado. El correo ${user.email} no est√° autorizado.`);
            signOut(auth); // Cerrar sesi√≥n forzosamente
        }
    }

    function showError(msg) {
        const err = document.getElementById('login-error');
        err.innerText = msg;
        err.style.display = 'block';
    }

    // 7. PERSISTENCIA (Para que no pida login a cada rato)
    onAuthStateChanged(auth, (user) => {
        if (user) {
            checkUserAccess(user);
        }
    });

    // ================= FIN C√ìDIGO FIREBASE =================

    // ================= DATA =================
    const courses = [
        // CICLO 1
        {id:'EGO1O1', name:'Lenguaje', cr:4, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O2', name:'M√©todos de Estudio Universitario', cr:3, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O3', name:'Historia del Per√∫', cr:3, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O4', name:'Matem√°tica I', cr:4, c:1, t:'O', req:[], tags:['fin']},
        {id:'EGO1O5', name:'Desarrollo Personal', cr:3, c:1, t:'O', req:[], tags:['rrhh']},
        {id:'EGO1O6', name:'Ingl√©s I', cr:2, c:1, t:'O', req:[], tags:[]},
        // CICLO 2
        {id:'EGO2O1', name:'Investigaci√≥n Acad√©mica', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O2', name:'Filosof√≠a y √âtica', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O3', name:'Realidad Nacional y Mundial', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O4', name:'Matem√°tica II', cr:4, c:2, t:'O', req:['EGO1O4'], tags:['fin']},
        {id:'EGO2O5', name:'Derechos Fundamentales', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O6', name:'Ingl√©s II', cr:2, c:2, t:'O', req:['EGO1O6'], tags:[]},
        // CICLO 3
        {id:'ADO23301', name:'Estad√≠stica Descriptiva', cr:4, c:3, t:'O', req:[], tags:['mkt']},
        {id:'ADO23302', name:'Microeconom√≠a', cr:3, c:3, t:'O', req:[], tags:['fin']},
        {id:'ADO23303', name:'Visi√≥n para el Desarrollo', cr:3, c:3, t:'O', req:['EGO2O1'], tags:[]},
        {id:'ADO23304', name:'Fundamentos de Administraci√≥n', cr:4, c:3, t:'O', req:[], tags:['op']},
        {id:'ADO23305', name:'TICs para la Gesti√≥n', cr:3, c:3, t:'O', req:[], tags:['op']},
        {id:'ADO23306', name:'Fundamentos de Contabilidad', cr:3, c:3, t:'O', req:[], tags:['fin']},
        {id:'ADO23307', name:'Desarrollo Sostenible', cr:2, c:3, t:'O', req:[], tags:[]},
        // CICLO 4
        {id:'ADO23401', name:'Estad√≠stica Inferencial', cr:4, c:4, t:'O', req:['ADO23301'], tags:['mkt']},
        {id:'ADO23402', name:'Macroeconom√≠a', cr:3, c:4, t:'O', req:['ADO23302'], tags:['fin']},
        {id:'ADO23403', name:'Derecho Empresarial', cr:3, c:4, t:'O', req:[], tags:['op']},
        {id:'ADO23404', name:'Investigaci√≥n Cient√≠fica', cr:3, c:4, t:'O', req:['ADO23303'], tags:[]},
        {id:'ADO23405', name:'Procesos Administrativos', cr:4, c:4, t:'O', req:['ADO23304'], tags:['op']},
        {id:'ADO23406', name:'Costos y Presupuestos', cr:3, c:4, t:'O', req:['ADO23306'], tags:['fin']},
        {id:'ADO23407', name:'Matem√°tica Financiera', cr:4, c:4, t:'O', req:[], tags:['fin']},
        // CICLO 5
        {id:'ADO23501', name:'Derecho Laboral', cr:2, c:5, t:'O', req:['ADO23403'], tags:['rrhh']},
        {id:'ADO23502', name:'Administraci√≥n de la Calidad', cr:3, c:5, t:'O', req:['ADO23405'], tags:['op']},
        {id:'ADO23503', name:'Fundamentos del Talento Humano', cr:3, c:5, t:'O', req:[], tags:['rrhh']},
        {id:'ADO23504', name:'Finanzas Corporativas I', cr:3, c:5, t:'O', req:['ADO23407'], tags:['fin']},
        {id:'ADO23505', name:'Herramientas Desarrollo Proyectos', cr:3, c:5, t:'O', req:[], tags:['op']},
        {id:'ADO23506', name:'Fundamentos de Marketing', cr:3, c:5, t:'O', req:[], tags:['mkt']},
        {id:'ADO23507', name:'Cadenas de Suministros', cr:3, c:5, t:'O', req:[], tags:['op']},
        {id:'ADO23508', name:'Emprendimiento e Innovaci√≥n', cr:3, c:5, t:'O', req:[], tags:['op']},
        // CICLO 6
        {id:'ADE23601', name:'Reclutamiento y Selecci√≥n', cr:3, c:6, t:'E', req:['ADO23503'], tags:['rrhh']},
        {id:'ADE23602', name:'Seguridad y Salud en el Trabajo', cr:3, c:6, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23603', name:'Finanzas Corporativas II', cr:3, c:6, t:'E', req:['ADO23504'], tags:['fin']},
        {id:'ADE23604', name:'Form. y Eval. Proyectos Inversi√≥n', cr:3, c:6, t:'E', req:['ADO23505'], tags:['fin', 'op']},
        {id:'ADE23605', name:'Marketing Digital', cr:3, c:6, t:'E', req:['ADO23506'], tags:['mkt']},
        {id:'ADE23606', name:'Comportamiento del Consumidor', cr:3, c:6, t:'E', req:[], tags:['mkt']},
        {id:'ADE23607', name:'Planeaci√≥n Demanda/Pron√≥sticos', cr:3, c:6, t:'E', req:['ADO23507'], tags:['op']},
        {id:'ADE23608', name:'Inv. Desarrollo e Innovaci√≥n', cr:3, c:6, t:'E', req:[], tags:['op']},
        {id:'ADO23601', name:'M√©todos Cuantitativos', cr:3, c:6, t:'O', req:['ADO23401'], tags:['op']},
        {id:'ADO23602', name:'Investigaci√≥n de Mercados', cr:3, c:6, t:'O', req:[], tags:['mkt']},
        {id:'ADO23603', name:'Derecho Tributario', cr:2, c:6, t:'O', req:['ADO23501'], tags:['fin']},
        {id:'ADO23604', name:'T√©cnicas de Inv. Cualitativa', cr:3, c:6, t:'O', req:['ADO23404'], tags:['mkt', 'rrhh']},
        {id:'ADO23605', name:'Reestructuraci√≥n Empresarial', cr:3, c:6, t:'O', req:['ADO23502'], tags:['op']},
        // CICLO 7
        {id:'ADE23701', name:'Capacitaci√≥n y Desarrollo Talento', cr:3, c:7, t:'E', req:['ADE23601'], tags:['rrhh']},
        {id:'ADE237010', name:'Aprovisionamiento y Negociaci√≥n', cr:3, c:7, t:'E', req:[], tags:['op']},
        {id:'ADE23702', name:'Gesti√≥n Clima y Cultura Org.', cr:3, c:7, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23703', name:'Mercado de Capitales', cr:3, c:7, t:'E', req:['ADE23603'], tags:['fin']},
        {id:'ADE23704', name:'Derivados Financieros', cr:3, c:7, t:'E', req:[], tags:['fin']},
        {id:'ADE23705', name:'Form. Eval. Proyectos Sociales I', cr:3, c:7, t:'E', req:['ADE23604'], tags:['op']},
        {id:'ADE23706', name:'Gesti√≥n de Riesgos Proyectos', cr:3, c:7, t:'E', req:[], tags:['op']},
        {id:'ADE23707', name:'Marketing de Servicios', cr:3, c:7, t:'E', req:['ADE23605'], tags:['mkt']},
        {id:'ADE23708', name:'Programaci√≥n Neuroling√º√≠stica', cr:3, c:7, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23709', name:'Operaciones I', cr:3, c:7, t:'E', req:['ADE23607'], tags:['op']},
        {id:'ADO23701', name:'Negocios Internacionales', cr:4, c:7, t:'O', req:[], tags:['op', 'fin']},
        {id:'ADO23702', name:'T√©cnicas de Inv. Cuantitativa', cr:3, c:7, t:'O', req:['ADO23604'], tags:['mkt']},
        {id:'ADO23703', name:'Prospectiva Empresarial', cr:3, c:7, t:'O', req:['ADO23605'], tags:['op']},
        // CICLO 8
        {id:'ADE23801', name:'Evaluaci√≥n del Desempe√±o', cr:3, c:8, t:'E', req:['ADE23701'], tags:['rrhh']},
        {id:'ADE238010', name:'Gesti√≥n Almacenes e Inventarios', cr:3, c:8, t:'E', req:[], tags:['op']},
        {id:'ADE23802', name:'Inteligencia Emocional y Social', cr:3, c:8, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23803', name:'Finanzas Internacionales', cr:3, c:8, t:'E', req:['ADE23703'], tags:['fin']},
        {id:'ADE23804', name:'Econometr√≠a Financiera', cr:3, c:8, t:'E', req:[], tags:['fin']},
        {id:'ADE23805', name:'Form. Eval. Proyectos Sociales II', cr:3, c:8, t:'E', req:['ADE23705'], tags:['op']},
        {id:'ADE23806', name:'Gesti√≥n Proyectos P√∫b/Priv', cr:3, c:8, t:'E', req:[], tags:['op']},
        {id:'ADE23807', name:'Marketing Internacional', cr:3, c:8, t:'E', req:['ADE23707'], tags:['mkt']},
        {id:'ADE23808', name:'Publicidad y Branding', cr:3, c:8, t:'E', req:[], tags:['mkt']},
        {id:'ADE23809', name:'Operaciones II', cr:3, c:8, t:'E', req:['ADE23709'], tags:['op']},
        {id:'ADO23801', name:'Integraci√≥n Econ√≥mica', cr:3, c:8, t:'O', req:['ADO23701'], tags:['op']},
        {id:'ADO23802', name:'Proyecto de Investigaci√≥n', cr:3, c:8, t:'O', req:['ADO23702'], tags:['op']},
        {id:'ADO23803', name:'Planeamiento Estrat√©gico', cr:3, c:8, t:'O', req:['ADO23703'], tags:['op']},
        {id:'ADO23804', name:'Gesti√≥n P√∫blica', cr:3, c:8, t:'O', req:[], tags:['op']},
        // CICLO 9
        {id:'ADE23901', name:'Valoraci√≥n Puestos/Compensaciones', cr:3, c:9, t:'E', req:['ADE23801'], tags:['rrhh']},
        {id:'ADE23902', name:'Gesti√≥n Talento Sector P√∫blico', cr:3, c:9, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23903', name:'Gesti√≥n Riesgos Financieros', cr:3, c:9, t:'E', req:['ADE23803'], tags:['fin']},
        {id:'ADE23904', name:'Finanzas P√∫blicas', cr:3, c:9, t:'E', req:[], tags:['fin']},
        {id:'ADE23905', name:'Gerencia de Proyectos', cr:3, c:9, t:'E', req:['ADE23905'], tags:['op']},
        {id:'ADE23906', name:'Gerencia de Ventas', cr:3, c:9, t:'E', req:['ADE23807'], tags:['mkt']},
        {id:'ADE23907', name:'Negociaci√≥n Comercial', cr:3, c:9, t:'E', req:[], tags:['mkt']},
        {id:'ADE23908', name:'Log√≠stica Sector P√∫blico', cr:3, c:9, t:'E', req:['ADE23809'], tags:['op']},
        {id:'ADE23909', name:'Distribuci√≥n y Transporte', cr:3, c:9, t:'E', req:[], tags:['op']},
        {id:'ADO23901', name:'Desarrollo de Investigaci√≥n I', cr:3, c:9, t:'O', req:['ADO23802'], tags:[]},
        {id:'ADO23902', name:'Direcci√≥n Estrat√©gica', cr:3, c:9, t:'O', req:['ADO23803'], tags:['op']},
        {id:'ADO23903', name:'Des. y Lanzamiento Nuevos Prod.', cr:3, c:9, t:'O', req:[], tags:['mkt']},
        {id:'ADO23904', name:'Cadena de Valor', cr:3, c:9, t:'O', req:[], tags:['op']},
        // CICLO 10
        {id:'ADE23101', name:'Gerencia Estrat√©gica Talento', cr:3, c:10, t:'E', req:['ADE23901'], tags:['rrhh']},
        {id:'ADE23102', name:'Auditor√≠a Gesti√≥n Talento', cr:3, c:10, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23103', name:'Direcci√≥n Financiera', cr:3, c:10, t:'E', req:['ADE23903'], tags:['fin']},
        {id:'ADE23104', name:'Taller de Proyectos', cr:3, c:10, t:'E', req:['ADE23905'], tags:['op']},
        {id:'ADE23105', name:'Gerencia de Marketing', cr:3, c:10, t:'E', req:['ADE23906'], tags:['mkt']},
        {id:'ADE23106', name:'Neuromarketing', cr:3, c:10, t:'E', req:[], tags:['mkt']},
        {id:'ADE23107', name:'Gerencia Log√≠stica', cr:3, c:10, t:'E', req:['ADE23908'], tags:['op']},
        {id:'ADE23108', name:'Log√≠stica Internacional', cr:3, c:10, t:'E', req:[], tags:['op']},
        {id:'ADO23101', name:'Desarrollo de Investigaci√≥n II', cr:3, c:10, t:'O', req:['ADO23901'], tags:[]},
        {id:'ADO23102', name:'Gerencia General y Alta Dir.', cr:3, c:10, t:'O', req:['ADO23902'], tags:['op']},
        {id:'ADO23103', name:'Gesti√≥n de PYMES', cr:3, c:10, t:'O', req:[], tags:['op']}
    ];

    const skillsDB = [
        { id: 'excel_adv', name: 'Excel Avanzado (Macros)', weights: { fin: 3, op: 3, mkt: 2, rrhh: 2 } },
        { id: 'power_bi', name: 'Power BI / Tableau', weights: { fin: 2, op: 3, mkt: 2, rrhh: 2 } },
        { id: 'sql', name: 'SQL para Negocios', weights: { fin: 2, op: 3, mkt: 2, rrhh: 1 } },
        { id: 'python', name: 'Python (Anal√≠tica)', weights: { fin: 3, op: 2, mkt: 2, rrhh: 1 } },
        { id: 'ingles', name: 'Ingl√©s de Negocios', weights: { fin: 2, op: 3, mkt: 2, rrhh: 2 } },
        { id: 'mat_fin', name: 'Matem√°tica Financiera', weights: { fin: 3, op: 1 } },
        { id: 'estados_fin', name: 'An√°lisis Estados Fin.', weights: { fin: 3, op: 1 } },
        { id: 'bolsa', name: 'Bolsa de Valores', weights: { fin: 3 } },
        { id: 'econometria', name: 'Econometr√≠a', weights: { fin: 3, mkt: 1 } },
        { id: 'sap_fi', name: 'SAP FI/CO', weights: { fin: 3, op: 1 } },
        { id: 'riesgos', name: 'Gesti√≥n de Riesgos', weights: { fin: 3, op: 2 } },
        { id: 'bloomberg', name: 'Bloomberg Terminal', weights: { fin: 3 } },
        { id: 'fintech', name: 'Fintech & Blockchain', weights: { fin: 2, mkt: 1 } },
        { id: 'inv_merc', name: 'Investigaci√≥n Mercados', weights: { mkt: 3, op: 1 } },
        { id: 'seo_sem', name: 'SEO/SEM (Google Ads)', weights: { mkt: 3 } },
        { id: 'branding', name: 'Branding', weights: { mkt: 3 } },
        { id: 'analytics', name: 'Google Analytics 4', weights: { mkt: 3, op: 1 } },
        { id: 'crm', name: 'CRM (Salesforce/HubSpot)', weights: { mkt: 3, op: 1, fin: 1 } },
        { id: 'neuromkt', name: 'Neuromarketing', weights: { mkt: 3 } },
        { id: 'design', name: 'Design Thinking', weights: { mkt: 2, op: 2, rrhh: 1 } },
        { id: 'social_ads', name: 'Facebook/Meta Ads', weights: { mkt: 3 } },
        { id: 'seleccion', name: 'Selecci√≥n y Reclutamiento', weights: { rrhh: 3 } },
        { id: 'legislacion', name: 'Legislaci√≥n Laboral', weights: { rrhh: 3, op: 1 } },
        { id: 'clima', name: 'Clima y Cultura Org.', weights: { rrhh: 3 } },
        { id: 'capacitacion', name: 'Capacitaci√≥n', weights: { rrhh: 3 } },
        { id: 'planillas', name: 'Planillas (PLAME)', weights: { rrhh: 3, fin: 1 } },
        { id: 'linkedin', name: 'LinkedIn Recruiter', weights: { rrhh: 3 } },
        { id: 'sst', name: 'Seguridad y Salud (SST)', weights: { rrhh: 3, op: 2 } },
        { id: 'people_analytics', name: 'People Analytics', weights: { rrhh: 3, op: 1 } },
        { id: 'supply', name: 'Supply Chain Mgmt', weights: { op: 3, mkt: 1, fin: 1 } },
        { id: 'bpm', name: 'Procesos BPM (Bizagi)', weights: { op: 3 } },
        { id: 'planeamiento', name: 'Planeamiento Estrat√©gico', weights: { op: 3, fin: 1, mkt: 1, rrhh: 1 } },
        { id: 'gestion_pub', name: 'Gesti√≥n P√∫blica (SIAF)', weights: { op: 3 } },
        { id: 'pmi', name: 'Gesti√≥n Proyectos (PMI)', weights: { op: 3, fin: 1 } },
        { id: 'sap_mm', name: 'SAP MM/SD', weights: { op: 3 } },
        { id: 'logistica', name: 'Log√≠stica Internacional', weights: { op: 3 } },
        { id: 'six_sigma', name: 'Lean Six Sigma', weights: { op: 3 } }
    ];

    let approved = new Set();
    let approvedGrades = {}; 
    let acquiredSkills = new Set();
    let mySchedule = []; 
    let chartInstance = null;
    let ppsChartInstance = null;
    let skillsRadarInstance = null;
    let areaProgressInstance = null;
    let gradesDistInstance = null;

    // ================= INIT =================
    function init() {
        if(localStorage.getItem('unmsm_adm_v11_c')) approved = new Set(JSON.parse(localStorage.getItem('unmsm_adm_v11_c')));
        if(localStorage.getItem('unmsm_adm_v11_g')) approvedGrades = JSON.parse(localStorage.getItem('unmsm_adm_v11_g'));
        if(localStorage.getItem('unmsm_adm_v11_s')) acquiredSkills = new Set(JSON.parse(localStorage.getItem('unmsm_adm_v11_s')));
        if(localStorage.getItem('unmsm_adm_v11_h')) mySchedule = JSON.parse(localStorage.getItem('unmsm_adm_v11_h'));
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        
        renderMalla();
        renderSkills();
        initSchedule();
        initCalculator();
        updateStats();
    }

    function showPage(id) {
        // 1. Ocultar todas las secciones y desactivar botones
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        // 2. Mostrar la secci√≥n seleccionada
        document.getElementById('page-'+id).classList.add('active');
        
        // 3. Activar el bot√≥n correcto (CORREGIDO EL ORDEN)
        // El orden en el HTML es: [0:Estrategia, 1:Malla, 2:Progreso, 3:Analitica, 4:Calc, 5:Skills, 6:Simulador, 7:Recursos]
        const map = {
            'estrategia': 0,
            'malla': 1, 
            'progreso': 2, 
            'analitica': 3, 
            'calculadora': 4, 
            'skills': 5, 
            'simulador': 6, 
            'recursos': 7
        };

        if(map[id] !== undefined) {
            // Usamos .nav-menu .nav-btn para ser m√°s espec√≠ficos
            const buttons = document.querySelectorAll('.nav-menu .nav-btn');
            if(buttons[map[id]]) {
                buttons[map[id]].classList.add('active');
            }
        }

        // 4. L√≥gica espec√≠fica de cada p√°gina
        if(id === 'simulador') updateScheduleDropdowns();
        if(id === 'progreso') renderDashboard();
        if(id === 'analitica') renderAnalytics();
        // Si entramos a estrategia, aseguramos que el grid se vea bien
        if(id === 'estrategia') renderHellGrid(); 
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    // ================= MALLA & PPS =================
    function renderMalla() {
        const grid = document.getElementById('malla-grid');
        grid.innerHTML = '';
        for(let i=1; i<=10; i++) {
            const col = document.createElement('div');
            col.className = 'cycle-col';
            col.innerHTML = `<div class="cycle-title">Ciclo ${i}</div>`;
            courses.filter(c => c.c === i).forEach(c => {
                const card = document.createElement('div');
                card.className = `course-card type-${c.t}`;
                card.id = c.id;
                
                const passed = approved.has(c.id);
                const reqMet = c.req.every(r => approved.has(r));

                if(passed) card.classList.add('completed');
                else if(!reqMet) { card.classList.add('locked'); card.title = "Falta requisito: " + c.req.join(', '); }

                let gradeHtml = '';
                if(passed && approvedGrades[c.id]) {
                    gradeHtml = `<div class="grade-badge">${approvedGrades[c.id]}</div>`;
                }

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666">
                        <strong>${c.id}</strong> <span>${c.cr} Cr.</span>
                    </div>
                    <b>${c.name}</b>
                    <div style="font-size:0.75rem; color:#999; margin-top:5px; text-align:right">${c.t==='O'?'Obligatorio':'Electivo'}</div>
                    ${gradeHtml}
                `;
                card.onclick = () => toggleCourse(c, reqMet);
                col.appendChild(card);
            });
            grid.appendChild(col);
        }
    }

    function toggleCourse(c, reqMet) {
        if(approved.has(c.id)) {
            const dep = courses.find(x => x.req.includes(c.id) && approved.has(x.id));
            if(dep) return alert(`No puedes desmarcar ${c.name}, bloquea a ${dep.name}`);
            approved.delete(c.id);
            delete approvedGrades[c.id];
        } else {
            if(!reqMet) return;
            // Ask for grade
            let grade = prompt(`Ingrese nota final para ${c.name} (Opcional, Enter para omitir):`, "14");
            if(grade !== null) {
                approved.add(c.id);
                if(grade.trim() !== "" && !isNaN(grade)) {
                    approvedGrades[c.id] = parseInt(grade);
                }
            } else {
                return; // Cancelled
            }
        }
        localStorage.setItem('unmsm_adm_v11_c', JSON.stringify([...approved]));
        localStorage.setItem('unmsm_adm_v11_g', JSON.stringify(approvedGrades));
        renderMalla();
        updateStats();
    }

    function updateStats() {
        let cr = 0;
        let weightedSum = 0;
        let creditsWithGrade = 0;

        courses.forEach(c => { 
            if(approved.has(c.id)) {
                cr += c.cr;
                if(approvedGrades[c.id]) {
                    weightedSum += approvedGrades[c.id] * c.cr;
                    creditsWithGrade += c.cr;
                }
            } 
        });
        
        const pps = creditsWithGrade > 0 ? (weightedSum / creditsWithGrade).toFixed(2) : "0.00";
        document.getElementById('credits-display').innerText = cr;
        document.getElementById('pps-display').innerText = pps;
        document.getElementById('pps-dashboard').innerText = pps;
    }

    function resetMalla() {
        if(confirm("¬øBorrar todo el progreso?")) {
            localStorage.clear(); location.reload();
        }
    }

    // ================= DASHBOARD & PDF =================
    function renderDashboard() {
        const TOTAL_REQUIRED = 220; 
        let appCr = 0;
        courses.forEach(c => {
            if(approved.has(c.id)) {
                appCr += c.cr;
            }
        });

        let percentage = Math.round((appCr / TOTAL_REQUIRED) * 100);
        let visualPercentage = Math.min(100, percentage);

        document.getElementById('stat-total').innerText = `${appCr} / ${TOTAL_REQUIRED}`;
        document.getElementById('bar-total').style.width = `${visualPercentage}%`;
        
        document.getElementById('chart-text').innerText = appCr >= TOTAL_REQUIRED ? `¬°Meta Cumplida!` : `${percentage}% Completado`;
        
        const remaining = Math.max(0, TOTAL_REQUIRED - appCr);
        const cyclesLeft = Math.ceil(remaining / 21);
        document.getElementById('grad-projection').innerHTML = appCr >= TOTAL_REQUIRED ? 
            "<b style='color:green'>¬°FELICIDADES! Tienes cr√©ditos para egresar.</b>" : 
            `Faltan aprox. <b>${cyclesLeft} ciclos</b> acad√©micos.`;

        const ctx = document.getElementById('progressChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Aprobados', 'Pendientes'],
                datasets: [{
                    data: [Math.min(appCr, TOTAL_REQUIRED), remaining],
                    backgroundColor: [appCr >= TOTAL_REQUIRED ? '#27ae60' : '#8a0303', '#eee'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '70%', plugins: { legend: { display: true, position: 'bottom' } } }
        });
    }

    function exportPDF() {
        const el = document.getElementById('export-content');
        const opt = { margin: 10, filename: 'reporte-academico-unmsm.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().from(el).set(opt).save();
    }

    // ================= ANAL√çTICA MODIFICADO =================
    function renderAnalytics() {
        // 1. PPS POR CICLO
        const cycleLabels = [];
        const cycleData = [];
        
        for(let i=1; i<=10; i++) {
            let sum = 0;
            let count = 0;
            courses.filter(c => c.c === i && approved.has(c.id)).forEach(c => {
                if(approvedGrades[c.id]) {
                    sum += approvedGrades[c.id] * c.cr;
                    count += c.cr;
                }
            });
            if(count > 0) {
                cycleLabels.push(`Ciclo ${i}`);
                cycleData.push((sum/count).toFixed(2));
            }
        }
        
        const ctxPPS = document.getElementById('ppsHistoryChart').getContext('2d');
        if(ppsChartInstance) ppsChartInstance.destroy();
        ppsChartInstance = new Chart(ctxPPS, {
            type: 'line',
            data: {
                labels: cycleLabels,
                datasets: [{
                    label: 'Promedio Ponderado por Ciclo',
                    data: cycleData,
                    borderColor: '#8a0303',
                    backgroundColor: 'rgba(138, 3, 3, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: { scales: { y: { min: 10, max: 20 } }, plugins: { legend: { display: false } } }
        });

        // 2. RADAR SKILLS/BRANCHES
        let counts = {fin:0, mkt:0, rrhh:0, op:0};
        courses.forEach(c => {
            if(approved.has(c.id) && c.tags) {
                c.tags.forEach(t => { if(counts[t]!==undefined) counts[t]++; });
            }
        });
        
        const ctxRadar = document.getElementById('skillsRadarChart').getContext('2d');
        if(skillsRadarInstance) skillsRadarInstance.destroy();
        skillsRadarInstance = new Chart(ctxRadar, {
            type: 'polarArea',
            data: {
                labels: ['Finanzas', 'Marketing', 'RRHH', 'Gesti√≥n/Ops'],
                datasets: [{
                    data: [counts.fin, counts.mkt, counts.rrhh, counts.op],
                    backgroundColor: ['rgba(39, 174, 96, 0.6)', 'rgba(230, 126, 34, 0.6)', 'rgba(142, 68, 173, 0.6)', 'rgba(41, 128, 185, 0.6)']
                }]
            }
        });

        // 3. NUEVO: Comparativa Cr√©ditos por √Årea (Aprobados vs Total)
        // Calculamos totales disponibles
        let totalTags = {fin:0, mkt:0, rrhh:0, op:0};
        courses.forEach(c => {
            if(c.tags) c.tags.forEach(t => { if(totalTags[t]!==undefined) totalTags[t]++; });
        });

        const ctxArea = document.getElementById('areaProgressChart').getContext('2d');
        if(areaProgressInstance) areaProgressInstance.destroy();
        areaProgressInstance = new Chart(ctxArea, {
            type: 'bar',
            data: {
                labels: ['Finanzas', 'Marketing', 'RRHH', 'Gesti√≥n/Ops'],
                datasets: [
                    {
                        label: 'Cursos Aprobados',
                        data: [counts.fin, counts.mkt, counts.rrhh, counts.op],
                        backgroundColor: '#8a0303'
                    },
                    {
                        label: 'Total Disponibles',
                        data: [totalTags.fin, totalTags.mkt, totalTags.rrhh, totalTags.op],
                        backgroundColor: '#e0e0e0'
                    }
                ]
            },
            options: {
                scales: { x: { stacked: true }, y: { stacked: true } }
            }
        });

        // 4. NUEVO: Distribuci√≥n de Notas
        let gradesDist = { excelente:0, bueno:0, regular:0, bajo:0 }; // Ex: 17-20, Bue: 14-16, Reg: 11-13, Bajo: <11
        Object.values(approvedGrades).forEach(g => {
            if(g >= 17) gradesDist.excelente++;
            else if(g >= 14) gradesDist.bueno++;
            else if(g >= 11) gradesDist.regular++;
            else gradesDist.bajo++;
        });

        const ctxGrades = document.getElementById('gradesDistChart').getContext('2d');
        if(gradesDistInstance) gradesDistInstance.destroy();
        gradesDistInstance = new Chart(ctxGrades, {
            type: 'pie',
            data: {
                labels: ['Excelente (17-20)', 'Bueno (14-16)', 'Regular (11-13)', 'Bajo (<11)'],
                datasets: [{
                    data: [gradesDist.excelente, gradesDist.bueno, gradesDist.regular, gradesDist.bajo],
                    backgroundColor: ['#27ae60', '#f1c40f', '#e67e22', '#c0392b']
                }]
            }
        });
    }

    // ================= CALCULADORA =================
    let gradeRowCount = 0;
    function initCalculator() {
        const container = document.getElementById('grades-container');
        if(container.children.length === 0) { addGradeRow(25); addGradeRow(25); addGradeRow(20); }
    }
    function addGradeRow(defWeight = '') {
        gradeRowCount++;
        const container = document.getElementById('grades-container');
        const row = document.createElement('div'); row.className = 'grade-row';
        row.innerHTML = `<span style="font-weight:bold;width:50px;">N${gradeRowCount}</span><input type="number" class="grade-input" placeholder="0-20"><input type="number" class="weight-input" placeholder="%" value="${defWeight}"><span>%</span><button class="btn-del-row" onclick="this.parentElement.remove()">√ó</button>`;
        container.appendChild(row);
    }
    function calculateGrades() {
        const rows = document.querySelectorAll('.grade-row');
        let totalWeighted = 0; let totalWeight = 0;
        rows.forEach(row => {
            const g = parseFloat(row.querySelector('.grade-input').value);
            const w = parseFloat(row.querySelector('.weight-input').value);
            if(!isNaN(g) && !isNaN(w)) { totalWeighted += g*(w/100); totalWeight += w; }
        });
        document.getElementById('res-current-avg').innerText = totalWeighted.toFixed(2);
        const box = document.getElementById('res-analysis');
        const minPass = parseFloat(document.getElementById('calc-min-pass').value) || 11;
        const missing = 100 - totalWeight;
        if(totalWeight > 100) box.innerHTML = "<b style='color:red'>Error: >100%</b>";
        else if(totalWeight === 100) box.innerHTML = totalWeighted >= minPass ? "<b>¬°Aprobado!</b>" : "<b>Desaprobado</b>";
        else {
            const needed = (minPass - totalWeighted) / (missing/100);
            box.innerHTML = needed <= 0 ? "¬°Ya aprobaste!" : needed > 20 ? `Imposible aprobar (Necesitas ${needed.toFixed(1)})` : `Necesitas <b>${needed.toFixed(2)}</b> en el ${missing}% restante.`;
        }
    }
    function resetCalculator() {
        document.getElementById('grades-container').innerHTML = ''; gradeRowCount = 0; initCalculator();
        document.getElementById('res-current-avg').innerText = '0.00'; document.getElementById('res-analysis').innerText = '...';
    }

    // ================= SKILLS =================
    function renderSkills() {
        const grid = document.getElementById('tools-grid'); grid.innerHTML = '';
        skillsDB.sort((a,b) => a.name.localeCompare(b.name));
        skillsDB.forEach(skill => {
            const isChecked = acquiredSkills.has(skill.id);
            const chip = document.createElement('div'); chip.className = `tool-chip ${isChecked ? 'active' : ''}`;
            chip.onclick = () => {
                if(acquiredSkills.has(skill.id)) acquiredSkills.delete(skill.id); else acquiredSkills.add(skill.id);
                localStorage.setItem('unmsm_adm_v11_s', JSON.stringify([...acquiredSkills])); renderSkills();
            };
            chip.innerHTML = `<div class="tool-check">${isChecked ? '‚úì' : ''}</div><span>${skill.name}</span>`;
            grid.appendChild(chip);
        });
        calculateProfiles();
    }
    function calculateProfiles() {
        const sc = {fin:0,mkt:0,rrhh:0,op:0}; const mx = {fin:0,mkt:0,rrhh:0,op:0};
        skillsDB.forEach(s => {
            ['fin','mkt','rrhh','op'].forEach(k => { if(s.weights[k]) { mx[k]+=s.weights[k]; if(acquiredSkills.has(s.id)) sc[k]+=s.weights[k]; }});
        });
        ['fin','mkt','rrhh','op'].forEach(k => {
            const p = mx[k]===0?0:Math.round((sc[k]/mx[k])*100);
            document.getElementById(`pct-${k}`).innerText = `${p}%`; document.getElementById(`bar-${k}`).style.width = `${p}%`;
        });
    }

    // ================= SIMULADOR & EXPORTAR ICS =================
    function initSchedule() {
        const s = document.getElementById('sched-start'); const e = document.getElementById('sched-end');
        s.innerHTML = ''; e.innerHTML = '';
        for(let i=7; i<=22; i++) { let t = (i<10?'0':'')+i+':00'; s.innerHTML+=`<option value="${i}">${t}</option>`; if(i>7) e.innerHTML+=`<option value="${i}">${t}</option>`; }
        e.value = 10; renderScheduleGrid(); renderScheduleItems();
    }
    function updateScheduleDropdowns() {
        const sel = document.getElementById('sched-course'); sel.innerHTML = '';
        const avail = courses.filter(c => !approved.has(c.id) && c.req.every(r => approved.has(r)));
        if(avail.length===0) sel.innerHTML='<option disabled>No hay cursos disponibles</option>';
        else avail.forEach(c => {
            const added = mySchedule.some(s=>s.courseId===c.id);
            sel.innerHTML += `<option value="${c.id}">${added?'‚úÖ ':''}${c.name} (${c.cr} Cr.)</option>`;
        });
    }
    function renderScheduleGrid() {
        const grid = document.getElementById('schedule-grid');
        while(grid.children.length > 7) grid.removeChild(grid.lastChild);
        for(let h=7; h<=22; h++) {
            const t = document.createElement('div'); t.className='grid-time-cell'; t.innerText=`${h}:00`; grid.appendChild(t);
            for(let d=1; d<=6; d++) { const c = document.createElement('div'); c.className='grid-cell'; c.dataset.day=d; c.dataset.hour=h; grid.appendChild(c); }
        }
    }
    function renderScheduleItems() {
        document.querySelectorAll('.course-block').forEach(b => b.remove());
        let total = 0; let unique = new Set();
        mySchedule.forEach(i => unique.add(i.courseId));
        unique.forEach(id => { const c = courses.find(x => x.id===id); if(c) total+=c.cr; });
        document.getElementById('sim-credits').innerText = total;

        mySchedule.forEach((item, idx) => {
            const c = courses.find(x => x.id === item.courseId);
            const cell = document.querySelector(`.grid-cell[data-day="${item.day}"][data-hour="${item.start}"]`);
            if(cell) {
                const b = document.createElement('div'); b.className = 'course-block';
                b.style.height = `${(item.end-item.start)*51 - 2}px`; b.style.background = item.color;
                b.innerHTML = `<div class="remove-course" onclick="removeFromSchedule(${idx})">√ó</div><strong>${c?c.name:item.courseId}</strong><small>${item.start}:00-${item.end}:00</small>`;
                cell.appendChild(b);
            }
        });
    }
    function addToSchedule() {
        const id = document.getElementById('sched-course').value;
        const d = parseInt(document.getElementById('sched-day').value);
        const s = parseInt(document.getElementById('sched-start').value);
        const e = parseInt(document.getElementById('sched-end').value);
        if(!id || s>=e) return alert("Datos inv√°lidos");
        if(mySchedule.some(x => x.day===d && ((s>=x.start && s<x.end) || (e>x.start && e<=x.end) || (s<=x.start && e>=x.end)))) return alert("Cruce de horarios");
        const exist = mySchedule.find(x => x.courseId === id);
        const color = exist ? exist.color : ['#e57373','#f06292','#ba68c8','#9575cd','#7986cb','#64b5f6','#4dd0e1','#4db6ac','#81c784','#ffb74d'][Math.floor(Math.random()*10)];
        mySchedule.push({courseId:id, day:d, start:s, end:e, color});
        localStorage.setItem('unmsm_adm_v11_h', JSON.stringify(mySchedule));
        renderScheduleItems(); updateScheduleDropdowns();
    }
    function removeFromSchedule(i) { mySchedule.splice(i,1); localStorage.setItem('unmsm_adm_v11_h', JSON.stringify(mySchedule)); renderScheduleItems(); updateScheduleDropdowns(); }
    function clearSchedule() { if(confirm("¬øBorrar?")) { mySchedule=[]; localStorage.setItem('unmsm_adm_v11_h', JSON.stringify(mySchedule)); renderScheduleItems(); updateScheduleDropdowns(); } }
    
    function exportSchedulePDF() {
        const el = document.getElementById('schedule-export-area');
        const opt = { margin: 5, filename: 'horario-matricula-unmsm.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
        html2pdf().from(el).set(opt).save();
    }

    // --- NUEVO: FUNCI√ìN PARA GENERAR ICS (GOOGLE CALENDAR) ---
    function downloadICS() {
        if(mySchedule.length === 0) return alert("No hay cursos en el horario para exportar.");
        
        // Helper para formatear fecha a string ICS: YYYYMMDDTHHMMSS
        const formatICSDate = (date) => {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0];
        };

        // Helper para obtener el pr√≥ximo "Lunes" (u otro d√≠a)
        const getNextDayOfWeek = (dayIndex) => {
            const today = new Date();
            const resultDate = new Date(today.getTime());
            // dayIndex: 1=Lun, 6=Sab
            // JS getDay(): 0=Dom, 1=Lun...
            // Ajuste para JS
            const jsDay = dayIndex === 7 ? 0 : dayIndex; 
            
            resultDate.setDate(today.getDate() + (jsDay + 7 - today.getDay()) % 7);
            // Si es hoy, lo movemos a hoy, si ya pas√≥ la hora quiz√°s convenga next week, pero dej√©moslo simple: Pr√≥ximo X dia
            if(today.getDay() === jsDay && today.getHours() > 20) {
                 resultDate.setDate(resultDate.getDate() + 7);
            }
            return resultDate;
        };

        let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//UNMSM//Administracion//ES\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";

        mySchedule.forEach(item => {
            const course = courses.find(c => c.id === item.courseId);
            const title = course ? course.name : "Clase UNMSM";
            
            // Calcular fecha de inicio (pr√≥ximo Lunes/Martes etc)
            let startDate = getNextDayOfWeek(item.day);
            startDate.setHours(item.start, 0, 0, 0);
            
            let endDate = new Date(startDate);
            endDate.setHours(item.end, 0, 0, 0);

            icsContent += "BEGIN:VEVENT\n";
            icsContent += "SUMMARY:" + title + "\n";
            icsContent += "DTSTART:" + formatICSDate(startDate) + "\n";
            icsContent += "DTEND:" + formatICSDate(endDate) + "\n";
            icsContent += "RRULE:FREQ=WEEKLY;COUNT=16\n"; // 16 Semanas de ciclo
            icsContent += "DESCRIPTION:Curso del ciclo acad√©mico.\n";
            icsContent += "LOCATION:UNMSM FCA\n";
            icsContent += "STATUS:CONFIRMED\n";
            icsContent += "END:VEVENT\n";
        });

        icsContent += "END:VCALENDAR";

        // Crear archivo y descargar
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', 'mi_horario_unmsm.ics');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ================= ESTRATEGIA & IA AVANZADA =================

    let deadlineEvents = [];
    // Estructura de evento: { week: 1-16, name: "Parcial", type: 1(Tarea)|2(Trabajo)|3(Examen) }

    // Init Logic for Strategy Page
    function initStrategy() {
        if(localStorage.getItem('unmsm_adm_v11_evts')) {
            deadlineEvents = JSON.parse(localStorage.getItem('unmsm_adm_v11_evts'));
        }
        
        // Poner fecha de inicio por defecto (Lunes actual o 1ro de Mes)
        const savedDate = localStorage.getItem('unmsm_adm_v11_startdate');
        const dateInput = document.getElementById('cycle-start-date');
        if(savedDate) {
            dateInput.value = savedDate;
        } else {
            dateInput.valueAsDate = new Date();
        }

        dateInput.addEventListener('change', (e) => {
            localStorage.setItem('unmsm_adm_v11_startdate', e.target.value);
        });

        renderHellGrid();
    }

    // --- 1. L√ìGICA DEL MAPA DE CALOR (HELL WEEK) ---
    function addHellEvent() {
        const week = parseInt(document.getElementById('evt-week').value);
        const name = document.getElementById('evt-name').value;
        const type = parseInt(document.getElementById('evt-type').value);

        if(!week || !name || week < 1 || week > 16) return alert("Datos inv√°lidos. Semana debe ser 1-16.");

        deadlineEvents.push({ week, name, type });
        deadlineEvents.sort((a,b) => a.week - b.week);
        saveEvents();
        renderHellGrid();
        
        // Disparar IA si la semana se vuelve cr√≠tica
        const weekLoad = deadlineEvents.filter(e => e.week === week).reduce((acc, e) => acc + e.type, 0);
        if(weekLoad >= 5) {
            addAIMessage(`‚ö†Ô∏è <b>¬°Atenci√≥n Estrat√©gica!</b> Acabas de sobrecargar la <b>Semana ${week}</b>. <br>Recomendaci√≥n: Empieza los res√∫menes o avances en la Semana ${Math.max(1, week-2)}.`);
        }
    }

    function removeHellEvent(index) {
        deadlineEvents.splice(index, 1);
        saveEvents();
        renderHellGrid();
    }

    function saveEvents() {
        localStorage.setItem('unmsm_adm_v11_evts', JSON.stringify(deadlineEvents));
    }

    function renderHellGrid() {
        const grid = document.getElementById('hell-grid');
        grid.innerHTML = '';

        for(let w=1; w<=16; w++) {
            const events = deadlineEvents.filter(e => e.week === w);
            const loadScore = events.reduce((acc, e) => acc + e.type, 0);
            
            // Determinar nivel de infierno
            let intensityClass = 'level-0'; 
            if(loadScore >= 2 && loadScore < 5) intensityClass = 'level-1'; 
            if(loadScore >= 5 && loadScore < 8) intensityClass = 'level-2'; 
            if(loadScore >= 8) intensityClass = 'level-3'; 

            let eventsHtml = '';
            deadlineEvents.forEach((evt, idx) => {
                if(evt.week === w) {
                    let icon = evt.type === 3 ? '‚ö°' : (evt.type === 2 ? 'üìù' : 'üìå');
                    eventsHtml += `<div class="event-item"><span>${icon} ${evt.name}</span> <span class="del-evt" onclick="removeHellEvent(${idx})">√ó</span></div>`;
                }
            });

            const box = document.createElement('div');
            box.className = `week-box ${intensityClass}`;
            
            // CORRECCI√ìN AQU√ç: overflow-y: auto para permitir scroll si hay muchos items
            box.innerHTML = `
                <div class="week-header">
                    <span>Semana ${w}</span>
                    <span class="week-score">Carga: ${loadScore}</span>
                </div>
                <div style="flex:1; overflow-y:auto; padding-right:2px;">
                    ${eventsHtml}
                </div>
            `;
            grid.appendChild(box);
        }
    }

    // --- 2. EXPORTAR CALENDARIO DE ENTREGAS (.ICS) ---
    function downloadDeadlinesICS() {
        if(deadlineEvents.length === 0) return alert("No hay fechas de ex√°menes/entregas registradas.");
        
        const startInput = document.getElementById('cycle-start-date').value;
        if(!startInput) return alert("Por favor selecciona la 'Fecha Inicio Ciclo' arriba del mapa de calor.");
        
        const cycleStart = new Date(startInput);
        // Ajustar a zona horaria local para evitar desfaces
        cycleStart.setMinutes(cycleStart.getMinutes() + cycleStart.getTimezoneOffset());

        let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//UNMSM//Strategy//ES\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";

        const formatICSDate = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0];

        deadlineEvents.forEach(evt => {
            // Calcular fecha real: Inicio + (Semana-1)*7 d√≠as
            let eventDate = new Date(cycleStart);
            eventDate.setDate(cycleStart.getDate() + (evt.week - 1) * 7);
            
            // Poner hora por defecto 8:00 AM para ex√°menes
            eventDate.setHours(8, 0, 0, 0);
            let endDate = new Date(eventDate);
            endDate.setHours(10, 0, 0, 0);

            icsContent += "BEGIN:VEVENT\n";
            icsContent += `SUMMARY:[S${evt.week}] ${evt.name} (UNMSM)\n`;
            icsContent += "DTSTART:" + formatICSDate(eventDate) + "\n";
            icsContent += "DTEND:" + formatICSDate(endDate) + "\n";
            icsContent += "DESCRIPTION:Recordatorio estrat√©gico de la Semana del Infierno.\n";
            icsContent += "STATUS:CONFIRMED\n";
            icsContent += "BEGIN:VALARM\nTRIGGER:-PT24H\nACTION:DISPLAY\nDESCRIPTION:Estudiar Ma√±ana\nEND:VALARM\n"; // Alarma 24h antes
            icsContent += "END:VEVENT\n";
        });

        icsContent += "END:VCALENDAR";

        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', 'mis_examenes_unmsm.ics');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- 3. INTELIGENCIA ARTIFICIAL (POLLINATIONS ) ---

    // Funci√≥n auxiliar para leer datos del alumno
    function getGlobalContext() {
        // CORRECCI√ìN: Leemos el texto directo del contador de la cabecera
        const totalCreditos = document.getElementById('credits-display').innerText; 

        return {
            promedio: document.getElementById('pps-dashboard').innerText,
            creditos: totalCreditos, // Ahora env√≠a "83" o "91", no "26"
            cursosFaltantes: courses.length - approved.size,
            
            horario: mySchedule.map(s => {
                let c = courses.find(x=>x.id===s.courseId); 
                const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
                return c ? `${c.name} (${dias[s.day]} ${s.start}:00)` : ""; 
            }).join(', '),
            
            examenes: deadlineEvents.map(e => `Semana ${e.week}: ${e.name} (Tipo: ${e.type===3?'Examen':'Trabajo'})`).join(', '),
            skills: [...acquiredSkills].join(', ')
        };
    }

    function handleChatEnter(e) {
        if(e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('user-msg');
        const text = input.value.trim();
        if(!text) return;

        // 1. Mostrar mensaje del usuario en el chat
        const chat = document.getElementById('chat-history');
        const userDiv = document.createElement('div');
        userDiv.className = 'msg-user';
        userDiv.innerText = text;
        chat.appendChild(userDiv);
        input.value = ''; // Limpiar input
        chat.scrollTop = chat.scrollHeight;

        // 2. Mostrar indicador de carga ("Analizando datos...")
        const loader = document.getElementById('ai-loading');
        loader.style.display = 'block';

        let responseHTML = "";
        const ctx = getGlobalContext();

        // 3. Construir el Prompt para la IA (Instrucciones + Datos del Alumno)
        const systemPrompt = `
            Act√∫a como un Asesor Acad√©mico y Experto en Finanzas de la UNMSM (Universidad Nacional Mayor de San Marcos).
            
            CONTEXTO DEL ALUMNO:
            - PPS (Promedio): ${ctx.promedio} | Cr√©ditos Aprobados: ${ctx.creditos}
            - Cursos Matriculados: ${ctx.horario || "Ninguno"}
            - Pr√≥ximos Ex√°menes: ${ctx.examenes || "Ninguno registrado"}
            - Habilidades: ${ctx.skills || "Ninguna registrada"}

            PREGUNTA DEL ALUMNO: "${text}"

            INSTRUCCIONES DE RESPUESTA:
            - Si es sobre FINANZAS/ADMINISTRACI√ìN: Explica el concepto con profundidad, usa f√≥rmulas si aplica y pon ejemplos de empresas peruanas (Alicorp, BCP, mineras, etc).
            - Si es sobre CONSEJOS: Analiza su carga acad√©mica (horario/ex√°menes) y dale un tip estrat√©gico.
            - Usa formato HTML simple: usa <b>negrita</b> para resaltar y <br> para saltos de l√≠nea. NO uses Markdown.
            - S√© breve pero contundente.
        `;

        try {
            // 4. Conexi√≥n a Pollinations AI (Gratis y sin Key)
            // Codificamos el texto para enviarlo en la URL
            const encodedPrompt = encodeURIComponent(systemPrompt);
            // Agregamos un n√∫mero aleatorio (seed) para que las respuestas var√≠en un poco
            const randomSeed = Math.floor(Math.random() * 1000);
            
            // Usamos el modelo de OpenAI (v√≠a Pollinations)
            const response = await fetch(`https://text.pollinations.ai/${encodedPrompt}?model=openai&seed=${randomSeed}`);
            
            if (!response.ok) throw new Error("Error en el servidor de IA");
            
            let rawText = await response.text();
            
            // 5. Limpieza y Formato
            responseHTML = rawText
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // Convertir negritas MD a HTML por si acaso
                .replace(/###/g, '') // Quitar t√≠tulos grandes MD
                .replace(/\n/g, '<br>'); // Saltos de l√≠nea

        } catch (error) {
            console.error(error);
            responseHTML = `<span style="color:#e74c3c">‚ö†Ô∏è La IA est√° saturada moment√°neamente. Por favor intenta preguntar de nuevo en unos segundos.</span>`;
        }

        // 6. Mostrar respuesta en el chat
        loader.style.display = 'none';
        addAIMessage(responseHTML);
    }

    function addAIMessage(htmlText) {
        const chat = document.getElementById('chat-history');
        const aiDiv = document.createElement('div');
        aiDiv.className = 'msg-ai';
        aiDiv.innerHTML = htmlText;
        chat.appendChild(aiDiv);
        chat.scrollTop = chat.scrollHeight;
    }

    function askAI(type) {
        let text = "";
        if(type === 'finance') text = "Expl√≠came qu√© es el EBITDA, para qu√© sirve y dame un ejemplo con una empresa peruana.";
        if(type === 'risk') text = "Analiza mis datos (horario, ex√°menes, promedio) y dime si estoy en riesgo acad√©mico.";
        if(type === 'email') text = "Redacta un correo formal a mi profesor pidiendo una revisi√≥n de examen.";
        
        document.getElementById('user-msg').value = text;
        sendMessage(); 
    }

    init();
   
</script>
</body>
</html>