<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Acad√©mico Lumin Study</title>
    <!-- Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* Colores UNMSM Light */
            --primary: #8a0303; 
            --accent: #f1c40f; 
            --bg-body: #f4f6f8; 
            --bg-card: #ffffff; 
            --text-main: #2c3e50; 
            --border: #e0e0e0;
            --grid-line: #eee;
            
            /* Colores Ramas */
            --c-fin: #27ae60; --c-mkt: #e67e22; --c-rrhh: #8e44ad; --c-op: #2980b9;
        }

        body.dark-mode {
            /* Colores Dark */
            --primary: #c0392b; 
            --accent: #f39c12; 
            --bg-body: #1a1a2e; 
            --bg-card: #16213e; 
            --text-main: #e0e0e0; 
            --border: #333;
            --grid-line: #2c3e50;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 60px; transition: background 0.3s, color 0.3s; }
        * { box-sizing: border-box; transition: all 0.2s ease; outline: none; }

        /* --- NAV --- */
        .navbar {
            background: var(--primary); color: white; height: 70px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-bottom: 4px solid var(--accent);
        }
        
        .nav-brand { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .nav-logo-img { height: 50px; width: auto; background: white; border-radius: 50%; padding: 2px; }

        /* --- MEN√ö CON BARRA DE DESPLAZAMIENTO VISIBLE --- */
        .nav-menu { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            overflow-x: auto; /* Permite mover a los lados */
            padding-bottom: 5px; 
            max-width: 100%;
            
            /* Para Firefox: Barra finita y blanca */
            scrollbar-width: thin; 
            scrollbar-color: rgba(255,255,255,0.5) transparent;
        }

        /* Para Chrome y Edge: Dise√±o de la barra */
        .nav-menu::-webkit-scrollbar { 
            display: block; /* ¬°AQU√ç EST√Å EL CAMBIO! Antes estaba oculto */
            height: 6px;    /* Altura de la barrita */
        }
        
        .nav-menu::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1); 
        }

        .nav-menu::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.4); /* Color blanco semi-transparente */
            border-radius: 10px;
        }
        
        .nav-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.8); /* Brilla si pones el mouse encima */
        }

        .nav-btn { 
            background: rgba(255,255,255,0.1); border: none; color: white; 
            padding: 8px 15px; cursor: pointer; border-radius: 20px; 
            display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 0.9rem;
            
            /* TRUCO EXTRA: Esto evita que los botones se aplasten o se pongan en dos l√≠neas */
            white-space: nowrap; 
            flex-shrink: 0;
        }
        
        .nav-btn:hover, .nav-btn.active { background: white; color: var(--primary); }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; margin-left: 10px; flex-shrink: 0; }
        /* --- LAYOUT --- */
        .page-section { display: none; padding: 25px; max-width: 1800px; margin: 0 auto; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MALLA STYLES --- */
        .malla-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg-card); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid var(--primary); }
        .malla-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 30px; align-items: flex-start; }
        .cycle-col { min-width: 250px; max-width: 250px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
        .cycle-title { text-align: center; background: #333; color: white; padding: 8px; border-radius: 4px; font-weight: bold; border-bottom: 3px solid var(--accent); }
        
        .course-card { background: var(--bg-card); border: 1px solid var(--border); border-left: 5px solid #999; padding: 10px; border-radius: 6px; cursor: pointer; min-height: 85px; font-size: 0.85rem; position: relative; }
        .course-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .course-card.completed { background: #e8f5e9; border-color: var(--primary); border-left-color: var(--primary); }
        .course-card.locked { opacity: 0.6; background: #f5f5f5; cursor: not-allowed; filter: grayscale(1); }
        .course-card.completed::after { content: '‚úî'; position: absolute; top: 5px; right: 5px; color: var(--primary); font-weight: bold; }
        
        body.dark-mode .course-card.completed { background: #1b4d3e; color: #fff; }
        body.dark-mode .course-card.locked { background: #222; opacity: 0.4; }

        .type-O { border-left-color: var(--primary); } 
        .type-E { border-left-color: var(--accent); }
        
        .grade-badge { position: absolute; bottom: 5px; right: 5px; background: #333; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }

        /* --- DASHBOARD PROGRESO --- */
        .dashboard-container { display: grid; grid-template-columns: 1fr 350px; gap: 25px; margin-bottom: 30px; }
        .chart-card { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
        .stats-card { background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .stat-row { margin-bottom: 20px; }
        .stat-label { display: flex; justify-content: space-between; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: #777; }
        .stat-bar-bg { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; }
        .stat-bar-fill { height: 100%; transition: width 1s ease; border-radius: 6px; }
        
        .projection-box { margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 5px solid #2196f3; border-radius: 4px; color: #333; }
        .projection-title { font-weight: bold; color: #1565c0; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        body.dark-mode .projection-box { background: #1a2639; color: #eee; }
        
        .btn-export { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; margin-top: 20px; width: 100%; justify-content: center; }
        .btn-export:hover { background: #000; }
        .btn-ics { background: #2980b9; }
        .btn-ics:hover { background: #1c5980; }

        /* --- ANALITICA STYLES MODIFICADO --- */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* --- SKILLS STYLES --- */
        .profile-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .profile-card { padding: 15px; border-radius: 8px; background: #fafafa; border: 1px solid var(--border); }
        body.dark-mode .profile-card { background: #252a40; }
        .profile-title { font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .profile-percent { font-size: 2rem; font-weight: bold; float: right; margin-top: -35px; opacity: 0.2; }
        .profile-bar-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .profile-bar-fill { height: 100%; width: 0%; transition: width 0.6s ease; }
        .tools-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .tool-chip { background: var(--bg-card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tool-chip.active { background: #e3f2fd; border-color: #2196f3; color: #0d47a1; font-weight: 600; }
        .tool-check { width: 18px; height: 18px; border-radius: 4px; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; flex-shrink: 0; }
        .tool-chip.active .tool-check { background: #2196f3; border-color: #2196f3; }

        /* --- SIMULADOR STYLES --- */
        .scheduler-container { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
        .scheduler-controls { flex: 1; min-width: 300px; background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid var(--accent); }
        .scheduler-grid-wrapper { flex: 3; min-width: 600px; overflow-x: auto; background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .form-select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; background: var(--bg-card); color: var(--text-main); }
        .btn-add { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .time-grid { display: grid; grid-template-columns: 60px repeat(6, 1fr); border: 1px solid var(--border); }
        .grid-header { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; }
        .grid-time-cell { border-bottom: 1px solid var(--grid-line); border-right: 1px solid var(--grid-line); height: 50px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #666; background: rgba(0,0,0,0.02); }
        .grid-cell { border-bottom: 1px solid var(--grid-line); border-right: 1px solid var(--grid-line); height: 50px; position: relative; }
        .course-block { position: absolute; width: 95%; left: 2.5%; padding: 5px; border-radius: 4px; color: white; font-size: 0.75rem; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .remove-course { position: absolute; top: 2px; right: 2px; cursor: pointer; font-weight: bold; font-size: 10px; background: rgba(0,0,0,0.2); border-radius: 50%; width: 15px; height: 15px; line-height: 15px; }

        /* --- CALCULADORA STYLES --- */
        .calc-wrapper { display: flex; gap: 30px; flex-wrap: wrap; }
        .calc-inputs { flex: 1; min-width: 320px; background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .calc-results { flex: 1; min-width: 320px; background: #fffbe6; border: 2px solid #ffe58f; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; position: relative; color:#333; }
        body.dark-mode .calc-results { background: #2c2c2c; border-color: #444; color: #eee; }
        
        .grade-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; animation: fadeIn 0.3s; }
        .grade-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .weight-input { width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .btn-del-row { color: #c0392b; cursor: pointer; padding: 5px; background: none; border: none; font-weight: bold; font-size: 1.2rem; }
        
        .btn-calc-action { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-calc-main { background: #4a148c; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; font-size: 1.1rem; }
        .result-big { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }

        @media (max-width: 768px) {
            .navbar { flex-direction: column; height: auto; padding: 10px; }
            .nav-menu { margin-top: 10px; flex-wrap: wrap; justify-content: center; }
            .scheduler-container, .dashboard-container, .calc-wrapper, .analytics-grid { grid-template-columns: 1fr; flex-direction: column; }
            .scheduler-grid-wrapper { min-width: 100%; }
        }

        /* --- MEJORAS VISUALES CORREGIDAS --- */

        /* Centrar los gr√°ficos canvas dentro de las tarjetas */
        .chart-card canvas {
            margin: 0 auto; 
            display: block;
        }

        /* Arreglo de contraste en Modo Oscuro para Anal√≠tica */
        body.dark-mode .chart-card {
            color: #e0e0e0; /* Texto claro */
        }
        body.dark-mode .chart-card h3 {
    color: var(--accent); /* T√≠tulos en color acento */
        }
        body.dark-mode .chart-card small {
            color: #aaa; /* Subt√≠tulos legibles */
        }

        /* Arreglo para que los inputs del simulador se vean bien en modo oscuro/claro */
        .form-select option {
            background: var(--bg-card);
            color: var(--text-main);
        }

        /*  ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è EL C√ìDIGO ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è */

        /* --- COMUNIDAD STYLES --- */
        .repo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .repo-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; }
        .repo-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        
        .repo-header { height: 100px; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; }
        .repo-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        
        .repo-uni { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; color: #888; margin-bottom: 5px; }
        .repo-career { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; color: var(--text-main); line-height: 1.3; }
        .repo-stats { font-size: 0.85rem; color: #666; margin-bottom: 20px; display: flex; gap: 15px; }
        
        .btn-load-repo { width: 100%; background: var(--text-main); color: var(--bg-card); border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: auto; transition: opacity 0.2s; }
        .btn-load-repo:hover { opacity: 0.8; }


        /* =========================================
       ESTILOS DEL GENERADOR AUTOM√ÅTICO (IA)
       ========================================= */
       .gen-course-box { 
        border: 1px solid #ddd; 
        padding: 15px; 
        border-radius: 8px; 
        background: #fafafa; 
        position: relative; 
        border-left: 4px solid var(--accent);
        transition: transform 0.2s;
        }
        .gen-course-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .gen-course-box h4 { 
        margin: 0 0 10px 0; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        }
        .gc-name {
        font-size: 1rem;
        padding: 5px;
        border: 1px solid #ccc; /* Borde suave */
        border-radius: 4px;
        width: 70%;
        background: white;
        }
        .gc-sections {
        display: flex;
        flex-direction: column;
        gap: 5px;
        }
        .gen-section-row { 
        display: flex; 
        gap: 5px; 
        align-items: center; 
        background: white; 
        padding: 8px; 
        border: 1px solid #eee; 
        border-radius: 4px; 
        flex-wrap: wrap; /* Para m√≥viles */
        }
        .gen-del-btn { 
        color: #c0392b; 
        cursor: pointer; 
        font-weight: bold; 
        background: none; 
        border: none; 
        font-size: 1.2rem;
        padding: 0 5px;
        }
        .gen-mini-block { 
        position: absolute; 
        color: white; 
        font-size: 0.55rem; 
        padding: 2px; 
        border-radius: 2px; 
        overflow: hidden; 
        line-height: 1.1;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        z-index: 10;
        }

        /*  ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è  fin del c√≥digo ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è */
    </style>
</head>
<body>

    <!-- ========================================== -->
    <!-- PANTALLA DE LOGIN CON GOOGLE (FIREBASE)  -->
    <!-- ========================================== -->
    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#8a0303; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; transition:opacity 0.5s;">
        <div style="background:white; padding:40px; border-radius:15px; text-align:center; color:#333; box-shadow:0 10px 30px rgba(0,0,0,0.3); max-width:400px; width:90%;">
            <img src="unmsm.png" style="height:80px; margin-bottom:20px;">
            <h2 style="margin:0 0 10px 0; color:#8a0303;">Acceso Restringido</h2>
            <p style="margin-bottom:25px; color:#666;">Ingresa con tu correo autorizado.</p>
            
            <button id="btn-login-google" style="background:#4285F4; color:white; border:none; padding:12px 25px; border-radius:50px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size:1rem; box-shadow:0 2px 5px rgba(0,0,0,0.2); width:100%;">
              
              Iniciar sesi√≥n con Google
            </button>
            <p id="login-error" style="color:red; margin-top:15px; font-size:0.9rem; display:none; font-weight:bold;"></p>
        </div>
        <div style="margin-top:20px; font-size:0.8rem; opacity:0.7;">Esta plataforma es una herramienta de organizaci√≥n personal. No es una p√°gina oficial de la universidad</div>
    </div>
    <!-- ========================================== -->
     
    <nav class="navbar">
        <div class="nav-brand">
            <!-- MODIFICACI√ìN: IMAGEN UNMSM -->
            <img src="unmsm.png" alt="UNMSM" class="nav-logo-img">
            <span>Lumin Study</span>
        </div>
        <div class="nav-menu">
            <button class="nav-btn" onclick="showPage('config')"><span class="material-icons">school</span> Mi Carrera</button>
            <button class="nav-btn" onclick="showPage('estrategia')"><span class="material-icons">psychology_alt</span> Estrategia IA</button>
            <button class="nav-btn active" onclick="showPage('malla')"><span class="material-icons">grid_view</span> Malla</button>
            <button class="nav-btn" onclick="showPage('progreso')"><span class="material-icons">trending_up</span> Progreso</button>
            <button class="nav-btn" onclick="showPage('analitica')"><span class="material-icons">analytics</span> Anal√≠tica</button>
            <button class="nav-btn" onclick="showPage('calculadora')"><span class="material-icons">calculate</span> Notas</button>
            <button class="nav-btn" onclick="showPage('skills')"><span class="material-icons">psychology</span> Skills</button>
            <button class="nav-btn" onclick="showPage('simulador')"><span class="material-icons">schedule</span> Simulador</button>
            <button class="nav-btn" onclick="showPage('recursos')"><span class="material-icons">link</span> Recursos</button>

            <!-- NUEVO BOT√ìN COMUNIDAD -->
            <button class="nav-btn" onclick="showPage('comunidad')"><span class="material-icons">public</span> Comunidad</button>
            
            <button class="nav-btn" onclick="showPage('subirjson')"><span class="material-icons">upload_file</span> Cargar Datos</button>
            
            <button class="icon-btn" onclick="toggleTheme()" title="Modo Oscuro"><span class="material-icons">dark_mode</span></button>

            <!-- Bot√≥n Salir -->
            <button class="icon-btn" onclick="logout()" title="Cerrar Sesi√≥n">
               <span class="material-icons" style="color: #ffcccc;">logout</span>
            </button>
        </div>
    </nav>

    <!-- ========================================== -->
    <!-- P√ÅGINA 11: GESTI√ìN DE DATOS (REDISE√ëADA) -->
    <!-- ========================================== -->
    <div id="page-subirjson" class="page-section">
        <div style="max-width: 1000px; margin: 0 auto;">
            
            <h2 style="text-align:center; margin-bottom:10px;">‚òÅÔ∏è Centro de Carga y Publicaci√≥n</h2>
            <p style="text-align:center; color:#666; margin-bottom:30px;">Comparte tu malla con la comunidad o carga un c√≥digo existente.</p>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:30px;">
                
                <!-- COLUMNA IZQUIERDA: PUBLICAR (SUBIR A LA COMUNIDAD) -->
                <div class="stats-card" style="border-top: 5px solid var(--primary); background: #fff;">
                    <h3 style="color: var(--primary);">üì§ Publicar Aporte</h3>
                    <p style="font-size:0.85rem; color:#666;">Llena los datos para que otros alumnos encuentren tu malla en la pesta√±a "Comunidad".</p>
                    
                    <div style="margin-bottom:15px;">
                        <label class="form-label">Universidad (Siglas):</label>
                        <input type="text" id="pub-uni" class="form-select" placeholder="Ej: UNMSM, U. LIMA, UPC...">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label class="form-label">Carrera Profesional:</label>
                        <input type="text" id="pub-career" class="form-select" placeholder="Ej: Ingenier√≠a Industrial">
                    </div>

                    <div style="margin-bottom:15px;">
                        <label class="form-label">C√≥digo JSON de la Malla:</label>
                        <textarea id="pub-json-area" style="width:100%; height:80px; border:1px solid #ccc; font-family:monospace; font-size:0.75rem; padding:10px; border-radius:6px; resize:vertical;" placeholder="Aqu√≠ aparecer√° tu c√≥digo..."></textarea>
                        
                        <!-- BOT√ìN M√ÅGICO: Extrae los datos actuales -->
                        <button onclick="fillJsonWithCurrent()" style="margin-top:5px; width:100%; background:#555; color:white; border:none; padding:8px; cursor:pointer; border-radius:4px; font-size:0.8rem; display:flex; align-items:center; justify-content:center; gap:5px;">
                            <span class="material-icons" style="font-size:14px">content_copy</span> Pegar mi Malla Actual Autom√°ticamente
                        </button>
                    </div>

                    <button class="btn-calc-main" style="background:var(--primary); margin-top:10px;" onclick="publishToCommunity()">
                        üöÄ PUBLICAR EN COMUNIDAD
                    </button>
                </div>

                <!-- COLUMNA DERECHA: CARGAR (IMPORTAR C√ìDIGO) -->
                <div class="stats-card" style="border-top: 5px solid var(--accent); background: #fff;">
                    <h3 style="color: #d35400;">üì• Cargar Respaldo</h3>
                    <p style="font-size:0.85rem; color:#666;">Si tienes un c√≥digo que te pas√≥ un amigo o guardaste antes, p√©galo aqu√≠.</p>
                    
                    <div style="margin-bottom:15px;">
                        <label class="form-label">Pegar C√≥digo JSON:</label>
                        <textarea id="import-json-area" style="width:100%; height:150px; border:1px solid #ccc; font-family:monospace; font-size:0.75rem; padding:10px; background:#fafafa; border-radius:6px; resize:vertical;" placeholder='Ejemplo: [{"id":"MAT1", "name":"Matem√°tica"...}]'></textarea>
                    </div>

                    <button class="btn-calc-main" style="background:var(--text-main); color:white;" onclick="loadFromTextArea()">
                        üíæ CARGAR Y GUARDAR
                    </button>
                    
                    <div style="margin-top:15px; padding:10px; background:#ffebee; border-radius:6px; color:#c62828; font-size:0.8rem; display:flex; gap:10px; align-items:center;">
                        <span class="material-icons">warning</span>
                        <span><b>Advertencia:</b> Al cargar un c√≥digo nuevo, se borrar√°n tus notas actuales y se reemplazar√° tu malla.</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- P√ÅGINA 1: MALLA -->
    <div id="page-malla" class="page-section active">
        <div class="malla-header">
            <div>
                <span style="font-size:1.5rem; font-weight:bold; color:var(--primary)" id="credits-display">0</span>
                <small>Cr√©ditos | </small>
                <span style="font-size:1.5rem; font-weight:bold; color:var(--c-op)" id="pps-display">0.00</span>
                <small>P.P.S. Aprox</small>
            </div>
            <div style="font-size:0.9rem; color:#666;">
                <span style="display:inline-block; width:10px; height:10px; background:var(--primary);"></span> Obligatorio
                <span style="display:inline-block; width:10px; height:10px; background:var(--accent); margin-left:10px;"></span> Electivo
            </div>
            <div>
                <button onclick="resetMalla()" style="background:#c0392b; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Reiniciar Todo</button>
            </div>
        </div>
        <div class="malla-container" id="malla-grid"></div>
    </div>

    <!-- P√ÅGINA 2: DASHBOARD PROGRESO -->
    <div id="page-progreso" class="page-section">
        <div id="export-content">
            <h2 style="text-align:center; margin-bottom:20px;">Reporte de Progreso Acad√©mico</h2>
            
            <div class="dashboard-container">
                <!-- Gr√°fico Dona -->
                <div class="chart-card">
                    <h3>Avance para Egresar</h3>
                    <div style="height:250px; width:250px;">
                        <canvas id="progressChart"></canvas>
                    </div>
                    <p style="margin-top:15px; font-weight:bold; color:var(--primary);" id="chart-text">0% Completado</p>
                </div>

                <!-- Estad√≠sticas y Proyecci√≥n (EDITABLE) -->
                <div class="stats-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0;">Metas Acad√©micas</h3>
                        <button onclick="toggleGoalsEdit()" style="background:none; border:none; color:#666; cursor:pointer; text-decoration:underline; font-size:0.8rem;">
                            <span class="material-icons" style="font-size:1rem; vertical-align:middle;">edit</span> Editar
                        </button>
                    </div>

                    <!-- Inputs de Configuraci√≥n (Ocultos por defecto, se abren con el bot√≥n) -->
                    <div id="goals-config-area" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #eee;">
                        <div style="margin-bottom:10px;">
                            <label style="font-size:0.8rem; font-weight:bold;">Meta Total Cr√©ditos:</label>
                            <input type="number" id="config-total-credits" value="220" style="width:100%; padding:5px; border:1px solid #ccc; border-radius:4px;" onchange="saveDashboardSettings()">
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold;">Promedio Cr√©ditos x Ciclo:</label>
                            <input type="number" id="config-cycle-credits" value="21" style="width:100%; padding:5px; border:1px solid #ccc; border-radius:4px;" onchange="saveDashboardSettings()">
                        </div>
                    </div>
                    
                    <p style="font-size:0.8rem; color:#666;">Progreso basado en tu meta de <b id="lbl-total-goal">220</b> cr√©ditos.</p>
                    
                    <div class="stat-row">
                        <div class="stat-label"><span>Progreso Real</span> <span id="stat-total">0 / 220</span></div>
                        <div class="stat-bar-bg"><div class="stat-bar-fill" id="bar-total" style="width:0%; background:var(--primary);"></div></div>
                    </div>

                    <div class="projection-box">
                        <div class="projection-title"><span class="material-icons">timer</span> Tiempo Restante</div>
                        <p id="grad-projection" style="font-size:1.1rem; margin:0; font-weight:500;">Calculando...</p>
                        <small style="display:block; margin-top:5px; opacity:0.8;" id="lbl-cycle-projection">*C√°lculo basado en 21 cr√©ditos por ciclo.</small>
                    </div>
                    
                    <div style="margin-top:20px; text-align:center; padding:15px; background:rgba(0,0,0,0.03); border-radius:8px;">
                        <div style="font-size:2rem; font-weight:bold; color:var(--primary)" id="pps-dashboard">0.00</div>
                        <small>Promedio Ponderado Acumulado Estimado</small>
                    </div>
                </div>
            </div>
        </div>
        <!-- MODIFICACI√ìN: SE ELIMIN√ì BOT√ìN CV -->
        <div style="display:flex; gap:10px; justify-content: center;">
            <button class="btn-export" onclick="exportPDF()"><span class="material-icons">picture_as_pdf</span> Descargar Reporte Completo</button>
        </div>
    </div>

    <!-- P√ÅGINA 2.5: ANAL√çTICA (MODIFICADO) -->
    <div id="page-analitica" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Inteligencia de Negocios Personal</h2>
        
        <div class="analytics-grid">
            <!-- Gr√°fico Lineal: Rendimiento por Ciclo -->
            <div class="chart-card">
                <h3>Historial de Promedio (PPS) por Ciclo</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="ppsHistoryChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico Polar/Pie: Distribuci√≥n de Cursos -->
            <div class="chart-card">
                <h3>Perfil de Especializaci√≥n</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="skillsRadarChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Basado en cursos aprobados de cada rama.</small>
            </div>
            
            <!-- NUEVO: Comparativa por √Åreas -->
            <div class="chart-card">
                <h3>Avance de Cr√©ditos por √Årea</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="areaProgressChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Cr√©ditos aprobados vs Total disponible por rama.</small>
            </div>

            <!-- NUEVO: Distribuci√≥n de Notas -->
            <div class="chart-card">
                <h3>Distribuci√≥n de Rendimiento</h3>
                <div style="height:250px; width:100%;">
                    <canvas id="gradesDistChart"></canvas>
                </div>
                <small style="color:#666; margin-top:10px;">Clasificaci√≥n de notas obtenidas.</small>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 3: CALCULADORA -->
    <div id="page-calculadora" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">Calculadora de Notas</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Proyecta tu nota final ingresando tus calificaciones parciales.</p>

        <div class="calc-wrapper">
            <div class="calc-inputs">
                <div id="grades-container"></div>
                <button class="btn-calc-action" onclick="addGradeRow()">+ Agregar nota</button>
                <div style="margin-top:25px; padding-top:15px; border-top:1px solid #eee;">
                    <label class="form-label">Nota Aprobatoria (UNMSM):</label>
                    <input type="number" id="calc-min-pass" class="form-select" value="11" style="text-align:center; font-weight:bold;">
                </div>
                <button class="btn-calc-main" onclick="calculateGrades()">Calcular Promedio</button>
                <button onclick="resetCalculator()" style="width:100%; margin-top:10px; background:none; border:none; text-decoration:underline; cursor:pointer; color:#777;">Limpiar datos</button>
            </div>

            <div class="calc-results">
                <h3>Resultados</h3>
                <div style="margin-bottom:10px; font-size:0.9rem; opacity:0.8;">Promedio Actual:</div>
                <div id="res-current-avg" class="result-big">0.00</div>
                <div id="res-analysis" style="font-size:1.1rem; line-height:1.5;">Ingresa tus notas...</div>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 4: SKILLS DASHBOARD (DIN√ÅMICO Y UNIVERSAL) -->
    <div id="page-skills" class="page-section">
        <!-- Encabezado con bot√≥n de configuraci√≥n -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; text-align:center;">Perfil Profesional & Competencias</h2>
            <button onclick="toggleSkillConfig()" class="btn-export" style="width:auto; margin:0; background:var(--text-main);">
                <span class="material-icons">settings</span> Configurar Skills
            </button>
        </div>

        <!-- PANEL DE CONFIGURACI√ìN (OCULTO POR DEFECTO) -->
        <div id="skills-config-panel" style="display:none; background:#fff; padding:20px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:25px; border-left:5px solid var(--accent);">
            <h3 style="margin-top:0;">üõ†Ô∏è Gestor de Habilidades</h3>
            <p style="font-size:0.9rem; color:#666;">Agrega las herramientas t√©cnicas de TU carrera y as√≠gnales un peso seg√∫n qu√© tanto impactan en tus especialidades.</p>

            <!-- FORMULARIO MANUAL -->
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; align-items:end;">
                <div>
                    <label class="form-label">Nombre de la Habilidad:</label>
                    <input type="text" id="new-skill-name" class="form-select" placeholder="Ej: Autocad, Suturas, Java...">
                </div>
                <div>
                    <label class="form-label">Impacta en el √Årea:</label>
                    <select id="new-skill-area" class="form-select">
                        <!-- SE LLENA CON JS BASADO EN TUS AREAS -->
                    </select>
                </div>
                <div>
                    <label class="form-label">Nivel de Impacto:</label>
                    <select id="new-skill-weight" class="form-select">
                        <option value="1">Bajo (1 pt)</option>
                        <option value="2">Medio (2 pts)</option>
                        <option value="3">Alto (3 pts)</option>
                    </select>
                </div>
                <button onclick="addNewSkill()" class="btn-add" style="height:42px;">+ AGREGAR</button>
            </div>

            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">

            <!-- ZONA INTELIGENTE (IA) -->
            <div style="background:#e3f2fd; padding:15px; border-radius:8px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                <div>
                    <strong style="color:#1565c0;"><span class="material-icons" style="vertical-align:middle">psychology</span> Asistente IA</strong>
                    <span style="font-size:0.85rem; color:#555; display:block;">¬øSin ideas? La IA leer√° tus √°reas y sugerir√° 5 skills clave.</span>
                </div>
                <button onclick="suggestSkillsWithAI()" class="btn-calc-action" style="background:#1565c0; margin:0;">
                    ‚ú® Sugerir Skills Autom√°ticamente
                </button>
            </div>
            
            <div style="margin-top:15px; text-align:right;">
                 <button onclick="resetSkillsDB()" style="color:#c0392b; background:none; border:none; text-decoration:underline; cursor:pointer;">‚ö†Ô∏è Borrar todo y empezar de cero</button>
            </div>
        </div>

        <!-- DASHBOARD DE BARRAS (SE LLENA SOLO CON JAVASCRIPT) -->
        <div id="dynamic-profile-dashboard" class="profile-dashboard">
            <!-- AQU√ç SE INYECTAN LAS BARRAS AUTOM√ÅTICAMENTE -->
        </div>

        <h3 style="margin-bottom:15px; color:#555;">Marcar Herramientas Dominadas:</h3>
        
        <!-- CHIPS DE SKILLS (SE LLENA SOLO CON JAVASCRIPT) -->
        <div class="tools-container" id="tools-grid">
            <!-- AQU√ç SE INYECTAN LOS BOTONES AUTOM√ÅTICAMENTE -->
        </div>
    </div>

    <!-- P√ÅGINA 5: SIMULADOR HORARIO -->
    <div id="page-simulador" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
            <h2 style="margin:0;">Simulador de Matr√≠cula</h2>
            <div style="display:flex; gap:10px;">
                <!-- BOT√ìN ICS GOOGLE CALENDAR -->
                <button class="btn-export btn-ics" style="margin:0; font-size:0.9rem;" onclick="downloadICS()">
                    <span class="material-icons">event</span> Exportar Google Calendar
                </button>
                <button class="btn-export" style="margin:0; font-size:0.9rem;" onclick="exportSchedulePDF()">
                    <span class="material-icons">download</span> Descargar PDF
                </button>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- NUEVO: GENERADOR AUTOM√ÅTICO DE HORARIOS (IA) -->
        <!-- ========================================== -->
        <div style="margin-bottom: 20px;">
            <button onclick="toggleGenerator()" style="background: var(--accent); color: #333; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons">auto_awesome</span> Abrir Generador Autom√°tico
            </button>

            <div id="generator-panel" style="display: none; margin-top: 15px; background: #fff; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-top:0;">Generador de Combinaciones</h3>
                <p style="font-size:0.9rem; color:#666;">Agrega los cursos y sus posibles horarios (secciones). El sistema buscar√° la combinaci√≥n perfecta que no tenga cruces.</p>
                
                <!-- √ÅREA 1: DEFINIR CURSOS Y HORARIOS -->
                <div id="gen-inputs-container" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <!-- Aqu√≠ se agregan las cajitas con JS -->
                </div>

                <button onclick="addGenCourse()" style="background: #eee; border: 1px dashed #999; padding: 10px; width: 100%; cursor: pointer; border-radius: 6px; font-weight: bold; color: #555;">
                    + Agregar Curso al Generador
                </button>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;">

                <!-- √ÅREA 2: BOT√ìN M√ÅGICO -->
                <button onclick="runGenerator()" style="width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                    ‚ú® CALCULAR MEJORES HORARIOS
                </button>

                <!-- √ÅREA 3: RESULTADOS -->
                <div id="gen-results-area" style="display: none; margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <button onclick="prevSchedule()" class="nav-btn" style="background:#555;">‚óÄ Anterior</button>
                        <strong id="gen-counter-display">Opci√≥n 1 de 5</strong>
                        <button onclick="nextSchedule()" class="nav-btn" style="background:#555;">Siguiente ‚ñ∂</button>
                    </div>
                    
                    <!-- Mini visualizador del horario generado -->
                    <div id="gen-preview-grid" style="border: 1px solid #ccc; background: white; height: 300px; position: relative; overflow-y: auto;">
                        <!-- Se dibuja con JS -->
                    </div>

                    <button onclick="applyGeneratedSchedule()" style="width: 100%; margin-top: 15px; background: #27ae60; color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                        ‚úÖ Usar este Horario
                    </button>
                </div>
            </div>
        </div>
        <!-- FIN DEL GENERADOR -->
        
        <div class="scheduler-container">
            <!-- COLUMNA IZQUIERDA: CONTROLES MANUALES -->
            <div class="scheduler-controls">
                <h3>Agregar Curso</h3>
                <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Filtra y selecciona tus cursos.</p>
                
                <!-- 1. FILTRO POR CICLO -->
                <div class="form-group">
                    <label class="form-label">Filtrar por Ciclo:</label>
                    <select id="sched-cycle-filter" class="form-select" onchange="updateScheduleDropdowns()">
                        <option value="all">Todos los ciclos</option>
                        <option value="1">Ciclo 1</option><option value="2">Ciclo 2</option>
                        <option value="3">Ciclo 3</option><option value="4">Ciclo 4</option>
                        <option value="5">Ciclo 5</option><option value="6">Ciclo 6</option>
                        <option value="7">Ciclo 7</option><option value="8">Ciclo 8</option>
                        <option value="9">Ciclo 9</option><option value="10">Ciclo 10</option>
                    </select>
                </div>

                <!-- 2. SELECTOR DE CURSO -->
                <div class="form-group">
                    <label class="form-label">Curso:</label>
                    <select id="sched-course" class="form-select"></select>
                </div>

                <!-- 3. SELECTOR DE D√çA -->
                <div class="form-group">
                    <label class="form-label">D√≠a:</label>
                    <select id="sched-day" class="form-select">
                        <option value="1">Lunes</option>
                        <option value="2">Martes</option>
                        <option value="3">Mi√©rcoles</option>
                        <option value="4">Jueves</option>
                        <option value="5">Viernes</option>
                        <option value="6">S√°bado</option>
                    </select>
                </div>

                <!-- 4. HORAS -->
                <div class="form-group" style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label class="form-label">Inicio:</label>
                        <input type="time" id="sched-start" class="form-select" value="08:00">
                    </div>
                    <div style="flex:1">
                        <label class="form-label">Fin:</label>
                        <input type="time" id="sched-end" class="form-select" value="10:00">
                    </div>
                </div>

                <!-- 5. CR√âDITOS Y BOTONES -->
                <div style="margin-bottom:20px; padding:10px; background:rgba(0,0,0,0.05); border-radius:8px;">
                    <strong>Cr√©ditos: </strong> <span id="sim-credits">0</span>
                </div>
                <button class="btn-add" onclick="addToSchedule()">AGREGAR</button>
                <button onclick="clearSchedule()" style="width:100%; margin-top:10px; background:none; border:1px solid #ccc; padding:10px; border-radius:6px; cursor:pointer; color:var(--text-main);">Limpiar</button>
            </div>

            <!-- COLUMNA DERECHA: LA TABLA DEL HORARIO -->
            <div class="scheduler-grid-wrapper" id="schedule-export-area">
                <div class="time-grid" id="schedule-grid">
                    <div class="grid-header">Hora</div><div class="grid-header">Lun</div><div class="grid-header">Mar</div><div class="grid-header">Mi√©</div><div class="grid-header">Jue</div><div class="grid-header">Vie</div><div class="grid-header">S√°b</div>
                </div>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA 6: RECURSOS -->
    <div id="page-recursos" class="page-section">
        <h2 style="text-align:center; margin-bottom:20px;">Recursos Institucionales</h2>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
            <a href="https://sum.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #8a0303; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">SUM</h3><p style="font-size:0.85rem; color:#666;">Sistema √önico de Matr√≠cula</p>
                </div>
            </a>
            <a href="https://sisbib.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #2980b9; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">Biblioteca</h3><p style="font-size:0.85rem; color:#666;">Repositorio y Tesis</p>
                </div>
            </a>
            <a href="https://administracion.unmsm.edu.pe/" target="_blank" style="text-decoration:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:10px; border-left:5px solid #27ae60; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <h3 style="margin:0; color:var(--text-main);">Facultad</h3><p style="font-size:0.85rem; color:#666;">Web FCA UNMSM</p>
                </div>
            </a>
        </div>
        <div style="margin-top:30px; background:rgba(255, 193, 7, 0.2); padding:20px; border-radius:8px; border:1px solid rgba(255, 193, 7, 0.5);">
            <h4 style="margin-top:0; color:#b7791f;"><span class="material-icons" style="vertical-align:middle">info</span> Tips para Matr√≠cula</h4>
            <ul style="margin-bottom:0; padding-left:20px; font-size:0.9rem; color:#b7791f;">
                <li>Para matr√≠cula regular necesitas un PPS aprobado (>11).</li>
                <li>Los cursos electivos requieren m√≠nimo 20 alumnos para abrirse.</li>
                <li>Valida tus pr√°cticas pre-profesionales a partir del 8vo ciclo.</li>
            </ul>
        </div>
    </div>

    <!-- P√ÅGINA 9: CONFIGURACI√ìN (CONSTRUCTOR VISUAL) -->
    <!-- P√ÅGINA 9: CONFIGURACI√ìN (CONSTRUCTOR VISUAL) -->
    <div id="page-config" class="page-section">
        <div style="max-width:1000px; margin:0 auto;">
            <h2 style="text-align:center;">Gesti√≥n de Carrera & Malla</h2>
            <p style="text-align:center; color:#666;">Dise√±a tu propia carrera o carga una existente.</p>

            <!-- NUEVO: GESTOR DE √ÅREAS (ESPECIALIDADES) -->
            <div class="stats-card" style="margin-bottom: 20px;">
                <h3>üé® Definir √Åreas / Especialidades</h3>
                <p style="font-size:0.9rem; color:#666;">Define las ramas de tu carrera para ver las estad√≠sticas (Ej: Estructuras, Geotecnia...).</p>
                <div id="areas-list" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="new-area-name" placeholder="Nombre √Årea" style="padding:5px;">
                    <input type="color" id="new-area-color" value="#333333">
                    <button class="btn-calc-action" onclick="addNewArea()" style="margin:0;">+ Crear</button>
                    <button onclick="resetAreas()" style="font-size:0.8rem; background:none; border:none; text-decoration:underline; cursor:pointer;">Restaurar Default</button>
                </div>
            </div>

            <!-- 1. CONSTRUCTOR VISUAL -->
            <div class="builder-container">
                <div class="builder-header">
                    <h3>üõ†Ô∏è Constructor de Malla Interactivo</h3>
                    <p>Agrega los cursos ciclo por ciclo. El sistema calcular√° los requisitos autom√°ticamente.</p>
                </div>
                
                <div id="builder-cycles-area">
                    <!-- Aqu√≠ se dibujar√°n los ciclos con JS -->
                </div>

                <div class="builder-actions">
                    <button class="btn-add" style="background:#555;" onclick="addBuilderCycle()">+ A√±adir Otro Ciclo</button>
                    <button class="btn-add" style="font-size:1.2rem; padding:15px;" onclick="saveBuilderMalla()">üíæ GUARDAR Y USAR ESTA MALLA</button>
                </div>
            </div>

            <hr style="margin:40px 0; border:0; border-top:1px solid #ddd;">

            <!-- ======================================================= -->
            <!-- 2. ZONA AVANZADA NUEVA (AQU√ç ES DONDE CAMBIASTE) -->
            <!-- ======================================================= -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:30px;">
                
                <!-- Panel de Importar/Restaurar -->
                <div class="stats-card">
                    <h4>üì• Cargar Malla Externa</h4>
                    <p style="font-size:0.8rem; color:#666;">Pega aqu√≠ el c√≥digo JSON que te pas√≥ un amigo.</p>
                    <textarea id="json-import-area" style="width:100%; height:60px; border:1px solid #ccc; font-size:0.7rem; margin-bottom:10px;" placeholder='[{"id":"... }]'></textarea>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-export" onclick="importCustomMalla()">Cargar JSON</button>
                        <button class="btn-export" style="background:#c0392b;" onclick="restoreAdminMalla()">Restaurar Admin</button>
                    </div>
                </div>

                <!-- Panel de Resultado (Generado al guardar) -->
                <div class="stats-card" id="share-panel" style="display:none; border: 2px solid #27ae60; background:#f0f9f4;">
                    <h4 style="color:#27ae60;">‚úÖ ¬°Malla Creada! Comp√°rtela:</h4>
                    <p style="font-size:0.8rem;">Copia este c√≥digo y p√°saselo a tus compa√±eros para que tengan tu misma malla.</p>
                    <textarea id="json-export-area" readonly style="width:100%; height:80px; border:1px solid #27ae60; font-size:0.7rem; background:white;"></textarea>
                    <button class="btn-calc-action" onclick="copyExportJson()">Copiar al Portapapeles</button>
                </div>
            </div>
            <!-- ======================================================= -->

        </div>
    </div>

    <style>
        /* ESTILOS DEL CONSTRUCTOR */
        .builder-container { background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .builder-header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .builder-cycle { background: #f8f9fa; border: 1px solid #e0e0e0; margin: 15px; border-radius: 8px; overflow: hidden; }
        .b-cycle-title { background: #eee; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; color: #333; }
        .b-courses-list { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
        
        .b-course-card { background: white; padding: 10px; border-radius: 6px; border-left: 4px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 5px; position: relative; }
        .b-course-card input, .b-course-card select { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        .b-row { display: flex; gap: 5px; }
        .b-del-btn { position: absolute; top: 5px; right: 5px; color: #c0392b; cursor: pointer; font-weight: bold; background: none; border: none; }
        
        .builder-actions { padding: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; background: #eee; }
        
        body.dark-mode .builder-container, body.dark-mode .b-course-card { background: #1e272e; color: #ddd; }
        body.dark-mode .b-cycle-title, body.dark-mode .builder-actions { background: #111; color: #ddd; }
        body.dark-mode .builder-cycle { background: #2f3640; border-color: #444; }
    </style>

    <!-- P√ÅGINA 7: ESTRATEGIA & IA (NUEVO) -->
    <div id="page-estrategia" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">Planificaci√≥n Estrat√©gica & Asistente Virtual</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Detecta tus "Semanas del Infierno" y recibe asesor√≠a t√°ctica basada en tus datos.</p>

        <div class="strategy-layout">
            
            <!-- COLUMNA IZQUIERDA: MAPA DE CALOR -->
            <div class="heatmap-panel">
                <div class="panel-header">
                    <h3><span class="material-icons">local_fire_department</span> Mapa de Calor Acad√©mico</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="date" id="cycle-start-date" class="form-select" style="padding:5px; width:130px;" title="Inicio de Ciclo">
                        <button class="btn-export btn-ics" style="margin:0; padding:5px 10px; font-size:0.8rem;" onclick="downloadDeadlinesICS()">
                            <span class="material-icons">event</span> G. Calendar
                        </button>
                    </div>
                </div>

                <!-- Inputs para agregar eventos -->
                <div class="add-event-box">
                    <div style="display:grid; grid-template-columns: 80px 1fr 100px auto; gap:10px; align-items:center;">
                        <input type="number" id="evt-week" placeholder="Semana (1-16)" class="form-select" min="1" max="16">
                        <input type="text" id="evt-name" placeholder="Ej: Parcial Microeconom√≠a" class="form-select">
                        <select id="evt-type" class="form-select">
                            <option value="3">Examen (3pts)</option>
                            <option value="2">Trabajo (2pts)</option>
                            <option value="1">Tarea (1pt)</option>
                        </select>
                        <button class="btn-add" style="padding:10px;" onclick="addHellEvent()">+</button>
                    </div>
                </div>

                <!-- Grilla de Semanas -->
                <div id="hell-grid" class="hell-weeks-grid">
                    <!-- Se genera con JS -->
                </div>
                
                <div class="legend">
                    <span class="dot" style="background:#4caf50"></span> Relax
                    <span class="dot" style="background:#f1c40f"></span> Moderado
                    <span class="dot" style="background:#e67e22"></span> Pesado
                    <span class="dot" style="background:#c0392b"></span> INFIERNO
                </div>
            </div>

            <!-- COLUMNA DERECHA: IA CONTEXTUAL (VERSI√ìN AUTOM√ÅTICA) -->
            <div class="ai-panel">
                <div class="ai-header">
                    <span class="material-icons" style="font-size:2rem; color:#4dd0e1;">psychology</span>
                    <div style="flex:1;">
                        <div style="font-weight:bold; display:flex; align-items:center; gap:10px;">
                            Lumin BOT
                        </div>
                    </div>
                    
                </div>
                
                <div id="chat-history" class="chat-area">
                    <div class="msg-ai">
                        Hola. Soy <b>Lumin Bot</b>, tu copiloto universitario.<br>
                        Puedo ayudarte a organizar tu estudio, analizar tu malla o darte consejos profesionales para <b>cualquier carrera</b>.
                    </div>
                </div>

                <!-- Indicador de pensando -->
                <div id="ai-loading" style="display:none; padding:10px; font-size:0.8rem; color:#aaa; font-style:italic;">
                    <span class="material-icons" style="font-size:1rem; vertical-align:middle; animation:spin 1s linear infinite;">sync</span> Consultando servidor IA...
                </div>
                
                <div class="chat-input-area">
                    <input type="text" id="user-msg" placeholder="Ej: Expl√≠came el WACC con un ejemplo peruano..." onkeypress="handleChatEnter(event)">
                    <button onclick="sendMessage()"><span class="material-icons">send</span></button>
                </div>
                
                <div class="quick-actions">
                    <button class="chip" onclick="askAI('finance')">üí∞ Concepto Financiero</button>
                    <button class="chip" onclick="askAI('risk')">‚ö†Ô∏è An√°lisis de Riesgo</button>
                    <button class="chip" onclick="askAI('email')">‚úâÔ∏è Redactar Correo</button>
                </div>
            </div>

        <!-- Modal para Configurar API Key -->
        <style>
            @keyframes spin { 100% { transform: rotate(360deg); } }
            /* Markdown b√°sico para respuestas IA */
            .msg-ai strong { color: #d35400; }
            .msg-ai ul { padding-left: 20px; margin: 5px 0; }
            .msg-ai code { background: #eee; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        </style>

        </div>
    </div>
    <!-- P√ÅGINA 10: COMUNIDAD / REPOSITORIO -->
    <div id="page-comunidad" class="page-section">
        <h2 style="text-align:center; margin-bottom:10px;">üåé Comunidad de Mallas</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;">Explora y carga mallas creadas por otros estudiantes de diferentes universidades.</p>

        <div class="repo-grid" id="repo-container">
            <!-- Aqu√≠ se inyectar√°n las tarjetas con JS -->
        </div>
    </div>

    <style>
        /* ESTILOS ESPEC√çFICOS PARA LA NUEVA SECCI√ìN */
        .strategy-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; height: 750px; }
        
        /* Heatmap Styles */
        .heatmap-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--grid-line); padding-bottom: 10px; }
        .add-event-box { background: rgba(0,0,0,0.02); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        
        .hell-weeks-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; overflow-y: auto; padding-right: 5px; flex: 1; }
        .week-box { border: 1px solid var(--border); border-radius: 8px; padding: 10px; position: relative; min-height: 120px; transition: all 0.3s; display: flex; flex-direction: column; }
        .week-box:hover { transform: scale(1.02); z-index: 5; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .week-header { font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .week-score { font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; color: white; }
        
        .event-item { font-size: 0.75rem; margin-bottom: 3px; padding: 3px; border-radius: 3px; background: rgba(255,255,255,0.7); color: #333; display: flex; justify-content: space-between; }
        .event-item .del-evt { cursor: pointer; color: red; font-weight: bold; display: none; }
        .week-box:hover .del-evt { display: block; }

        /* Colores de Intensidad */
        .level-0 { background: #e8f5e9; border-color: #a5d6a7; } /* Low */
        .level-1 { background: #fff9c4; border-color: #fff59d; } /* Mid */
        .level-2 { background: #ffccbc; border-color: #ffab91; } /* High */
        .level-3 { background: #ffcdd2; border-color: #ef9a9a; animation: pulseRed 2s infinite; } /* HELL */
        .level-3 .week-header { color: #c62828; }

        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); } }

        .legend { display: flex; gap: 15px; margin-top: 10px; font-size: 0.8rem; justify-content: center; color: #666; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* AI Chat Styles */
        .ai-panel { background: #2c3e50; color: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .ai-header { padding: 20px; background: #1a252f; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #34495e; }
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: url('https://www.transparenttextures.com/patterns/cubes.png'); /* Pattern sutil */ }
        
        .msg-ai, .msg-user { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .msg-ai { background: white; color: #333; border-top-left-radius: 0; align-self: flex-start; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .msg-user { background: var(--accent); color: #000; border-top-right-radius: 0; align-self: flex-end; font-weight: 500; }
        
        .chat-input-area { padding: 15px; background: #1a252f; display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; padding: 12px; border-radius: 20px; border: none; font-family: inherit; }
        .chat-input-area button { background: var(--primary); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .chat-input-area button:hover { transform: scale(1.1); }

        .quick-actions { padding: 10px 15px; background: #1a252f; display: flex; gap: 8px; overflow-x: auto; padding-top: 0; }
        .chip { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ddd; padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; }
        .chip:hover { background: white; color: #333; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        @media (max-width: 900px) {
            .strategy-layout { grid-template-columns: 1fr; height: auto; }
            .heatmap-panel, .ai-panel { height: 600px; }
            .hell-weeks-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>

<script type="module">
    
    // ================= SEGURIDAD FIREBASE + BASE DE DATOS =================
    
    // 1. IMPORTAR FIREBASE (AUTH Y FIRESTORE)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    // BUSCA LA L√çNEA DE FIRESTORE:
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. TU LISTA BLANCA (Mantenemos tus correos)
    const ALLOWED_EMAILS = [
        "andersonpedroescobar292@gmail.com",
        "dianapinarez@gmail.com",
        "maria.escobarw@gmail.com",
        "marcorojasrivera20@gmail.com",
        "20231490@lamolina.edu.pe" ,
        "Khiara.carrasco@unmsm.edu.pe" ,
        "dianaeme40@gmail.com"
    ];

    // 3. CONFIGURACI√ìN 
    const firebaseConfig = {
        apiKey: "AIzaSyDBq8ExQaOE1QLdVqedmesz1jxdwv2dR5Y",
        authDomain: "unmsm-administracion.firebaseapp.com",
        projectId: "unmsm-administracion",
        storageBucket: "unmsm-administracion.firebasestorage.app",
        messagingSenderId: "885762425594",
        appId: "1:885762425594:web:a514af6db93fef4be6bf43",
        measurementId: "G-16KXE5N8ZD"
    };

    // 4. INICIALIZAR APP, AUTH Y BASE DE DATOS
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    
    // --- ESTA ES LA OTRA L√çNEA NUEVA IMPORTANTE: ---
    const db = getFirestore(app);

    // 5. FUNCI√ìN DE LOGIN
    const loginBtn = document.getElementById('google-login-btn');
    if(loginBtn) {
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    checkUserAccess(result.user);
                })
                .catch((error) => {
                    console.error("Error Login:", error);
                    showError("Error de conexi√≥n con Google.");
                });
        });
    }

    // 6. VERIFICAR PERMISOS
    function checkUserAccess(user) {
        // Convertimos a min√∫sculas para evitar errores
        if (ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
            // ¬°ACCESO CONCEDIDO!
            const overlay = document.getElementById('login-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);
            console.log("Bienvenido: " + user.email);
        } else {
            // ¬°ACCESO DENEGADO!
            showError(`üö´ Acceso Denegado. El correo ${user.email} no est√° autorizado.`);
            signOut(auth); // Cerrar sesi√≥n forzosamente
        }
    }

    function showError(msg) {
        const err = document.getElementById('login-error');
        err.innerText = msg;
        err.style.display = 'block';
    }

    // 7. PERSISTENCIA (Para que no pida login a cada rato)
    onAuthStateChanged(auth, (user) => {
        if (user) {
            checkUserAccess(user);
        }
    });

    // ================= FIN C√ìDIGO FIREBASE =================

    // ================= DATA =================
    // 1. MALLA BASE (ADMINISTRACI√ìN)
    const ADMIN_MALLA = [
        // CICLO 1
        {id:'EGO1O1', name:'Lenguaje', cr:4, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O2', name:'M√©todos de Estudio Universitario', cr:3, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O3', name:'Historia del Per√∫', cr:3, c:1, t:'O', req:[], tags:[]},
        {id:'EGO1O4', name:'Matem√°tica I', cr:4, c:1, t:'O', req:[], tags:['fin']},
        {id:'EGO1O5', name:'Desarrollo Personal', cr:3, c:1, t:'O', req:[], tags:['rrhh']},
        {id:'EGO1O6', name:'Ingl√©s I', cr:2, c:1, t:'O', req:[], tags:[]},
        // CICLO 2
        {id:'EGO2O1', name:'Investigaci√≥n Acad√©mica', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O2', name:'Filosof√≠a y √âtica', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O3', name:'Realidad Nacional y Mundial', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O4', name:'Matem√°tica II', cr:4, c:2, t:'O', req:['EGO1O4'], tags:['fin']},
        {id:'EGO2O5', name:'Derechos Fundamentales', cr:3, c:2, t:'O', req:[], tags:[]},
        {id:'EGO2O6', name:'Ingl√©s II', cr:2, c:2, t:'O', req:['EGO1O6'], tags:[]},
        // CICLO 3
        {id:'ADO23301', name:'Estad√≠stica Descriptiva', cr:4, c:3, t:'O', req:[], tags:['mkt']},
        {id:'ADO23302', name:'Microeconom√≠a', cr:3, c:3, t:'O', req:[], tags:['fin']},
        {id:'ADO23303', name:'Visi√≥n para el Desarrollo', cr:3, c:3, t:'O', req:['EGO2O1'], tags:[]},
        {id:'ADO23304', name:'Fundamentos de Administraci√≥n', cr:4, c:3, t:'O', req:[], tags:['op']},
        {id:'ADO23305', name:'TICs para la Gesti√≥n', cr:3, c:3, t:'O', req:[], tags:['op']},
        {id:'ADO23306', name:'Fundamentos de Contabilidad', cr:3, c:3, t:'O', req:[], tags:['fin']},
        {id:'ADO23307', name:'Desarrollo Sostenible', cr:2, c:3, t:'O', req:[], tags:[]},
        // CICLO 4
        {id:'ADO23401', name:'Estad√≠stica Inferencial', cr:4, c:4, t:'O', req:['ADO23301'], tags:['mkt']},
        {id:'ADO23402', name:'Macroeconom√≠a', cr:3, c:4, t:'O', req:['ADO23302'], tags:['fin']},
        {id:'ADO23403', name:'Derecho Empresarial', cr:3, c:4, t:'O', req:[], tags:['op']},
        {id:'ADO23404', name:'Investigaci√≥n Cient√≠fica', cr:3, c:4, t:'O', req:['ADO23303'], tags:[]},
        {id:'ADO23405', name:'Procesos Administrativos', cr:4, c:4, t:'O', req:['ADO23304'], tags:['op']},
        {id:'ADO23406', name:'Costos y Presupuestos', cr:3, c:4, t:'O', req:['ADO23306'], tags:['fin']},
        {id:'ADO23407', name:'Matem√°tica Financiera', cr:4, c:4, t:'O', req:[], tags:['fin']},
        // CICLO 5
        {id:'ADO23501', name:'Derecho Laboral', cr:2, c:5, t:'O', req:['ADO23403'], tags:['rrhh']},
        {id:'ADO23502', name:'Administraci√≥n de la Calidad', cr:3, c:5, t:'O', req:['ADO23405'], tags:['op']},
        {id:'ADO23503', name:'Fundamentos del Talento Humano', cr:3, c:5, t:'O', req:[], tags:['rrhh']},
        {id:'ADO23504', name:'Finanzas Corporativas I', cr:3, c:5, t:'O', req:['ADO23407'], tags:['fin']},
        {id:'ADO23505', name:'Herramientas Desarrollo Proyectos', cr:3, c:5, t:'O', req:[], tags:['op']},
        {id:'ADO23506', name:'Fundamentos de Marketing', cr:3, c:5, t:'O', req:[], tags:['mkt']},
        {id:'ADO23507', name:'Cadenas de Suministros', cr:3, c:5, t:'O', req:[], tags:['op']},
        {id:'ADO23508', name:'Emprendimiento e Innovaci√≥n', cr:3, c:5, t:'O', req:[], tags:['op']},
        // CICLO 6
        {id:'ADE23601', name:'Reclutamiento y Selecci√≥n', cr:3, c:6, t:'E', req:['ADO23503'], tags:['rrhh']},
        {id:'ADE23602', name:'Seguridad y Salud en el Trabajo', cr:3, c:6, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23603', name:'Finanzas Corporativas II', cr:3, c:6, t:'E', req:['ADO23504'], tags:['fin']},
        {id:'ADE23604', name:'Form. y Eval. Proyectos Inversi√≥n', cr:3, c:6, t:'E', req:['ADO23505'], tags:['fin', 'op']},
        {id:'ADE23605', name:'Marketing Digital', cr:3, c:6, t:'E', req:['ADO23506'], tags:['mkt']},
        {id:'ADE23606', name:'Comportamiento del Consumidor', cr:3, c:6, t:'E', req:[], tags:['mkt']},
        {id:'ADE23607', name:'Planeaci√≥n Demanda/Pron√≥sticos', cr:3, c:6, t:'E', req:['ADO23507'], tags:['op']},
        {id:'ADE23608', name:'Inv. Desarrollo e Innovaci√≥n', cr:3, c:6, t:'E', req:[], tags:['op']},
        {id:'ADO23601', name:'M√©todos Cuantitativos', cr:3, c:6, t:'O', req:['ADO23401'], tags:['op']},
        {id:'ADO23602', name:'Investigaci√≥n de Mercados', cr:3, c:6, t:'O', req:[], tags:['mkt']},
        {id:'ADO23603', name:'Derecho Tributario', cr:2, c:6, t:'O', req:['ADO23501'], tags:['fin']},
        {id:'ADO23604', name:'T√©cnicas de Inv. Cualitativa', cr:3, c:6, t:'O', req:['ADO23404'], tags:['mkt', 'rrhh']},
        {id:'ADO23605', name:'Reestructuraci√≥n Empresarial', cr:3, c:6, t:'O', req:['ADO23502'], tags:['op']},
        // CICLO 7
        {id:'ADE23701', name:'Capacitaci√≥n y Desarrollo Talento', cr:3, c:7, t:'E', req:['ADE23601'], tags:['rrhh']},
        {id:'ADE237010', name:'Aprovisionamiento y Negociaci√≥n', cr:3, c:7, t:'E', req:[], tags:['op']},
        {id:'ADE23702', name:'Gesti√≥n Clima y Cultura Org.', cr:3, c:7, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23703', name:'Mercado de Capitales', cr:3, c:7, t:'E', req:['ADE23603'], tags:['fin']},
        {id:'ADE23704', name:'Derivados Financieros', cr:3, c:7, t:'E', req:[], tags:['fin']},
        {id:'ADE23705', name:'Form. Eval. Proyectos Sociales I', cr:3, c:7, t:'E', req:['ADE23604'], tags:['op']},
        {id:'ADE23706', name:'Gesti√≥n de Riesgos Proyectos', cr:3, c:7, t:'E', req:[], tags:['op']},
        {id:'ADE23707', name:'Marketing de Servicios', cr:3, c:7, t:'E', req:['ADE23605'], tags:['mkt']},
        {id:'ADE23708', name:'Programaci√≥n Neuroling√º√≠stica', cr:3, c:7, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23709', name:'Operaciones I', cr:3, c:7, t:'E', req:['ADE23607'], tags:['op']},
        {id:'ADO23701', name:'Negocios Internacionales', cr:4, c:7, t:'O', req:[], tags:['op', 'fin']},
        {id:'ADO23702', name:'T√©cnicas de Inv. Cuantitativa', cr:3, c:7, t:'O', req:['ADO23604'], tags:['mkt']},
        {id:'ADO23703', name:'Prospectiva Empresarial', cr:3, c:7, t:'O', req:['ADO23605'], tags:['op']},
        // CICLO 8
        {id:'ADE23801', name:'Evaluaci√≥n del Desempe√±o', cr:3, c:8, t:'E', req:['ADE23701'], tags:['rrhh']},
        {id:'ADE238010', name:'Gesti√≥n Almacenes e Inventarios', cr:3, c:8, t:'E', req:[], tags:['op']},
        {id:'ADE23802', name:'Inteligencia Emocional y Social', cr:3, c:8, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23803', name:'Finanzas Internacionales', cr:3, c:8, t:'E', req:['ADE23703'], tags:['fin']},
        {id:'ADE23804', name:'Econometr√≠a Financiera', cr:3, c:8, t:'E', req:[], tags:['fin']},
        {id:'ADE23805', name:'Form. Eval. Proyectos Sociales II', cr:3, c:8, t:'E', req:['ADE23705'], tags:['op']},
        {id:'ADE23806', name:'Gesti√≥n Proyectos P√∫b/Priv', cr:3, c:8, t:'E', req:[], tags:['op']},
        {id:'ADE23807', name:'Marketing Internacional', cr:3, c:8, t:'E', req:['ADE23707'], tags:['mkt']},
        {id:'ADE23808', name:'Publicidad y Branding', cr:3, c:8, t:'E', req:[], tags:['mkt']},
        {id:'ADE23809', name:'Operaciones II', cr:3, c:8, t:'E', req:['ADE23709'], tags:['op']},
        {id:'ADO23801', name:'Integraci√≥n Econ√≥mica', cr:3, c:8, t:'O', req:['ADO23701'], tags:['op']},
        {id:'ADO23802', name:'Proyecto de Investigaci√≥n', cr:3, c:8, t:'O', req:['ADO23702'], tags:['op']},
        {id:'ADO23803', name:'Planeamiento Estrat√©gico', cr:3, c:8, t:'O', req:['ADO23703'], tags:['op']},
        {id:'ADO23804', name:'Gesti√≥n P√∫blica', cr:3, c:8, t:'O', req:[], tags:['op']},
        // CICLO 9
        {id:'ADE23901', name:'Valoraci√≥n Puestos/Compensaciones', cr:3, c:9, t:'E', req:['ADE23801'], tags:['rrhh']},
        {id:'ADE23902', name:'Gesti√≥n Talento Sector P√∫blico', cr:3, c:9, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23903', name:'Gesti√≥n Riesgos Financieros', cr:3, c:9, t:'E', req:['ADE23803'], tags:['fin']},
        {id:'ADE23904', name:'Finanzas P√∫blicas', cr:3, c:9, t:'E', req:[], tags:['fin']},
        {id:'ADE23905', name:'Gerencia de Proyectos', cr:3, c:9, t:'E', req:['ADE23905'], tags:['op']},
        {id:'ADE23906', name:'Gerencia de Ventas', cr:3, c:9, t:'E', req:['ADE23807'], tags:['mkt']},
        {id:'ADE23907', name:'Negociaci√≥n Comercial', cr:3, c:9, t:'E', req:[], tags:['mkt']},
        {id:'ADE23908', name:'Log√≠stica Sector P√∫blico', cr:3, c:9, t:'E', req:['ADE23809'], tags:['op']},
        {id:'ADE23909', name:'Distribuci√≥n y Transporte', cr:3, c:9, t:'E', req:[], tags:['op']},
        {id:'ADO23901', name:'Desarrollo de Investigaci√≥n I', cr:3, c:9, t:'O', req:['ADO23802'], tags:[]},
        {id:'ADO23902', name:'Direcci√≥n Estrat√©gica', cr:3, c:9, t:'O', req:['ADO23803'], tags:['op']},
        {id:'ADO23903', name:'Des. y Lanzamiento Nuevos Prod.', cr:3, c:9, t:'O', req:[], tags:['mkt']},
        {id:'ADO23904', name:'Cadena de Valor', cr:3, c:9, t:'O', req:[], tags:['op']},
        // CICLO 10
        {id:'ADE23101', name:'Gerencia Estrat√©gica Talento', cr:3, c:10, t:'E', req:['ADE23901'], tags:['rrhh']},
        {id:'ADE23102', name:'Auditor√≠a Gesti√≥n Talento', cr:3, c:10, t:'E', req:[], tags:['rrhh']},
        {id:'ADE23103', name:'Direcci√≥n Financiera', cr:3, c:10, t:'E', req:['ADE23903'], tags:['fin']},
        {id:'ADE23104', name:'Taller de Proyectos', cr:3, c:10, t:'E', req:['ADE23905'], tags:['op']},
        {id:'ADE23105', name:'Gerencia de Marketing', cr:3, c:10, t:'E', req:['ADE23906'], tags:['mkt']},
        {id:'ADE23106', name:'Neuromarketing', cr:3, c:10, t:'E', req:[], tags:['mkt']},
        {id:'ADE23107', name:'Gerencia Log√≠stica', cr:3, c:10, t:'E', req:['ADE23908'], tags:['op']},
        {id:'ADE23108', name:'Log√≠stica Internacional', cr:3, c:10, t:'E', req:[], tags:['op']},
        {id:'ADO23101', name:'Desarrollo de Investigaci√≥n II', cr:3, c:10, t:'O', req:['ADO23901'], tags:[]},
        {id:'ADO23102', name:'Gerencia General y Alta Dir.', cr:3, c:10, t:'O', req:['ADO23902'], tags:['op']},
        {id:'ADO23103', name:'Gesti√≥n de PYMES', cr:3, c:10, t:'O', req:[], tags:['op']}
    ];

    // =========================================================
    // 2. L√ìGICA DE CARGA DE DATOS (CORREGIDO)
    // =========================================================
    let courses = []; 

    try {
        const stored = localStorage.getItem('lumin_custom_malla');
        if (stored && stored !== "undefined" && stored !== "[]") {
            courses = JSON.parse(stored);
        }
    } catch (e) {
        console.error("Error cargando malla personalizada", e);
        courses = [];
    }
    
    // Si no hay personalizada o qued√≥ vac√≠a, usamos la OFICIAL
    if (!courses || courses.length === 0) {
        courses = JSON.parse(JSON.stringify(ADMIN_MALLA));
    }

    // =========================================================
    // 3. LOGICA DE √ÅREAS Y ESPECIALIDADES
    // =========================================================
    let customAreas = []; 

    // NUEVA BASE DE DATOS DE SKILLS (DIN√ÅMICA)
    let globalSkillsDB = [];

    function initCustomAreas() {
        const stored = localStorage.getItem('lumin_custom_areas');
        if(stored) {
            customAreas = JSON.parse(stored);
        } else {
            // COLORES BASADOS EN TUS IM√ÅGENES (Leyenda)
            customAreas = [
                {id:'rrhh', name:'Talento Humano', color:'#9b59b6'}, // Morado
                {id:'fin', name:'Finanzas', color:'#8bc34a'},        // Verde Claro
                {id:'op', name:'Proyectos', color:'#e57373'},        // Rojo/Salm√≥n
                {id:'mkt', name:'Marketing', color:'#42a5f5'},       // Azul
                {id:'log', name:'Log√≠stica', color:'#ffb74d'}        // Naranja/Peach
            ];
            // Guardamos esto inmediatamente para que se aplique
            localStorage.setItem('lumin_custom_areas', JSON.stringify(customAreas));
        }
        renderCustomAreas();
    }
    
    function renderCustomAreas() {
        const div = document.getElementById('areas-list'); 
        const div2 = document.getElementById('custom-areas-list'); 
        
        const draw = (container) => {
            if(!container) return;
            container.innerHTML = '';
            customAreas.forEach((tag, idx) => {
                const chip = document.createElement('div');
                chip.style.cssText = `background:${tag.color}; color:white; padding:5px 10px; border-radius:15px; font-size:0.8rem; display:flex; align-items:center; gap:5px; margin-bottom:5px;`;
                chip.innerHTML = `${tag.name} <span style="cursor:pointer; font-weight:bold; margin-left:5px;" onclick="removeCustomArea(${idx})">√ó</span>`;
                container.appendChild(chip);
            });
        };

        draw(div);
        draw(div2);
    }

    window.updateAllBuilderAreaDropdowns = function() {
        let areaOptions = '<option value="">-- Sin √Årea --</option>';
        customAreas.forEach(a => {
            areaOptions += `<option value="${a.id}" style="color:${a.color}">‚òÖ ${a.name}</option>`;
        });

        document.querySelectorAll('.b-area').forEach(select => {
            const currentVal = select.value; 
            select.innerHTML = areaOptions;  
            select.value = currentVal;       
        });
    };

    window.addNewArea = function() {
        const nameInput = document.getElementById('new-area-name');
        const colorInput = document.getElementById('new-area-color');
        
        if(!nameInput) return;
        const name = nameInput.value.trim();
        const color = colorInput.value;
        
        if(!name) return alert("Por favor escribe un nombre para el √°rea.");
        
        const id = name.toLowerCase().substring(0, 4) + Math.floor(Math.random()*100);
        
        customAreas.push({ id, name, color });
        localStorage.setItem('lumin_custom_areas', JSON.stringify(customAreas));
        
        nameInput.value = ''; 
        renderCustomAreas();  
        updateAllBuilderAreaDropdowns();
    };

    window.resetAreas = function() {
        if(confirm("¬øRestaurar las √°reas por defecto de Administraci√≥n?")) {
            localStorage.removeItem('lumin_custom_areas');
            initCustomAreas(); 
            location.reload(); 
        }
    };

    window.removeCustomArea = function(idx) {
        if(confirm("¬øEliminar esta √°rea?")) {
            customAreas.splice(idx, 1);
            localStorage.setItem('lumin_custom_areas', JSON.stringify(customAreas));
            renderCustomAreas();
            updateAllBuilderAreaDropdowns();
        }
    };

    // 4. DATABASE DE SKILLS
    

    let approved = new Set();
    let approvedGrades = {}; 
    let acquiredSkills = new Set();
    let mySchedule = []; 
    let chartInstance = null;
    let ppsChartInstance = null;
    let skillsRadarInstance = null;
    let areaProgressInstance = null;
    let gradesDistInstance = null;

    // =================================================================
    // 3. LOGICA DE AUTENTICACI√ìN Y BASE DE DATOS
    // =================================================================

    // Funci√≥n que activa el popup de Google
    async function triggerGoogleLogin() {
        const errBox = document.getElementById('login-error');
        errBox.style.display = 'none'; // Ocultar error previo
        console.log("üîµ Bot√≥n presionado... conectando con Google..."); 

        try {
            const result = await signInWithPopup(auth, provider);
            console.log("‚úÖ Login exitoso, verificando correo...");
            checkUserAccess(result.user);
        } catch (error) {
            console.error("‚ùå Error Login:", error);
            errBox.style.display = 'block';
            errBox.innerText = "Error: " + error.message;
            
            if(error.code === 'auth/popup-closed-by-user') {
                errBox.innerText = "Cerraste la ventana de Google antes de terminar.";
            }
            if(error.code === 'auth/unauthorized-domain') {
                errBox.innerText = "Error de Dominio: Agrega este link en Firebase > Authentication > Settings.";
            }
        }
    }

    // Buscar el bot√≥n y pegarle el evento (ESPERA A QUE CARGUE)
    // Usamos setTimeout para asegurar que el HTML ya existe
    setTimeout(() => {
        const btnLogin = document.getElementById('btn-login-google');
        if(btnLogin) {
            console.log("Bot√≥n de login encontrado y activado.");
            btnLogin.addEventListener('click', triggerGoogleLogin);
        } else {
            console.error("‚õî ERROR CR√çTICO: No encuentro el bot√≥n con id 'btn-login-google'");
        }
    }, 500);

    // Verificaci√≥n de estado (Persistencia)
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            if (ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                if(document.getElementById('user-email-display')) {
                    document.getElementById('user-email-display').innerText = user.email;
                }
                await loadCloudData();
                initApp();
            } else {
                alert("Acceso denegado. Tu correo no est√° en la lista.");
                signOut(auth);
            }
        }
    });

    // =========================================================
    // PARCHE: Corrige "Gesti√≥n/Ops" a "Proyectos" autom√°ticamente
    // =========================================================
    function corregirNombreProyectos() {
        // 1. Revisamos si el alumno tiene datos guardados
        const stored = localStorage.getItem('lumin_custom_areas');
        
        if (stored) {
            let areas = JSON.parse(stored);
            let huboCambio = false;

            // 2. Buscamos el √°rea 'op' y forzamos el nombre nuevo
            areas.forEach(area => {
                if (area.id === 'op' && area.name !== 'Proyectos') {
                    area.name = 'Proyectos'; // <--- AQU√ç OCURRE LA MAGIA
                    huboCambio = true;
                }
            });

            // 3. Si hicimos cambios, guardamos de nuevo en la memoria del navegador
            if (huboCambio) {
                localStorage.setItem('lumin_custom_areas', JSON.stringify(areas));
                console.log("Nombre actualizado a 'Proyectos' con √©xito.");
            }
        }
    }

    // ================= INIT =================
    // ================= INIT =================
    function init() {
        corregirNombreProyectos();
        // Cargar datos de memoria
        if(localStorage.getItem('unmsm_adm_v11_c')) approved = new Set(JSON.parse(localStorage.getItem('unmsm_adm_v11_c')));
        if(localStorage.getItem('unmsm_adm_v11_g')) approvedGrades = JSON.parse(localStorage.getItem('unmsm_adm_v11_g'));
        if(localStorage.getItem('unmsm_adm_v11_s')) acquiredSkills = new Set(JSON.parse(localStorage.getItem('unmsm_adm_v11_s')));
        if(localStorage.getItem('unmsm_adm_v11_h')) mySchedule = JSON.parse(localStorage.getItem('unmsm_adm_v11_h'));
        
        // Tema oscuro
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        
        loadHellEvents(); 
        renderHellGrid(); 

        // --- Cargar √Åreas Personalizadas ---
        initCustomAreas(); 
        
        // Renderizar componentes
        renderMalla();

        // --- CAMBIO AQU√ç: ---
        // renderSkills();  <-- ESTA LA BORRAMOS (es la vieja)
        initSkills();       // <-- ESTA LA AGREGAMOS (es la nueva din√°mica)
        // --------------------
        
        initSchedule();
        initCalculator();
        updateStats();
        
        // Iniciar constructor
        initBuilder();
    }
    window.showPage = function(id) {
        // 1. Ocultar todas las secciones y desactivar botones
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        // 2. Mostrar la secci√≥n seleccionada
        const page = document.getElementById('page-'+id);
        if(page) page.classList.add('active');
        
        // 3. Activar el bot√≥n correcto en el men√∫
        const map = {
            'config': 0,       // Mi Carrera
            'estrategia': 1,   // Estrategia IA
            'malla': 2,        // Malla
            'progreso': 3,     // Progreso
            'analitica': 4,    // Anal√≠tica
            'calculadora': 5,  // Notas
            'skills': 6,       // Skills
            'simulador': 7,    // Simulador
            'recursos': 8,     // Recursos
            'comunidad': 9,    // Comunidad
            'subirjson': 10    // <--- Cargar Datos (Es el n√∫mero 11, pero empezamos en 0)
        };

        if(map[id] !== undefined) {
            const buttons = document.querySelectorAll('.nav-menu .nav-btn');
            if(buttons[map[id]]) {
                buttons[map[id]].classList.add('active');
            }
        }

        // 4. L√≥gica espec√≠fica de carga para cada p√°gina
        if(id === 'simulador') {
            initSchedule();
            updateScheduleDropdowns();
        }
        if(id === 'progreso') renderDashboard();
        if(id === 'analitica') renderAnalytics();
        if(id === 'estrategia') renderHellGrid(); 
        
        // --- NUEVO: Cargar las tarjetas de comunidad ---
        if(id === 'comunidad') renderComunidad();

        // ---  ---
        if(id === 'config') {
             populateBuilderFromMemory(); // <--- ESTA ES LA L√çNEA CLAVE
        }
    };

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    // ================= MALLA & PPS =================
    // ==========================================
    // PASO 4: DIBUJAR MALLA (L√ìGICA DE BLOQUEO POR CR√âDITOS)
    // ==========================================
    function renderMalla() {
        const grid = document.getElementById('malla-grid');
        grid.innerHTML = '';

        // 1. Calcular cu√°ntos ciclos dibujar
        let maxCycle = 10;
        if(courses.length > 0) {
            const maxInCourses = Math.max(...courses.map(c => c.c));
            maxCycle = Math.max(10, maxInCourses); 
        }

        // --- NUEVO: CALCULAR CR√âDITOS TOTALES APROBADOS ---
        // Necesitamos este n√∫mero para saber si cumples los requisitos
        let totalApprovedCredits = 0;
        courses.forEach(c => {
            if(approved.has(c.id)) {
                totalApprovedCredits += c.cr;
            }
        });
        // --------------------------------------------------

        // 2. Dibujar columnas
        for(let i=1; i<=maxCycle; i++) {
            const col = document.createElement('div');
            col.className = 'cycle-col';
            col.innerHTML = `<div class="cycle-title">Ciclo ${i}</div>`;
            
            const cycleCourses = courses.filter(c => c.c === i);
            
            // Si es un ciclo alto y est√° vac√≠o, lo saltamos
            if(i > 10 && cycleCourses.length === 0) continue;

            cycleCourses.forEach(c => {
                const card = document.createElement('div');
                card.className = `course-card type-${c.t}`;
                card.id = c.id;
                
                const passed = approved.has(c.id);
                
                // --- L√ìGICA MAESTRA DE REQUISITOS ---
                
                // A. ¬øCumple requisitos de cursos previos?
                // (Si c.req est√° vac√≠o, devuelve true)
                const reqCoursesMet = c.req ? c.req.every(r => approved.has(r)) : true;
                
                // B. ¬øCumple requisito de Cr√©ditos? (NUEVO)
                // Si el curso pide cr√©ditos (c.reqCr > 0), comparamos con el total.
                // Si no pide (es 0 o undefined), es true autom√°ticamente.
                const reqCreditsMet = (c.reqCr && c.reqCr > 0) ? totalApprovedCredits >= c.reqCr : true;

                // Para desbloquearse, debe cumplir AMBOS
                const isUnlocked = reqCoursesMet && reqCreditsMet;
                // -------------------------------------

                // ESTILOS VISUALES
                if(passed) {
                    card.classList.add('completed');
                } else if(!isUnlocked) { 
                    card.classList.add('locked'); 
                    
                    // Tooltip inteligente: Dice exactamente qu√© falta al pasar el mouse
                    let msg = "";
                    if(!reqCoursesMet) msg += "Falta aprobar cursos previos. ";
                    if(!reqCreditsMet) msg += `Faltan cr√©ditos (Tienes ${totalApprovedCredits}, necesitas ${c.reqCr}).`;
                    card.title = msg;
                }

                // Nota (si existe)
                let gradeHtml = '';
                if(passed && approvedGrades[c.id]) {
                    gradeHtml = `<div class="grade-badge">${approvedGrades[c.id]}</div>`;
                }
                
                // Icono visual de requisito de cr√©dito
                let lockInfo = '';
                if(c.reqCr > 0) {
                    // Si ya lo pasaste o cumples el requisito, se ve normal. Si falta, se ve rojo.
                    const colorStyle = (totalApprovedCredits >= c.reqCr) ? 'color:#27ae60' : 'color:#c0392b; font-weight:bold;';
                    lockInfo = `<div style="font-size:0.7rem; margin-top:2px; ${colorStyle}">üîí Req: ${c.reqCr} Crd.</div>`;
                }

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#666">
                        <strong>${c.id.substring(0,8)}</strong> <span>${c.cr} Cr.</span>
                    </div>
                    <b>${c.name}</b>
                    ${lockInfo}
                    <div style="font-size:0.75rem; color:#999; margin-top:5px; text-align:right">
                        ${c.t === 'O' ? 'Obligatorio' : 'Electivo'}
                    </div>
                    ${gradeHtml}
                `;
                
                // IMPORTANTE: Pasamos 'isUnlocked' a la funci√≥n de click
                card.onclick = () => toggleCourse(c, isUnlocked); 
                
                col.appendChild(card);
            });
            grid.appendChild(col);
        }
    }

    function toggleCourse(c, reqMet) {
        // L√≥gica para desmarcar
        if(approved.has(c.id)) {
            const dep = courses.find(x => x.req.includes(c.id) && approved.has(x.id));
            if(dep) return alert(`‚ö†Ô∏è No puedes desmarcar ${c.name} porque es requisito de ${dep.name}. Desmarca ese primero.`);
            
            approved.delete(c.id);
            delete approvedGrades[c.id];
        
        // L√≥gica para marcar como aprobado
        } else {
            if(!reqMet) return alert("üîí A√∫n no cumples los requisitos para este curso.");
            
            let grade = prompt(`Ingrese nota final para ${c.name} (Opcional, Enter para omitir):`, "14");
            if(grade !== null) {
                approved.add(c.id);
                
                // ARREGLO PPS: Asegurar que sea n√∫mero entero
                if(grade.trim() !== "" && !isNaN(grade)) {
                    approvedGrades[c.id] = parseInt(grade, 10); // Base 10 expl√≠cita
                }

                // NUEVO: NOTIFICACI√ìN DE DESBLOQUEO
                // Buscamos qu√© cursos tienen como requisito el curso actual (c.id)
                const unlockedCourses = courses.filter(course => course.req.includes(c.id));
                if(unlockedCourses.length > 0) {
                    const names = unlockedCourses.map(u => u.name).join(' y ');
                    // Usamos un alert simple o podr√≠as usar una librer√≠a de notificaciones
                    setTimeout(() => alert(`üéâ ¬°Felicidades! Has desbloqueado: ${names}`), 100);
                }
            } else {
                return; // Cancelar si el usuario da "Cancelar"
            }
        }
        
        // Guardado y actualizaci√≥n inmediata
        localStorage.setItem('unmsm_adm_v11_c', JSON.stringify([...approved]));
        localStorage.setItem('unmsm_adm_v11_g', JSON.stringify(approvedGrades));
        
        renderMalla();
        updateStats(); // Forzar rec√°lculo del PPS
    }

    function updateStats() {
        let cr = 0;
        let weightedSum = 0;
        let creditsWithGrade = 0;

        courses.forEach(c => { 
            if(approved.has(c.id)) {
                cr += c.cr;
                // Verificamos que exista nota y que sea un n√∫mero v√°lido
                if(approvedGrades[c.id] !== undefined && approvedGrades[c.id] !== null) {
                    const nota = parseFloat(approvedGrades[c.id]);
                    if(!isNaN(nota)) {
                        weightedSum += nota * c.cr;
                        creditsWithGrade += c.cr;
                    }
                }
            } 
        });
        
        // C√°lculo seguro
        const pps = creditsWithGrade > 0 ? (weightedSum / creditsWithGrade).toFixed(2) : "0.00";
        
        // Actualizar DOM
        const elCredits = document.getElementById('credits-display');
        const elPPS = document.getElementById('pps-display');
        const elPPSDash = document.getElementById('pps-dashboard');

        if(elCredits) elCredits.innerText = cr;
        if(elPPS) elPPS.innerText = pps;
        if(elPPSDash) elPPSDash.innerText = pps;
    }

    window.resetMalla = function() {
        // Mensaje m√°s claro para el usuario
        if(confirm("‚ö†Ô∏è ¬øReiniciar tu progreso acad√©mico?\n\nSe desmarcar√°n todos los cursos aprobados y se borrar√°n las notas, pero TU MALLA PERSONALIZADA SE MANTENDR√Å intacta.")) {
            
            // 1. Limpiamos las variables en memoria (RAM)
            approved = new Set();
            approvedGrades = {};

            // 2. Borramos SOLO las llaves de progreso en el navegador (Disco)
            localStorage.removeItem('unmsm_adm_v11_c'); // 'c' de Checked (Cursos)
            localStorage.removeItem('unmsm_adm_v11_g'); // 'g' de Grades (Notas)

            // IMPORTANTE: NO tocamos 'lumin_custom_malla' ni 'lumin_custom_areas'
            // Tampoco borramos el horario ('unmsm_adm_v11_h') ni los skills manuales ('unmsm_adm_v11_s') 
            // a menos que t√∫ quieras que tambi√©n se borren.

            // 3. Actualizamos la visualizaci√≥n en tiempo real
            renderMalla();      // Redibuja los cursos (ahora todos grises)
            updateStats();      // Pone el PPS y cr√©ditos en 0
            renderAnalytics();  // Actualiza los gr√°ficos a vac√≠o
            
            // Opcional: Actualizar perfil de skills (las barras bajar√°n porque dependen de los cursos)
            calculateProfiles(); 

            // Feedback visual
            alert("‚úÖ Progreso reiniciado. Puedes empezar a marcar de nuevo.");
        }
    };

    // ==========================================
    // L√ìGICA DE PROGRESO (EDITABLE - VERSI√ìN NUEVA)
    // ==========================================
    
    // 1. Funci√≥n para mostrar/ocultar el men√∫ de edici√≥n
    window.toggleGoalsEdit = function() {
        const area = document.getElementById('goals-config-area');
        if(area) area.style.display = area.style.display === 'none' ? 'block' : 'none';
    };

    // 2. Funci√≥n para guardar preferencias cuando el alumno cambia los n√∫meros
    window.saveDashboardSettings = function() {
        const total = document.getElementById('config-total-credits').value;
        const cycle = document.getElementById('config-cycle-credits').value;
        
        // Guardamos en la memoria del navegador
        localStorage.setItem('lumin_conf_total', total);
        localStorage.setItem('lumin_conf_cycle', cycle);
        
        renderDashboard(); // Recalcular inmediatamente con los nuevos datos
    };

    // 3. Funci√≥n Render Dashboard (REEMPLAZA A LA ANTIGUA)
    window.renderDashboard = function() {
        // A. Cargar configuraci√≥n guardada o usar valores por defecto (220 y 21)
        const TOTAL_REQUIRED = parseInt(localStorage.getItem('lumin_conf_total')) || 220; 
        const CREDITS_PER_CYCLE = parseInt(localStorage.getItem('lumin_conf_cycle')) || 21;

        // B. Actualizar las cajitas del HTML para que muestren el valor actual
        const inputTotal = document.getElementById('config-total-credits');
        const inputCycle = document.getElementById('config-cycle-credits');
        
        // Solo actualizamos el valor si el usuario no est√° escribiendo en ese momento
        if(inputTotal && document.activeElement !== inputTotal) inputTotal.value = TOTAL_REQUIRED;
        if(inputCycle && document.activeElement !== inputCycle) inputCycle.value = CREDITS_PER_CYCLE;

        // Actualizar textos informativos
        const lblGoal = document.getElementById('lbl-total-goal');
        if(lblGoal) lblGoal.innerText = TOTAL_REQUIRED;
        
        const lblProj = document.getElementById('lbl-cycle-projection');
        if(lblProj) lblProj.innerText = `*C√°lculo basado en ${CREDITS_PER_CYCLE} cr√©ditos por ciclo.`;

        // C. Calcular cr√©ditos aprobados (Igual que antes)
        let appCr = 0;
        courses.forEach(c => {
            if(approved.has(c.id)) {
                appCr += c.cr;
            }
        });

        // D. C√°lculos de barra y porcentaje con los NUEVOS valores
        let percentage = Math.round((appCr / TOTAL_REQUIRED) * 100);
        let visualPercentage = Math.min(100, percentage);

        const statTotal = document.getElementById('stat-total');
        if(statTotal) statTotal.innerText = `${appCr} / ${TOTAL_REQUIRED}`;
        
        const barTotal = document.getElementById('bar-total');
        if(barTotal) barTotal.style.width = `${visualPercentage}%`;
        
        const chartText = document.getElementById('chart-text');
        if(chartText) chartText.innerText = appCr >= TOTAL_REQUIRED ? `¬°Meta Cumplida!` : `${percentage}% Completado`;
        
        // E. Proyecci√≥n de tiempo con el NUEVO valor de cr√©ditos por ciclo
        const remaining = Math.max(0, TOTAL_REQUIRED - appCr);
        const cyclesLeft = Math.ceil(remaining / CREDITS_PER_CYCLE);
        
        const gradProj = document.getElementById('grad-projection');
        if(gradProj) {
            gradProj.innerHTML = appCr >= TOTAL_REQUIRED ? 
            "<b style='color:green'>¬°FELICIDADES! Tienes cr√©ditos para egresar.</b>" : 
            `Faltan aprox. <b>${cyclesLeft} ciclos</b> acad√©micos.`;
        }

        // F. Dibujar Gr√°fico (Igual que antes)
        const ctxEl = document.getElementById('progressChart');
        if(ctxEl) {
            const ctx = ctxEl.getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Aprobados', 'Pendientes'],
                    datasets: [{
                        data: [Math.min(appCr, TOTAL_REQUIRED), remaining],
                        backgroundColor: [appCr >= TOTAL_REQUIRED ? '#27ae60' : '#8a0303', '#eee'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: true, position: 'bottom' } } }
            });
        }
        
        // Actualizar PPS (Por si acaso)
        if(typeof updateStats === 'function') updateStats();
    };

    function exportPDF() {
        const el = document.getElementById('export-content');
        const opt = { margin: 10, filename: 'reporte-academico-unmsm.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().from(el).set(opt).save();
    }

    // ================= ANAL√çTICA MODIFICADO =================
    // ================= ANAL√çTICA REPARADA =================
    window.renderAnalytics = function() {
        // 1. SEGURIDAD: Si por alguna raz√≥n no hay √°reas cargadas, c√°rgalas.
        if (typeof customAreas === 'undefined' || customAreas.length === 0) {
            if(typeof initCustomAreas === 'function') initCustomAreas();
        }

        // --- GR√ÅFICO 1: PPS HIST√ìRICO (L√≠nea) ---
        const cycleLabels = [];
        const cycleData = [];
        
        for(let i=1; i<=10; i++) {
            let sum = 0;
            let count = 0;
            courses.filter(c => c.c === i && approved.has(c.id)).forEach(c => {
                if(approvedGrades[c.id]) {
                    sum += approvedGrades[c.id] * c.cr;
                    count += c.cr;
                }
            });
            if(count > 0) {
                cycleLabels.push(`Ciclo ${i}`);
                cycleData.push((sum/count).toFixed(2));
            }
        }
        
        const ctxPPS = document.getElementById('ppsHistoryChart').getContext('2d');
        if(ppsChartInstance) ppsChartInstance.destroy();
        ppsChartInstance = new Chart(ctxPPS, {
            type: 'line',
            data: {
                labels: cycleLabels,
                datasets: [{
                    label: 'Promedio Ponderado por Ciclo',
                    data: cycleData,
                    borderColor: '#8a0303',
                    backgroundColor: 'rgba(138, 3, 3, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: { scales: { y: { min: 10, max: 20 } }, plugins: { legend: { display: false } } }
        });

        // --- GR√ÅFICO 2 y 3: RADAR Y BARRAS (√Åreas/Especialidades) ---
        
        // Preparar datos basados en las √°reas din√°micas (customAreas)
        let labels = customAreas.map(t => t.name);
        let colors = customAreas.map(t => t.color);
        let approvedCounts = new Array(customAreas.length).fill(0);
        let totalCounts = new Array(customAreas.length).fill(0);

        // Contar cursos
        courses.forEach(c => {
            if(c.tags && c.tags.length > 0) {
                c.tags.forEach(tagId => {
                    // Buscamos el √≠ndice del √°rea correspondiente
                    const index = customAreas.findIndex(t => t.id === tagId);
                    
                    if(index !== -1) { 
                        totalCounts[index]++; 
                        if(approved.has(c.id)) {
                            approvedCounts[index]++; 
                        }
                    }
                });
            }
        });

        // Renderizar Radar
        const ctxRadar = document.getElementById('skillsRadarChart').getContext('2d');
        if(skillsRadarInstance) skillsRadarInstance.destroy();
        
        skillsRadarInstance = new Chart(ctxRadar, {
            type: 'polarArea',
            data: {
                labels: labels, 
                datasets: [{
                    data: approvedCounts, 
                    backgroundColor: colors.map(c => hexToRgba(c, 0.6)) // Transparencia
                }]
            }
        });

        // Renderizar Barras
        const ctxArea = document.getElementById('areaProgressChart').getContext('2d');
        if(areaProgressInstance) areaProgressInstance.destroy();
        areaProgressInstance = new Chart(ctxArea, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Aprobados',
                        data: approvedCounts,
                        backgroundColor: colors 
                    },
                    {
                        label: 'Total Disponibles',
                        data: totalCounts,
                        backgroundColor: '#e0e0e0'
                    }
                ]
            },
            options: {
                scales: { x: { stacked: true }, y: { stacked: true } }
            }
        });

        // --- GR√ÅFICO 4: DISTRIBUCI√ìN DE NOTAS (Pie Chart) ---
        let gradesDist = { excelente:0, bueno:0, regular:0, bajo:0 };
        let hasGrades = false;

        // Verificar si hay notas reales
        if(approvedGrades && Object.keys(approvedGrades).length > 0) {
            Object.values(approvedGrades).forEach(g => {
                hasGrades = true; // Marcamos que s√≠ hay notas
                if(g >= 17) gradesDist.excelente++;
                else if(g >= 14) gradesDist.bueno++;
                else if(g >= 11) gradesDist.regular++;
                else gradesDist.bajo++;
            });
        }

        const ctxGrades = document.getElementById('gradesDistChart').getContext('2d');
        if(gradesDistInstance) gradesDistInstance.destroy();
        
        // Si no hay notas, mostramos un gr√°fico gris "vac√≠o" para que no se vea feo
        const chartData = hasGrades 
            ? [gradesDist.excelente, gradesDist.bueno, gradesDist.regular, gradesDist.bajo]
            : [1]; // Dato dummy para que se pinte el c√≠rculo
            
        const chartColors = hasGrades
            ? ['#27ae60', '#f1c40f', '#e67e22', '#c0392b']
            : ['#eeeeee']; // Gris

        const chartLabels = hasGrades
            ? ['Excelente (17-20)', 'Bueno (14-16)', 'Regular (11-13)', 'Bajo (<11)']
            : ['Sin notas registradas'];

        gradesDistInstance = new Chart(ctxGrades, {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    data: chartData,
                    backgroundColor: chartColors
                }]
            }
        });
    };

    // FUNCI√ìN AUXILIAR 
    // Convierte colores Hex (#ff0000) a RGBA con transparencia
    function hexToRgba(hex, alpha) {
        // Manejo b√°sico de errores si el color no es hex v√°lido
        if(!hex || !hex.startsWith('#')) return `rgba(100,100,100,${alpha})`;
        
        let r = parseInt(hex.slice(1, 3), 16),
            g = parseInt(hex.slice(3, 5), 16),
            b = parseInt(hex.slice(5, 7), 16);

        if(isNaN(r)) return `rgba(100,100,100,${alpha})`;
        return `rgba(${r},${g},${b},${alpha})`;
    }

    // ================= CALCULADORA =================
    let gradeRowCount = 0;
    function initCalculator() {
        const container = document.getElementById('grades-container');
        if(container.children.length === 0) { addGradeRow(25); addGradeRow(25); addGradeRow(20); }
    }
    function addGradeRow(defWeight = '') {
        gradeRowCount++;
        const container = document.getElementById('grades-container');
        const row = document.createElement('div'); row.className = 'grade-row';
        row.innerHTML = `<span style="font-weight:bold;width:50px;">N${gradeRowCount}</span><input type="number" class="grade-input" placeholder="0-20"><input type="number" class="weight-input" placeholder="%" value="${defWeight}"><span>%</span><button class="btn-del-row" onclick="this.parentElement.remove()">√ó</button>`;
        container.appendChild(row);
    }
    function calculateGrades() {
        const rows = document.querySelectorAll('.grade-row');
        let totalWeighted = 0; let totalWeight = 0;
        rows.forEach(row => {
            const g = parseFloat(row.querySelector('.grade-input').value);
            const w = parseFloat(row.querySelector('.weight-input').value);
            if(!isNaN(g) && !isNaN(w)) { totalWeighted += g*(w/100); totalWeight += w; }
        });
        document.getElementById('res-current-avg').innerText = totalWeighted.toFixed(2);
        const box = document.getElementById('res-analysis');
        const minPass = parseFloat(document.getElementById('calc-min-pass').value) || 11;
        const missing = 100 - totalWeight;
        if(totalWeight > 100) box.innerHTML = "<b style='color:red'>Error: >100%</b>";
        else if(totalWeight === 100) box.innerHTML = totalWeighted >= minPass ? "<b>¬°Aprobado!</b>" : "<b>Desaprobado</b>";
        else {
            const needed = (minPass - totalWeighted) / (missing/100);
            box.innerHTML = needed <= 0 ? "¬°Ya aprobaste!" : needed > 20 ? `Imposible aprobar (Necesitas ${needed.toFixed(1)})` : `Necesitas <b>${needed.toFixed(2)}</b> en el ${missing}% restante.`;
        }
    }
    function resetCalculator() {
        document.getElementById('grades-container').innerHTML = ''; gradeRowCount = 0; initCalculator();
        document.getElementById('res-current-avg').innerText = '0.00'; document.getElementById('res-analysis').innerText = '...';
    }



    // ==========================================
    // NUEVA L√ìGICA DE SKILLS (UNIVERSAL Y DIN√ÅMICA)
    // ==========================================

    // 1. INICIALIZAR SKILLS (Llamar en init())
function initSkills() {
    // Cargar DB personalizada o usar vac√≠a
    const storedDB = localStorage.getItem('lumin_skills_db');
    if (storedDB) {
        globalSkillsDB = JSON.parse(storedDB);
    } else {
        // SI ES NUEVO, CARGAMOS UNOS POCOS EJEMPLOS GEN√âRICOS
        // Usamos 'all' para que sumen a cualquier carrera
        globalSkillsDB = [
            { id: 'idioma_ing', name: 'Ingl√©s Profesional', weights: { 'all': 2 } },
            { id: 'ofimatica', name: 'Ofim√°tica / Herramientas Digitales', weights: { 'all': 1 } },
            { id: 'liderazgo', name: 'Liderazgo y Comunicaci√≥n', weights: { 'all': 3 } }
        ];
    }
    renderSkillsUI();
}

// 2. ABRIR/CERRAR EL PANEL DE CONFIGURACI√ìN
window.toggleSkillConfig = function() {
    const p = document.getElementById('skills-config-panel');
    const isHidden = p.style.display === 'none';
    p.style.display = isHidden ? 'block' : 'none';
    
    if(isHidden) {
        // Llenar el dropdown de √°reas con las √°reas que el alumno defini√≥
        const select = document.getElementById('new-skill-area');
        select.innerHTML = '';
        
        if(typeof customAreas === 'undefined' || customAreas.length === 0) {
            select.innerHTML = '<option value="">‚ö† Primero define tus √Åreas en "Mi Carrera"</option>';
        } else {
            customAreas.forEach(area => {
                const opt = document.createElement('option');
                opt.value = area.id;
                opt.text = area.name;
                select.add(opt);
            });
            // Opci√≥n "Todas"
            const optAll = document.createElement('option');
            optAll.value = 'all';
            optAll.text = 'General (Impacta a todas)';
            select.add(optAll);
        }
    }
};

// 3. AGREGAR SKILL MANUALMENTE
window.addNewSkill = function() {
    const name = document.getElementById('new-skill-name').value.trim();
    const areaId = document.getElementById('new-skill-area').value;
    const weight = parseInt(document.getElementById('new-skill-weight').value);
    
    if(!name) return alert("Escribe un nombre para la habilidad.");
    if(!areaId) return alert("Selecciona un √°rea v√°lida.");

    // Generar ID √∫nico
    const id = name.toLowerCase().replace(/[^a-z0-9]/g, '') + Math.floor(Math.random()*1000);

    // Buscar si ya existe la habilidad para solo agregarle peso a otra √°rea
    const existing = globalSkillsDB.find(s => s.name.toLowerCase() === name.toLowerCase());
    
    if(existing) {
        existing.weights[areaId] = weight;
        alert(`Se actualiz√≥ la habilidad "${name}" agregando impacto en esta √°rea.`);
    } else {
        const newSkill = {
            id: id,
            name: name,
            weights: {}
        };
        newSkill.weights[areaId] = weight;
        globalSkillsDB.push(newSkill);
    }

    saveSkillsDB();
    renderSkillsUI();
    document.getElementById('new-skill-name').value = ''; // Limpiar input
};

// 4. GUARDAR EN LOCALSTORAGE
function saveSkillsDB() {
    localStorage.setItem('lumin_skills_db', JSON.stringify(globalSkillsDB));
}

// 5. RENDERIZAR TODO (BARRAS Y CHIPS)
function renderSkillsUI() {
    // A. RENDERIZAR LAS BARRAS DE PROGRESO (LAS √ÅREAS)
    const dashboard = document.getElementById('dynamic-profile-dashboard');
    if(!dashboard) return;
    dashboard.innerHTML = '';

    // Si no hay √°reas definidas, mostrar mensaje
    if(typeof customAreas === 'undefined' || customAreas.length === 0) {
        dashboard.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#777;">Ve a la pesta√±a <b>"Mi Carrera"</b> y define tus √Åreas/Especialidades para ver tu progreso aqu√≠.</div>`;
        return;
    }

    // Calcular puntajes din√°micamente
    const scores = {}; // Puntos obtenidos
    const maxScores = {}; // Puntos posibles total
    
    // Inicializar contadores por √°rea
    customAreas.forEach(a => { scores[a.id] = 0; maxScores[a.id] = 0; });

    // Recorrer Skills
    globalSkillsDB.forEach(skill => {
        const isAcquired = acquiredSkills.has(skill.id);
        
        // Iterar sobre los pesos de esta skill
        for (const [areaId, weight] of Object.entries(skill.weights)) {
            if(areaId === 'all') {
                // Si es 'all', suma a todas las √°reas
                customAreas.forEach(a => {
                    maxScores[a.id] += weight;
                    if(isAcquired) scores[a.id] += weight;
                });
            } else if(maxScores[areaId] !== undefined) {
                // Si es un √°rea espec√≠fica
                maxScores[areaId] += weight;
                if(isAcquired) scores[areaId] += weight;
            }
        }
    });

    // Dibujar Tarjetas
    customAreas.forEach(area => {
        const max = maxScores[area.id] || 1; // Evitar divisi√≥n por cero
        const current = scores[area.id] || 0;
        const pct = Math.round((current / max) * 100);

        const card = document.createElement('div');
        card.className = 'profile-card';
        card.innerHTML = `
            <div class="profile-title" style="color:${area.color}">
                <span class="material-icons">verified</span> ${area.name}
            </div>
            <div class="profile-percent">${pct}%</div>
            <div class="profile-bar-bg">
                <div class="profile-bar-fill" style="width:${pct}%; background:${area.color}"></div>
            </div>
        `;
        dashboard.appendChild(card);
    });

    // B. RENDERIZAR LOS CHIPS (BOTONES)
    const grid = document.getElementById('tools-grid');
    grid.innerHTML = '';
    
    // Ordenar alfab√©ticamente
    globalSkillsDB.sort((a,b) => a.name.localeCompare(b.name));

    globalSkillsDB.forEach(skill => {
        const isChecked = acquiredSkills.has(skill.id);
        const chip = document.createElement('div');
        chip.className = `tool-chip ${isChecked ? 'active' : ''}`;
        
        // Bot√≥n de eliminar skill
        const delBtn = `<span onclick="deleteSkill('${skill.id}', event)" style="margin-left:auto; color:#999; font-size:10px; padding:2px; cursor:pointer;" title="Eliminar Skill">‚úï</span>`;

        chip.onclick = (e) => {
            if(e.target.tagName === 'SPAN') return; // Evitar click en el bot√≥n borrar
            
            if(isChecked) acquiredSkills.delete(skill.id);
            else acquiredSkills.add(skill.id);
            
            localStorage.setItem('unmsm_adm_v11_s', JSON.stringify([...acquiredSkills]));
            renderSkillsUI();
        };
        
        chip.innerHTML = `
            <div class="tool-check">${isChecked ? '‚úì' : ''}</div>
            <span>${skill.name}</span>
            ${delBtn}
        `;
        grid.appendChild(chip);
    });
}

// 6. BORRAR UNA SKILL
window.deleteSkill = function(id, event) {
    event.stopPropagation();
    if(confirm("¬øEliminar esta habilidad de la lista?")) {
        globalSkillsDB = globalSkillsDB.filter(s => s.id !== id);
        acquiredSkills.delete(id);
        saveSkillsDB();
        renderSkillsUI();
    }
};

// 7. BORRAR TODO (RESET)
window.resetSkillsDB = function() {
    if(confirm("¬øEst√°s seguro? Se borrar√°n todas las habilidades personalizadas.")) {
        localStorage.removeItem('lumin_skills_db');
        acquiredSkills.clear();
        localStorage.removeItem('unmsm_adm_v11_s');
        location.reload();
    }
};

// ==========================================
// 8. LA "MAGIA" DE INTERNET (IA SUGGESTION)
// ==========================================
window.suggestSkillsWithAI = async function() {
    if(typeof customAreas === 'undefined' || customAreas.length === 0) {
        return alert("Primero define tus √Åreas en la pesta√±a 'Mi Carrera'.");
    }

    const btn = event.target || document.activeElement;
    const oldText = btn.innerText;
    btn.innerText = "Consultando IA...";
    btn.disabled = true;

    // Crear prompt contexto
    const areaNames = customAreas.map(a => a.name).join(', ');
    
    const prompt = `
        Act√∫a como un API JSON.
        El usuario estudia una carrera con estas √°reas de especializaci√≥n: [${areaNames}].
        Genera una lista de 5 habilidades t√©cnicas (Hard Skills) espec√≠ficas y recomendadas para este perfil.
        
        Formato de respuesta estrictamente JSON array:
        [
            {"name": "Nombre Skill 1", "targetArea": "${customAreas[0].name}", "weight": 3},
            {"name": "Nombre Skill 2", "targetArea": "${customAreas.length > 1 ? customAreas[1].name : customAreas[0].name}", "weight": 2}
        ]
        
        Reglas:
        1. "targetArea" debe coincidir EXACTAMENTE con alguno de estos nombres: ${areaNames}.
        2. "weight" entre 1 y 3.
        3. Solo devuelve el JSON, nada de texto extra.
    `;

    try {
        const encoded = encodeURIComponent(prompt);
        // Usamos Pollinations (gratis, sin key)
        const response = await fetch(`https://text.pollinations.ai/${encoded}?model=openai&seed=${Math.floor(Math.random()*1000)}`);
        const text = await response.text();
        
        // Limpiar respuesta (a veces la IA pone ```json ... ```)
        const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
        const suggestions = JSON.parse(cleanJson);

        let addedCount = 0;

        suggestions.forEach(sugg => {
            // Buscar ID del √°rea basado en el nombre que devolvi√≥ la IA
            let targetId = 'all';
            const foundArea = customAreas.find(a => a.name.toLowerCase() === sugg.targetArea.toLowerCase());
            if(foundArea) targetId = foundArea.id;

            // Verificar duplicados
            if(!globalSkillsDB.find(x => x.name === sugg.name)) {
                globalSkillsDB.push({
                    id: 'ai_' + Math.floor(Math.random()*10000),
                    name: sugg.name,
                    weights: { [targetId]: sugg.weight }
                });
                addedCount++;
            }
        });

        saveSkillsDB();
        renderSkillsUI();
        alert(`‚úÖ La IA agreg√≥ ${addedCount} nuevas habilidades sugeridas a tu lista.`);

    } catch (e) {
        console.error(e);
        alert("La IA tuvo un problema generando el JSON. Intenta de nuevo.");
    }

    btn.innerText = oldText;
    btn.disabled = false;
};

    // ================= SIMULADOR CON MINUTOS (NUEVO) =================

    // 1. Funci√≥n auxiliar: Convierte "12:30" a 12.5 para poder calcular
    function timeToFloat(timeStr) {
        if(!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return h + (m / 60);
    }

    // 2. Nueva versi√≥n de INIT (Ya no llena selects, solo dibuja la tabla)
    function initSchedule() {
        renderScheduleGrid(); 
        renderScheduleItems();
    }

    // 3. Nueva versi√≥n de AGREGAR (Maneja minutos)
    window.addToSchedule = function() {
        const id = document.getElementById('sched-course').value;
        const d = parseInt(document.getElementById('sched-day').value);
        
        // Obtenemos los valores del nuevo input tipo reloj
        const sVal = document.getElementById('sched-start').value;
        const eVal = document.getElementById('sched-end').value;

        if(!id) return alert("Selecciona un curso primero.");
        if(!sVal || !eVal) return alert("Define horas v√°lidas.");

        // Convertimos a decimales (Ej: 12:30 -> 12.5)
        const s = timeToFloat(sVal);
        const e = timeToFloat(eVal);
        
        if(s >= e) return alert("La hora de inicio debe ser menor a la de fin.");
        
        // Verificamos cruce de horarios (Matem√°tica precisa con decimales)
        const conflict = mySchedule.some(x => x.day === d && (
            (s >= x.start && s < x.end) || 
            (e > x.start && e <= x.end) || 
            (s <= x.start && e >= x.end) ||
            (x.start >= s && x.end <= e)
        ));

        if(conflict) {
            return alert("‚õî CRUCE DETECTADO: Ya tienes un curso en ese horario.");
        }
        
        // Color
        const exist = mySchedule.find(x => x.courseId === id);
        const color = exist ? exist.color : ['#e57373','#f06292','#ba68c8','#9575cd','#7986cb','#64b5f6','#4dd0e1','#4db6ac','#81c784','#ffb74d'][Math.floor(Math.random()*10)];
        
        // Guardamos
        mySchedule.push({courseId: id, day: d, start: s, end: e, color: color});
        localStorage.setItem('unmsm_adm_v11_h', JSON.stringify(mySchedule));
        
        renderScheduleItems(); 
        updateScheduleDropdowns();
    };

    // 4. Nueva versi√≥n de DIBUJAR (Calcula la posici√≥n exacta en pixeles)
    function renderScheduleItems() {
        document.querySelectorAll('.course-block').forEach(b => b.remove());
        
        // Calcular cr√©ditos
        let total = 0; let unique = new Set();
        mySchedule.forEach(i => unique.add(i.courseId));
        unique.forEach(id => { const c = courses.find(x => x.id===id); if(c) total+=c.cr; });
        document.getElementById('sim-credits').innerText = total;

        const CELL_HEIGHT = 50; // Altura de cada celda en px (seg√∫n tu CSS)

        mySchedule.forEach((item, idx) => {
            const c = courses.find(x => x.id === item.courseId);
            
            // En qu√© celda base (hora entera) debe empezar. Ej: 12.5 -> Celda de las 12
            const baseHour = Math.floor(item.start);
            
            // Cu√°nto bajar dentro de esa celda (minutos). Ej: 0.5 * 50px = 25px
            const topOffset = (item.start - baseHour) * CELL_HEIGHT;
            
            // Altura total de la caja
            const duration = item.end - item.start;
            const height = (duration * CELL_HEIGHT) - 2; // -2 para que se vea el borde

            // Buscamos la celda de la hora base
            const cell = document.querySelector(`.grid-cell[data-day="${item.day}"][data-hour="${baseHour}"]`);
            
            if(cell) {
                const b = document.createElement('div'); 
                b.className = 'course-block';
                // Aplicamos estilos precisos
                b.style.top = `${topOffset}px`; 
                b.style.height = `${height}px`; 
                b.style.background = item.color;
                
                // Formato de hora bonito para mostrar (12:30 - 14:00)
                const formatTime = (floatTime) => {
                    const h = Math.floor(floatTime);
                    const m = Math.round((floatTime - h) * 60);
                    return `${h}:${m < 10 ? '0'+m : m}`;
                };

                b.innerHTML = `
                    <div class="remove-course" onclick="removeFromSchedule(${idx})">√ó</div>
                    <strong>${c?c.name:item.courseId}</strong>
                    <div style="font-size:0.7rem; line-height:1;">${formatTime(item.start)} - ${formatTime(item.end)}</div>
                `;
                cell.appendChild(b);
            }
        });
    }
    window.updateScheduleDropdowns = function() {
        const sel = document.getElementById('sched-course');
        const cycleFilter = document.getElementById('sched-cycle-filter').value;
        
        sel.innerHTML = '';
        const loadingOpt = document.createElement('option');
        loadingOpt.text = "Actualizando...";
        sel.add(loadingOpt);

        // 1. FILTRO ESTRICTO: 
        // - El curso NO debe estar aprobado.
        // - Y ADEM√ÅS (&&) todos sus requisitos deben estar aprobados (o no tener requisitos).
        let avail = courses.filter(c => 
            !approved.has(c.id) && 
            (c.req.length === 0 || c.req.every(r => approved.has(r)))
        );

        // 2. Aplicar el filtro de ciclo
        if(cycleFilter !== 'all') {
            avail = avail.filter(c => c.c == cycleFilter);
        }

        sel.innerHTML = ''; // Limpiar
        
        if(avail.length === 0) {
            const opt = document.createElement('option');
            opt.text = "No hay cursos disponibles (Requisitos pendientes)";
            opt.disabled = true;
            opt.selected = true;
            sel.add(opt);
        } else {
            avail.sort((a, b) => a.name.localeCompare(b.name));
            
            avail.forEach(c => {
                const count = mySchedule.filter(s => s.courseId === c.id).length;
                const mark = count > 0 ? `(${count}) ` : ''; 
                
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.text = `${mark}${c.name} (${c.cr} Cr.)`;
                sel.add(opt);
            });
        }
    };
    function renderScheduleGrid() {
        const grid = document.getElementById('schedule-grid');
        while(grid.children.length > 7) grid.removeChild(grid.lastChild);
        for(let h=7; h<=22; h++) {
            const t = document.createElement('div'); t.className='grid-time-cell'; t.innerText=`${h}:00`; grid.appendChild(t);
            for(let d=1; d<=6; d++) { const c = document.createElement('div'); c.className='grid-cell'; c.dataset.day=d; c.dataset.hour=h; grid.appendChild(c); }
        }
    }
    
    
    function removeFromSchedule(i) { mySchedule.splice(i,1); localStorage.setItem('unmsm_adm_v11_h', JSON.stringify(mySchedule)); renderScheduleItems(); updateScheduleDropdowns(); }
    function clearSchedule() { if(confirm("¬øBorrar?")) { mySchedule=[]; localStorage.setItem('unmsm_adm_v11_h', JSON.stringify(mySchedule)); renderScheduleItems(); updateScheduleDropdowns(); } }
    
    function exportSchedulePDF() {
        const el = document.getElementById('schedule-export-area');
        const opt = { margin: 5, filename: 'horario-matricula-unmsm.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
        html2pdf().from(el).set(opt).save();
    }

    // --- NUEVO: FUNCI√ìN PARA GENERAR ICS (GOOGLE CALENDAR) ---
    function downloadICS() {
        if(mySchedule.length === 0) return alert("No hay cursos en el horario para exportar.");
        
        // Helper para formatear fecha a string ICS: YYYYMMDDTHHMMSS
        const formatICSDate = (date) => {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0];
        };

        // Helper para obtener el pr√≥ximo "Lunes" (u otro d√≠a)
        const getNextDayOfWeek = (dayIndex) => {
            const today = new Date();
            const resultDate = new Date(today.getTime());
            // dayIndex: 1=Lun, 6=Sab
            // JS getDay(): 0=Dom, 1=Lun...
            // Ajuste para JS
            const jsDay = dayIndex === 7 ? 0 : dayIndex; 
            
            resultDate.setDate(today.getDate() + (jsDay + 7 - today.getDay()) % 7);
            // Si es hoy, lo movemos a hoy, si ya pas√≥ la hora quiz√°s convenga next week, pero dej√©moslo simple: Pr√≥ximo X dia
            if(today.getDay() === jsDay && today.getHours() > 20) {
                 resultDate.setDate(resultDate.getDate() + 7);
            }
            return resultDate;
        };

        let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//UNMSM//Administracion//ES\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";

        mySchedule.forEach(item => {
            const course = courses.find(c => c.id === item.courseId);
            const title = course ? course.name : "Clase UNMSM";
            
            // Calcular fecha de inicio (pr√≥ximo Lunes/Martes etc)
            let startDate = getNextDayOfWeek(item.day);
            startDate.setHours(item.start, 0, 0, 0);
            
            let endDate = new Date(startDate);
            endDate.setHours(item.end, 0, 0, 0);

            icsContent += "BEGIN:VEVENT\n";
            icsContent += "SUMMARY:" + title + "\n";
            icsContent += "DTSTART:" + formatICSDate(startDate) + "\n";
            icsContent += "DTEND:" + formatICSDate(endDate) + "\n";
            icsContent += "RRULE:FREQ=WEEKLY;COUNT=16\n"; // 16 Semanas de ciclo
            icsContent += "DESCRIPTION:Curso del ciclo acad√©mico.\n";
            icsContent += "LOCATION:UNMSM FCA\n";
            icsContent += "STATUS:CONFIRMED\n";
            icsContent += "END:VEVENT\n";
        });

        icsContent += "END:VCALENDAR";

        // Crear archivo y descargar
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', 'mi_horario_unmsm.ics');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ================= ESTRATEGIA & IA (CON GUARDADO) =================

    let deadlineEvents = [];

    // 1. FUNCI√ìN PARA CARGAR (Reemplaza a initStrategy)
    // Busca datos guardados al abrir la p√°gina
    function loadHellEvents() {
        const saved = localStorage.getItem('lumin_heatmap_events');
        if(saved) {
            deadlineEvents = JSON.parse(saved);
        } else {
            deadlineEvents = [];
        }

        // Cargar tambi√©n la fecha de inicio
        const savedDate = localStorage.getItem('lumin_heatmap_start');
        const dateInput = document.getElementById('cycle-start-date');
        if(dateInput) {
            if(savedDate) {
                dateInput.value = savedDate;
            } else {
                dateInput.valueAsDate = new Date(); // Fecha de hoy por defecto
            }
            // Guardar autom√°ticamente cuando cambien la fecha
            dateInput.addEventListener('change', saveHellEvents);
        }
    }

    // 2. FUNCI√ìN PARA GUARDAR
    function saveHellEvents() {
        localStorage.setItem('lumin_heatmap_events', JSON.stringify(deadlineEvents));
        
        const dateInput = document.getElementById('cycle-start-date');
        if(dateInput) {
            localStorage.setItem('lumin_heatmap_start', dateInput.value);
        }
    }

    // 3. AGREGAR EVENTO (Ahora guarda autom√°ticamente)
    window.addHellEvent = function() {
        const week = parseInt(document.getElementById('evt-week').value);
        const name = document.getElementById('evt-name').value;
        const type = parseInt(document.getElementById('evt-type').value);

        if(!week || !name || week < 1 || week > 16) return alert("Datos inv√°lidos. Semana debe ser 1-16.");

        deadlineEvents.push({ week, name, type });
        deadlineEvents.sort((a,b) => a.week - b.week);
        
        saveHellEvents(); // <--- GUARDA AQU√ç
        renderHellGrid();
        
        // Disparar IA si la semana se vuelve cr√≠tica
        const weekLoad = deadlineEvents.filter(e => e.week === week).reduce((acc, e) => acc + e.type, 0);
        if(weekLoad >= 5 && typeof addAIMessage === 'function') {
             addAIMessage(`‚ö†Ô∏è <b>¬°Atenci√≥n Estrat√©gica!</b> Acabas de sobrecargar la <b>Semana ${week}</b>. <br>Recomendaci√≥n: Empieza los res√∫menes o avances en la Semana ${Math.max(1, week-2)}.`);
        }
    };

    // 4. BORRAR EVENTO (Ahora guarda autom√°ticamente)
    window.removeHellEvent = function(index) {
        deadlineEvents.splice(index, 1);
        saveHellEvents(); // <--- GUARDA AQU√ç
        renderHellGrid();
    };

    // 5. DIBUJAR LA GRILLA (Se mantiene igual, necesaria para que funcione lo anterior)
    function renderHellGrid() {
        const grid = document.getElementById('hell-grid');
        if(!grid) return;
        grid.innerHTML = '';

        for(let w=1; w<=16; w++) {
            const events = deadlineEvents.filter(e => e.week === w);
            const loadScore = events.reduce((acc, e) => acc + e.type, 0);
            
            // Determinar nivel de infierno
            let intensityClass = 'level-0'; 
            if(loadScore >= 2 && loadScore < 5) intensityClass = 'level-1'; 
            if(loadScore >= 5 && loadScore < 8) intensityClass = 'level-2'; 
            if(loadScore >= 8) intensityClass = 'level-3'; 

            let eventsHtml = '';
            deadlineEvents.forEach((evt, idx) => {
                if(evt.week === w) {
                    let icon = evt.type === 3 ? '‚ö°' : (evt.type === 2 ? 'üìù' : 'üìå');
                    eventsHtml += `<div class="event-item"><span>${icon} ${evt.name}</span> <span class="del-evt" onclick="removeHellEvent(${idx})">√ó</span></div>`;
                }
            });

            const box = document.createElement('div');
            box.className = `week-box ${intensityClass}`;
            
            box.innerHTML = `
                <div class="week-header">
                    <span>Semana ${w}</span>
                    <span class="week-score">Carga: ${loadScore}</span>
                </div>
                <div style="flex:1; overflow-y:auto; padding-right:2px;">
                    ${eventsHtml}
                </div>
            `;
            grid.appendChild(box);
        }
    }

    // --- 2. EXPORTAR CALENDARIO DE ENTREGAS (.ICS) ---
    function downloadDeadlinesICS() {
        if(deadlineEvents.length === 0) return alert("No hay fechas de ex√°menes/entregas registradas.");
        
        const startInput = document.getElementById('cycle-start-date').value;
        if(!startInput) return alert("Por favor selecciona la 'Fecha Inicio Ciclo' arriba del mapa de calor.");
        
        const cycleStart = new Date(startInput);
        // Ajustar a zona horaria local para evitar desfaces
        cycleStart.setMinutes(cycleStart.getMinutes() + cycleStart.getTimezoneOffset());

        let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//UNMSM//Strategy//ES\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";

        const formatICSDate = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0];

        deadlineEvents.forEach(evt => {
            // Calcular fecha real: Inicio + (Semana-1)*7 d√≠as
            let eventDate = new Date(cycleStart);
            eventDate.setDate(cycleStart.getDate() + (evt.week - 1) * 7);
            
            // Poner hora por defecto 8:00 AM para ex√°menes
            eventDate.setHours(8, 0, 0, 0);
            let endDate = new Date(eventDate);
            endDate.setHours(10, 0, 0, 0);

            icsContent += "BEGIN:VEVENT\n";
            icsContent += `SUMMARY:[S${evt.week}] ${evt.name} (UNMSM)\n`;
            icsContent += "DTSTART:" + formatICSDate(eventDate) + "\n";
            icsContent += "DTEND:" + formatICSDate(endDate) + "\n";
            icsContent += "DESCRIPTION:Recordatorio estrat√©gico de la Semana del Infierno.\n";
            icsContent += "STATUS:CONFIRMED\n";
            icsContent += "BEGIN:VALARM\nTRIGGER:-PT24H\nACTION:DISPLAY\nDESCRIPTION:Estudiar Ma√±ana\nEND:VALARM\n"; // Alarma 24h antes
            icsContent += "END:VEVENT\n";
        });

        icsContent += "END:VCALENDAR";

        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', 'mis_examenes_unmsm.ics');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- 3. INTELIGENCIA ARTIFICIAL (POLLINATIONS ) ---

    // Funci√≥n auxiliar para leer datos del alumno
    function getGlobalContext() {
        // CORRECCI√ìN: Leemos el texto directo del contador de la cabecera
        const totalCreditos = document.getElementById('credits-display').innerText; 

        return {
            promedio: document.getElementById('pps-dashboard').innerText,
            creditos: totalCreditos, // Ahora env√≠a "83" o "91", no "26"
            cursosFaltantes: courses.length - approved.size,
            
            horario: mySchedule.map(s => {
                let c = courses.find(x=>x.id===s.courseId); 
                const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
                return c ? `${c.name} (${dias[s.day]} ${s.start}:00)` : ""; 
            }).join(', '),
            
            examenes: deadlineEvents.map(e => `Semana ${e.week}: ${e.name} (Tipo: ${e.type===3?'Examen':'Trabajo'})`).join(', '),
            skills: [...acquiredSkills].join(', ')
        };
    }

    function handleChatEnter(e) {
        if(e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('user-msg');
        const text = input.value.trim();
        if(!text) return;

        // 1. Mostrar mensaje del usuario
        const chat = document.getElementById('chat-history');
        const userDiv = document.createElement('div');
        userDiv.className = 'msg-user';
        userDiv.innerText = text;
        chat.appendChild(userDiv);
        input.value = ''; 
        chat.scrollTop = chat.scrollHeight;

        // 2. Loading
        const loader = document.getElementById('ai-loading');
        loader.style.display = 'block';

        let responseHTML = "";
        const ctx = getGlobalContext();

        // --- NUEVO: GENERAR RESUMEN DE LA MALLA PARA LA IA ---
        // Esto crea un texto tipo: "Ciclo 1: Lenguaje, Mate I... | Ciclo 2: ..."
        let mallaResumen = "";
        for(let i=1; i<=10; i++) {
            const cursosCiclo = courses.filter(c => c.c === i).map(c => c.name).join(', ');
            mallaResumen += `[Ciclo ${i}]: ${cursosCiclo}\n`;
        }
        // -----------------------------------------------------

        // 3. Prompt Maestro Actualizado (GEN√âRICO Y POTENTE)
        const systemPrompt = `
            Act√∫a como un Asesor Acad√©mico Universitario de Alto Nivel y Mentor Profesional (Lumin Bot).
            
            CONTEXTO DEL ALUMNO:
            - Cr√©ditos: ${ctx.creditos} | Promedio: ${ctx.promedio}
            - Horario: ${ctx.horario}
            - Pr√≥ximos Ex√°menes: ${ctx.examenes}
            - Skills/Habilidades: ${ctx.skills}
            
            INSTRUCCIONES:
            1. Eres un experto en TODAS las carreras (Ingenier√≠a, Medicina, Ciencias, Gesti√≥n, etc.). Adapta tu respuesta al contexto de la pregunta.
            2. Si preguntan sobre anatom√≠a, responde como m√©dico. Si es sobre c√≥digo, como ingeniero de software.
            3. Si la pregunta es sobre organizaci√≥n o la malla, usa los datos del CONTEXTO DEL ALUMNO provisto arriba.
            4. S√© motivador, breve, estrat√©gico y usa negritas <b></b> para resaltar ideas clave.
            5. Tu objetivo es que el alumno apruebe y consiga trabajo.
            
            PREGUNTA DEL ALUMNO: "${text}"
        `;

        try {
            const encodedPrompt = encodeURIComponent(systemPrompt);
            const randomSeed = Math.floor(Math.random() * 1000);
            
            const response = await fetch(`https://text.pollinations.ai/${encodedPrompt}?model=openai&seed=${randomSeed}`);
            
            if (!response.ok) throw new Error("Error IA");
            
            let rawText = await response.text();
            
            responseHTML = rawText
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') 
                .replace(/###/g, '') 
                .replace(/\n/g, '<br>');

        } catch (error) {
            console.error(error);
            responseHTML = `<span style="color:#e74c3c">‚ö†Ô∏è La IA est√° pensando... intenta de nuevo.</span>`;
        }

        loader.style.display = 'none';
        addAIMessage(responseHTML);
    }

    function addAIMessage(htmlText) {
        const chat = document.getElementById('chat-history');
        const aiDiv = document.createElement('div');
        aiDiv.className = 'msg-ai';
        aiDiv.innerHTML = htmlText;
        chat.appendChild(aiDiv);
        chat.scrollTop = chat.scrollHeight;
    }

    function askAI(type) {
        let text = "";
        if(type === 'finance') text = "Expl√≠came qu√© es el EBITDA, para qu√© sirve y dame un ejemplo con una empresa peruana.";
        if(type === 'risk') text = "Analiza mis datos (horario, ex√°menes, promedio) y dime si estoy en riesgo acad√©mico.";
        if(type === 'email') text = "Redacta un correo formal a mi profesor pidiendo una revisi√≥n de examen.";
        
        document.getElementById('user-msg').value = text;
        sendMessage(); 
    }

 // ================= GESTI√ìN DE MALLAS (CORREGIDO) =================

    // --- 1. RESTAURAR ADMINISTRACI√ìN ---
    window.restoreAdminMalla = function() {
        if(confirm("¬øSeguro que quieres borrar tu malla personalizada y volver a la oficial de Administraci√≥n?")) {
            localStorage.removeItem('lumin_custom_malla');
            localStorage.removeItem('lumin_custom_areas');
            // Limpiamos notas para evitar conflictos de IDs
            localStorage.removeItem('unmsm_adm_v11_c');
            localStorage.removeItem('unmsm_adm_v11_g');
            location.reload();
        }
    };

    // --- 2. IMPORTAR JSON ---
    window.importCustomMalla = function() {
        try {
            const jsonText = document.getElementById('json-import-area').value;
            if(!jsonText.trim()) return alert("La caja est√° vac√≠a. Pega el c√≥digo JSON primero.");

            const newCourses = JSON.parse(jsonText);

            // Validaci√≥n simple para asegurar que es una malla v√°lida
            if(!Array.isArray(newCourses) || newCourses.length === 0 || !newCourses[0].name) {
                return alert("El c√≥digo no parece v√°lido o est√° incompleto.");
            }

            if(confirm(`Se cargar√° una malla con ${newCourses.length} cursos. Tus notas actuales se reiniciar√°n. ¬øContinuar?`)) {
                localStorage.setItem('lumin_custom_malla', JSON.stringify(newCourses));
                
                // Reiniciar progreso para evitar errores
                localStorage.removeItem('unmsm_adm_v11_c');
                localStorage.removeItem('unmsm_adm_v11_g');
                
                alert("¬°Malla importada con √©xito!");
                location.reload();
            }
        } catch (e) {
            alert("Error de formato JSON: " + e.message);
        }
    };

    // --- 3. COPIAR JSON GENERADO (NUEVO) ---
    window.copyExportJson = function() {
        const text = document.getElementById('json-export-area');
        text.select();
        text.setSelectionRange(0, 99999); /* Para m√≥viles */
        
        // Intentar copiar al portapapeles
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text.value).then(() => alert("¬°C√≥digo copiado! P√°saselo a tu amigo."));
        } else {
            document.execCommand('copy'); // M√©todo antiguo por si acaso
            alert("¬°C√≥digo copiado!");
        }
    };

    // ==========================================
    // 5. CONSTRUCTOR VISUAL DE MALLAS (BUILDER)
    // ==========================================
    
    let builderCycleCount = 0;


    window.addBuilderCycle = function() {
        builderCycleCount++;
        const area = document.getElementById('builder-cycles-area');
        const div = document.createElement('div');
        div.className = 'builder-cycle';
        div.id = `b-cycle-${builderCycleCount}`;
        div.innerHTML = `
            <div class="b-cycle-title">
                Ciclo ${builderCycleCount}
                <button onclick="addBuilderCourse(${builderCycleCount})" style="background:#27ae60; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem;">+ Agregar Curso</button>
            </div>
            <div class="b-courses-list" id="b-list-${builderCycleCount}"></div>
        `;
        area.appendChild(div);
    };

    window.addBuilderCourse = function(cycleNum) {
        const list = document.getElementById(`b-list-${cycleNum}`);
        const div = document.createElement('div');
        div.className = 'b-course-card';
        
        // 1. Generar opciones de requisitos (Ciclos anteriores)
        let reqOptions = '';
        const allPrevCourses = getCoursesFromBuilder(cycleNum - 1); 
        allPrevCourses.forEach(c => {
            reqOptions += `<option value="${c.id}">${c.name}</option>`;
        });

        // 2. Generar opciones de √ÅREAS (Din√°micas)
        let areaOptions = '<option value="">-- Sin √Årea --</option>';
        customAreas.forEach(a => {
            areaOptions += `<option value="${a.id}" style="color:${a.color}">‚òÖ ${a.name}</option>`;
        });

        // 3. AQU√ç EST√Å EL CAMBIO (Agregamos el input de Req. Cr√©ditos)
        div.innerHTML = `
            <button class="b-del-btn" onclick="this.parentElement.remove()">√ó</button>
            <input type="text" class="b-name" placeholder="Nombre del Curso" onchange="updateAllBuilderDropdowns()">
            
            <div class="b-row">
                <input type="number" class="b-cr" placeholder="Cr." style="width:50px" value="3" title="Cr√©ditos del curso">
                <select class="b-type" style="width:90px"><option value="O">Oblig.</option><option value="E">Elect.</option></select>
                <select class="b-area" style="flex:1;">${areaOptions}</select>
            </div>

            <!-- NUEVO CAMPO: REQUISITO DE CR√âDITOS -->
            <div style="margin-top:5px; display:flex; align-items:center; gap:5px; font-size:0.8rem; color:#666;">
                <span class="material-icons" style="font-size:14px">lock</span>
                <span>Req. Cr√©ditos:</span>
                <input type="number" class="b-req-credits" placeholder="0" style="width:60px; padding:2px;" title="Cr√©ditos totales necesarios para desbloquear este curso">
            </div>

            <label style="font-size:0.7rem; color:#666; display:block; margin-top:5px;">Requisitos Cursos (Ctrl+Click):</label>
            <select class="b-req" multiple style="height:60px;">${reqOptions}</select>
        `;
        list.appendChild(div);
    };

    // Funci√≥n auxiliar para leer lo que el usuario ha escrito hasta ahora
    function getCoursesFromBuilder(maxCycle) {
        let gathered = [];
        // Recorremos todos los ciclos
        for(let i=1; i<=builderCycleCount; i++) {
            if(maxCycle && i > maxCycle) break; // Parar si superamos el ciclo pedido
            const list = document.getElementById(`b-list-${i}`);
            if(!list) continue;
            
            // Recorrer tarjetas del ciclo
            Array.from(list.children).forEach((card, idx) => {
                const name = card.querySelector('.b-name').value.trim();
                if(name) {
                    // Generar un ID simple basado en el nombre (ej: MATEMATICAI)
                    const id = name.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10) + '_' + i;
                    gathered.push({ id: id, name: name, c: i });
                }
            });
        }
        return gathered;
    }

    // ==========================================
    // CORRECCI√ìN: ACTUALIZAR DROPDOWNS SIN PERDER SELECCI√ìN
    // ==========================================
    window.updateAllBuilderDropdowns = function() {
        const allCourses = getCoursesFromBuilder(100); // Obtener todos los cursos actuales
        
        // Recorrer todos los selects de requisito
        document.querySelectorAll('.b-req').forEach(select => {
            // 1. MEMORIZAR: Guardamos qu√© IDs estaban seleccionados antes de borrar
            const savedSelections = Array.from(select.selectedOptions).map(opt => opt.value);

            // Buscar en qu√© ciclo est√° este select para mostrar solo anteriores
            const parentCycle = parseInt(select.closest('.builder-cycle').id.replace('b-cycle-',''));
            
            let opts = '<option value="">-- Sin Requisito --</option>';
            
            allCourses.forEach(c => {
                // Solo cursos de ciclos anteriores
                if(c.c < parentCycle) { 
                    // 2. RECUPERAR: Si el ID estaba guardado, le ponemos 'selected'
                    const isSelected = savedSelections.includes(c.id) ? 'selected' : '';
                    opts += `<option value="${c.id}" ${isSelected}>${c.name}</option>`;
                }
            });

            select.innerHTML = opts;
            
            // Forzar actualizaci√≥n visual si es necesario (para algunos navegadores)
            if(savedSelections.length > 0) {
                 Array.from(select.options).forEach(opt => {
                     if(savedSelections.includes(opt.value)) opt.selected = true;
                 });
            }
        });
    };

    // GUARDAR TODO
    // ==========================================
    // PASO 2: GUARDAR MALLA (CON REQUISITO DE CR√âDITOS)
    // ==========================================
    window.saveBuilderMalla = function() {
        const newCourses = [];
        
        for(let i=1; i<=builderCycleCount; i++) {
            const list = document.getElementById(`b-list-${i}`);
            if(!list) continue;
            
            Array.from(list.children).forEach(card => {
                const name = card.querySelector('.b-name').value.trim();
                const cr = parseInt(card.querySelector('.b-cr').value) || 3;
                const type = card.querySelector('.b-type').value;
                
                // --- NUEVO: LEER EL INPUT DE CR√âDITOS REQUERIDOS ---
                const reqCrInput = card.querySelector('.b-req-credits');
                // Si escribieron algo, lo guardamos como n√∫mero. Si no, es 0.
                const reqCr = reqCrInput && reqCrInput.value ? parseInt(reqCrInput.value) : 0;
                // ---------------------------------------------------

                const reqSelect = card.querySelector('.b-req');
                let selectedReqs = Array.from(reqSelect.selectedOptions).map(opt => opt.value).filter(r => r !== "");
                
                const areaSelect = card.querySelector('.b-area');
                const areaVal = areaSelect ? areaSelect.value : "";
                const tags = areaVal ? [areaVal] : [];

                if(name) {
                    const id = name.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10) + '_' + i;
                    
                    // --- NUEVO: AGREGAMOS 'reqCr' AL OBJETO ---
                    newCourses.push({ id, name, cr, c: i, t: type, req: selectedReqs, reqCr: reqCr, tags });
                }
            });
        }

        if(newCourses.length === 0) return alert("La malla est√° vac√≠a. Agrega cursos.");

        if(confirm("¬øGuardar y aplicar esta malla?")) {
            // 1. Guardar en memoria
            courses = newCourses;
            localStorage.setItem('lumin_custom_malla', JSON.stringify(courses));
            localStorage.setItem('lumin_custom_areas', JSON.stringify(customAreas));

            // 2. Limpiar progreso anterior
            approved = new Set();
            approvedGrades = {};
            localStorage.removeItem('unmsm_adm_v11_c');
            localStorage.removeItem('unmsm_adm_v11_g');
            
            // 3. Mostrar c√≥digo para compartir
            const sharePanel = document.getElementById('share-panel');
            const exportArea = document.getElementById('json-export-area');
            
            // Si tienes el panel de compartir en tu HTML, lo mostramos
            if(sharePanel && exportArea) {
                sharePanel.style.display = 'block';
                exportArea.value = JSON.stringify(courses);
            }

            alert("¬°Malla Guardada! Se han aplicado los nuevos requisitos.");
            
            // 4. Actualizar todo visualmente
            renderMalla();
            renderSkills();
            updateStats();
            renderAnalytics(); 
            
            // Si estamos en la pesta√±a de configuraci√≥n, actualizamos el builder tambi√©n
            // (Opcional, pero ayuda a confirmar que se guard√≥)
            if(document.getElementById('page-config').classList.contains('active')) {
                populateBuilderFromMemory();
            }
        }
    };
     
    // ==========================================
    // PASO 3: CARGAR DATOS EN EL CONSTRUCTOR (CON CR√âDITOS)
    // ==========================================
    window.populateBuilderFromMemory = function() {
        const area = document.getElementById('builder-cycles-area');
        area.innerHTML = ''; 
        builderCycleCount = 0; 

        // 1. Encontrar cu√°l es el √∫ltimo ciclo
        let maxCycle = 10;
        if (courses.length > 0) {
            maxCycle = Math.max(...courses.map(c => c.c), 10);
        }

        // 2. Crear los ciclos vac√≠os
        for (let i = 1; i <= maxCycle; i++) {
            addBuilderCycle(); 
        }

        // 3. Rellenar los cursos
        courses.forEach(c => {
            addBuilderCourse(c.c);
            const list = document.getElementById(`b-list-${c.c}`);
            const card = list.lastElementChild;

            if(card) {
                // Llenar datos b√°sicos
                card.querySelector('.b-name').value = c.name;
                card.querySelector('.b-cr').value = c.cr;
                card.querySelector('.b-type').value = c.t;
                
                // --- NUEVO: LLENAR EL REQUISITO DE CR√âDITOS ---
                const reqCrInput = card.querySelector('.b-req-credits');
                // Si el curso tiene el dato guardado (c.reqCr), lo ponemos. Si no, vac√≠o.
                if(reqCrInput) reqCrInput.value = c.reqCr || ""; 
                // ----------------------------------------------

                // Llenar √Årea (Color)
                if (c.tags && c.tags.length > 0) {
                    const areaSelect = card.querySelector('.b-area');
                    if(areaSelect) areaSelect.value = c.tags[0];
                }
            }
        });

        updateAllBuilderDropdowns();
        
        // 4. Marcar requisitos de Cursos (Select M√∫ltiple)
        courses.forEach(c => {
            const list = document.getElementById(`b-list-${c.c}`);
            const cards = Array.from(list.children);
            const card = cards.find(div => div.querySelector('.b-name').value === c.name);
            
            if(card && c.req && c.req.length > 0) {
                const reqSelect = card.querySelector('.b-req');
                Array.from(reqSelect.options).forEach(opt => {
                    if(c.req.includes(opt.value)) opt.selected = true;
                });
            }
        });
    };
    // ------------------------------------------------


    // ==========================================
    // INICIALIZACI√ìN DEL CONSTRUCTOR
    // ==========================================
    window.initBuilder = function() {
        
        initCustomAreas(); // <--- ESTA ES LA L√çNEA NUEVA IMPORTANTE
        
        const area = document.getElementById('builder-cycles-area');
        if(!area) return;
        
        area.innerHTML = '';
        builderCycleCount = 0;
        // Crear 10 ciclos por defecto
        for(let i=0; i<10; i++) window.addBuilderCycle();
    };
// ================= COMUNIDAD (REPOSITORIO) =================

    // ==========================================
    // L√ìGICA DE COMUNIDAD EN TIEMPO REAL (FIRESTORE)
    // ==========================================

    // 1. Funci√≥n para mostrar la interfaz de Comunidad
    // ==========================================
    // ADMINISTRACI√ìN DE COMUNIDAD (NUEVO)
    // ==========================================
    
    // 1. LISTA DE ADMINS (Correos autorizados para borrar)
    const ADMIN_EMAILS = [
        "andersonpedroescobar292@gmail.com",
        "luminstudy.oficial@gmail.com" ,
        "dianapinarez@gmail.com"
    ];

    // 2. FUNCI√ìN DE RENDERIZADO (MODIFICADA: SIN FORMULARIO DE SUBIDA)
    window.renderComunidad = async function() {
        const container = document.getElementById('repo-container');
        if(!container) return;
        
        // --- AQU√ç EST√Å EL CAMBIO ---
        // Hemos quitado los inputs de texto y el bot√≥n de subir viejo.
        // Ahora solo hay un t√≠tulo y un bot√≥n para IR a la pesta√±a de carga.
        container.innerHTML = `
            <div style="grid-column: 1/-1; background: var(--bg-card); padding:20px; border-radius:12px; margin-bottom:20px; border-left: 5px solid var(--primary); box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:15px;">
                <div>
                    <h3 style="margin:0;">‚òÅÔ∏è Repositorio Acad√©mico Compartido</h3>
                    <p style="margin:5px 0 0 0; color:#666;">Descarga mallas creadas por otros estudiantes o comparte la tuya.</p>
                </div>
                
                <!-- Este bot√≥n te lleva a la nueva pesta√±a que creamos -->
                <button onclick="showPage('subirjson')" style="background:var(--text-main); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">
                    <span class="material-icons">upload_file</span> Ir a Publicar mi Malla
                </button>
            </div>
            <div id="mallas-loader" style="grid-column: 1/-1; text-align:center; padding:20px;">Cargando mallas de la nube...</div>
        `;
        // ---------------------------

        try {
            const q = query(collection(db, "mallas"), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);
            
            document.getElementById('mallas-loader').style.display = 'none';

            // --- DETECCI√ìN DE ADMIN ---
            const currentUser = auth.currentUser;
            const userEmail = currentUser ? currentUser.email.toLowerCase() : "";
            const isAdmin = ADMIN_EMAILS.includes(userEmail);
            // --------------------------

            const grouped = {};
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                data.id = docSnap.id; 
                
                const uni = (data.uni || "Otros").toUpperCase();
                if(!grouped[uni]) grouped[uni] = [];
                grouped[uni].push(data);
            });

            if(Object.keys(grouped).length === 0) {
                container.innerHTML += `<div style="grid-column:1/-1; text-align:center; color:#777; padding:40px;">A√∫n no hay mallas subidas. ¬°S√© el primero en la pesta√±a "Cargar Datos"!</div>`;
                return;
            }

            Object.keys(grouped).sort().forEach(uni => {
                const section = document.createElement('div');
                section.style.gridColumn = "1 / -1";
                section.innerHTML = `<h3 style="border-bottom:2px solid #ccc; padding-bottom:5px; margin-top:20px; color:var(--text-main);"><span class="material-icons" style="vertical-align:bottom">school</span> ${uni}</h3>`;
                container.appendChild(section);

                grouped[uni].forEach(malla => {
                    const card = document.createElement('div');
                    card.className = 'repo-card';
                    const color = malla.uni === 'UNMSM' ? '#8a0303' : (malla.uni === 'UNI' ? '#d35400' : '#2980b9');
                    
                    // --- BOT√ìN DE BORRAR (ADMIN) ---
                    let deleteBtn = '';
                    if(isAdmin) {
                        deleteBtn = `
                        <button onclick="deleteCloudMalla('${malla.id}')" style="background:#c0392b; color:white; border:none; padding:8px; cursor:pointer; width:100%; font-weight:bold; margin-top:5px; border-radius:4px; display:flex; align-items:center; justify-content:center; gap:5px;">
                            <span class="material-icons" style="font-size:14px">delete</span> BORRAR (ADMIN)
                        </button>`;
                    }
                    // -------------------------------

                    card.innerHTML = `
                        <div class="repo-header" style="background:${color}15; color:${color}; height:80px; font-size:2.5rem;">
                            <span class="material-icons">folder_shared</span>
                        </div>
                        <div class="repo-body">
                            <div class="repo-uni" style="color:${color}">${malla.uni}</div>
                            <div class="repo-career">${malla.career}</div>
                            <div class="repo-stats">
                                <span>üìÖ ${new Date(malla.date.seconds * 1000).toLocaleDateString()}</span>
                                <span style="font-size:0.7rem; color:#aaa;">${malla.author ? 'Autor: ' + malla.author.split('@')[0] : ''}</span>
                            </div>
                            <button class="btn-load-repo" onclick='loadCloudMalla(${JSON.stringify(malla.coursesJson)}, "${malla.areasJson ? "YES" : "NO"}", ${JSON.stringify(malla.areasJson || "[]")})'>
                                Cargar Malla
                            </button>
                            ${deleteBtn}
                        </div>
                    `;
                    container.appendChild(card);
                });
            });

        } catch (e) {
            console.error("Error cargando mallas: ", e);
            const loader = document.getElementById('mallas-loader');
            if(loader) loader.innerText = "Error cargando. " + e.message;
        }
    };

    // 3. NUEVA FUNCI√ìN PARA EJECUTAR EL BORRADO
    window.deleteCloudMalla = async function(docId) {
        if(confirm("‚ö†Ô∏è MODO ADMINISTRADOR:\n\n¬øEst√°s seguro de ELIMINAR PERMANENTEMENTE esta malla de la base de datos?\nEsta acci√≥n no se puede deshacer.")) {
            try {
                // Borramos usando el ID del documento
                await deleteDoc(doc(db, "mallas", docId));
                alert("üóëÔ∏è Malla eliminada correctamente.");
                
                // Recargamos la lista para ver que desapareci√≥
                renderComunidad(); 
            } catch (e) {
                alert("Error al eliminar: " + e.message);
                console.error(e);
            }
        }
    };

    

    // 3. Funci√≥n para CARGAR una malla de la nube
    window.loadCloudMalla = function(jsonCourses, hasAreas, jsonAreas) {
        if(confirm("‚ö†Ô∏è ¬øCargar esta malla? Se reemplazar√° tu malla actual y tu progreso.")) {
            try {
                // Cargar Cursos
                const newCourses = typeof jsonCourses === 'string' ? JSON.parse(jsonCourses) : jsonCourses;
                localStorage.setItem('lumin_custom_malla', JSON.stringify(newCourses));
                
                // Cargar √Åreas (Si existen en la nube)
                if(hasAreas === "YES") {
                    const newAreas = typeof jsonAreas === 'string' ? JSON.parse(jsonAreas) : jsonAreas;
                    localStorage.setItem('lumin_custom_areas', JSON.stringify(newAreas));
                } else {
                    // Si es una malla vieja sin √°reas, ponemos unas por defecto gen√©ricas
                    localStorage.removeItem('lumin_custom_areas');
                }

                // Limpiar progreso
                localStorage.removeItem('unmsm_adm_v11_c');
                localStorage.removeItem('unmsm_adm_v11_g');

                alert("Malla cargada correctamente.");
                location.reload();

            } catch(e) {
                alert("Error procesando los datos de la malla.");
                console.error(e);
            }
        }
    }

    // ==========================================
    // PASO 3: L√ìGICA DE CARGA Y PUBLICACI√ìN (TEXTO)
    // ==========================================

    // A. Bot√≥n "Pegar mi Malla Actual Autom√°ticamente"
    window.fillJsonWithCurrent = function() {
        if(courses.length === 0) return alert("Tu malla est√° vac√≠a, no hay nada que copiar.");
        const json = JSON.stringify(courses);
        document.getElementById('pub-json-area').value = json;
    };

    // B. Bot√≥n "PUBLICAR EN COMUNIDAD" (Sube a Firebase)
    window.publishToCommunity = async function() {
        const uni = document.getElementById('pub-uni').value.trim();
        const career = document.getElementById('pub-career').value.trim();
        const jsonText = document.getElementById('pub-json-area').value.trim();

        // 1. Validaciones
        if(!uni || !career || !jsonText) {
            return alert("Faltan datos. Por favor completa Universidad, Carrera y el C√≥digo JSON.");
        }
        try {
            JSON.parse(jsonText); // Verificamos que sea JSON v√°lido
        } catch (e) {
            return alert("El c√≥digo JSON no es v√°lido. Revisa que est√© bien copiado.");
        }

        if(!confirm(`¬øEst√°s seguro de publicar la malla de ${career} (${uni}) para todos?`)) return;

        try {
            // 2. Guardar en la Base de Datos (Firestore)
            await addDoc(collection(db, "mallas"), {
                uni: uni.toUpperCase(), // Guardar en may√∫sculas
                career: career,
                coursesJson: jsonText,
                // Truco: Si el JSON que suben es igual al que tienen puesto, guardamos sus colores (areas)
                // Si es un JSON externo, guardamos un array vac√≠o para no romper nada.
                areasJson: (jsonText === JSON.stringify(courses)) ? JSON.stringify(customAreas) : "[]", 
                date: serverTimestamp(),
                author: auth.currentUser ? auth.currentUser.email : "An√≥nimo"
            });
            
            alert("‚úÖ ¬°Aporte subido a la Comunidad con √©xito!");
            
            // 3. Limpiar formulario y llevar a la comunidad
            document.getElementById('pub-uni').value = '';
            document.getElementById('pub-career').value = '';
            document.getElementById('pub-json-area').value = '';
            showPage('comunidad'); // Cambia de pesta√±a autom√°ticamente

        } catch (e) {
            console.error(e);
            alert("Error al subir: " + e.message);
        }
    };

    // C. Bot√≥n "CARGAR Y GUARDAR" (Lee el texto de la derecha)
    window.loadFromTextArea = function() {
        const jsonText = document.getElementById('import-json-area').value.trim();
        if(!jsonText) return alert("La caja est√° vac√≠a. Pega el c√≥digo primero.");

        try {
            const newCourses = JSON.parse(jsonText);
            
            // Validar que sea una lista
            if (!Array.isArray(newCourses)) throw new Error("El c√≥digo no es una lista v√°lida de cursos.");

            // Advertencia final
            if(confirm("‚ö†Ô∏è ADVERTENCIA: Se reemplazar√° tu malla actual y se borrar√°n tus notas y progreso. ¬øContinuar?")) {
                
                // 1. Guardar nueva malla
                localStorage.setItem('lumin_custom_malla', JSON.stringify(newCourses));
                
                // 2. Reiniciar notas (Importante para evitar errores)
                localStorage.removeItem('unmsm_adm_v11_c');
                localStorage.removeItem('unmsm_adm_v11_g');
                
                // (Opcional) Si el JSON no tra√≠a √°reas personalizadas, podr√≠amos resetearlas, 
                // pero mejor las dejamos como est√°n por si el usuario ya ten√≠a sus colores.

                alert("¬°Malla cargada correctamente! Recargando...");
                location.reload();
            }
        } catch (e) {
            alert("C√≥digo inv√°lido: " + e.message);
        }
    };

    // ==========================================
    // CERRAR SESI√ìN
    // ==========================================
    window.logout = function() {
        if(confirm("¬øCerrar sesi√≥n y salir?")) {
            signOut(auth).then(() => {
                location.reload(); // Recargar para volver al login
            }).catch((error) => {
                console.error(error);
            });
        }
    };

    // ==========================================
    // L√ìGICA DEL GENERADOR DE HORARIOS (IA)
    // ==========================================
    
    let generatedSchedules = []; // Aqu√≠ guardaremos los resultados
    let currentGenIndex = 0;     // Para navegar entre opciones (1 de 5...)

    // 1. Mostrar/Ocultar el Panel
    window.toggleGenerator = function() {
        const p = document.getElementById('generator-panel');
        if(p) {
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
            // Si est√° vac√≠o, agregamos un curso autom√°ticamente para que no se vea feo
            const container = document.getElementById('gen-inputs-container');
            if(p.style.display === 'block' && container.children.length === 0) {
                addGenCourse();
            }
        }
    };

    // 2. Agregar Curso al Generador
    window.addGenCourse = function() {
        const container = document.getElementById('gen-inputs-container');
        const id = Date.now() + Math.random().toString(36).substr(2, 5); // ID √∫nico
        const div = document.createElement('div');
        div.className = 'gen-course-box';
        div.id = `gc-${id}`;
        
        div.innerHTML = `
            <h4>
                <input type="text" class="gc-name" placeholder="Nombre del Curso (Ej: Matem√°tica)">
                <button class="gen-del-btn" onclick="this.closest('.gen-course-box').remove()">√ó</button>
            </h4>
            <div class="gc-sections"></div>
            <button onclick="addGenSection('${id}')" style="font-size:0.8rem; margin-top:5px; cursor:pointer; background:#eee; border:none; padding:5px; border-radius:4px;">+ Agregar Opci√≥n de Horario</button>
        `;
        container.appendChild(div);
        
        // Agregamos la primera opci√≥n autom√°ticamente
        addGenSection(id);
    };

    // 3. Agregar Secci√≥n (Opci√≥n de Horario)
    window.addGenSection = function(courseId) {
        const box = document.querySelector(`#gc-${courseId} .gc-sections`);
        if(!box) return;
        
        const row = document.createElement('div');
        row.className = 'gen-section-row';
        row.innerHTML = `
            <select class="gs-day" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
                <option value="1">Lunes</option><option value="2">Martes</option><option value="3">Mi√©rcoles</option>
                <option value="4">Jueves</option><option value="5">Viernes</option><option value="6">S√°bado</option>
            </select>
            <input type="time" class="gs-start" value="08:00" style="padding:5px; border-radius:4px; border:1px solid #ccc;"> a 
            <input type="time" class="gs-end" value="10:00" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
            <button class="gen-del-btn" onclick="this.parentElement.remove()" title="Borrar esta opci√≥n">√ó</button>
        `;
        box.appendChild(row);
    };

    // 4. EL ALGORITMO INTELIGENTE (Backtracking)
    window.runGenerator = function() {
        // A. Recopilar Datos del HTML
        const inputs = [];
        const courseBoxes = document.querySelectorAll('.gen-course-box');
        
        courseBoxes.forEach(box => {
            const name = box.querySelector('.gc-name').value.trim() || "Curso Sin Nombre";
            const sections = [];
            
            // Leemos cada fila de horario
            box.querySelectorAll('.gen-section-row').forEach(row => {
                sections.push({
                    day: parseInt(row.querySelector('.gs-day').value),
                    start: timeToFloatGen(row.querySelector('.gs-start').value),
                    end: timeToFloatGen(row.querySelector('.gs-end').value)
                });
            });
            
            // Solo agregamos cursos que tengan al menos una opci√≥n v√°lida
            if(sections.length > 0) {
                inputs.push({ name: name, options: sections });
            }
        });

        if(inputs.length === 0) return alert("Por favor agrega cursos y horarios primero.");

        // B. Algoritmo Recursivo para buscar combinaciones
        generatedSchedules = [];
        
        function findCombinations(courseIdx, currentSchedule) {
            // Si ya revisamos todos los cursos, ¬°encontramos una combinaci√≥n v√°lida!
            if(courseIdx === inputs.length) {
                generatedSchedules.push([...currentSchedule]); // Guardamos copia
                return;
            }

            const currentCourse = inputs[courseIdx];

            // Probamos cada opci√≥n de horario de este curso
            for(let option of currentCourse.options) {
                // Verificamos si choca con lo que ya llevamos agendado
                const clash = currentSchedule.some(item => 
                    item.day === option.day && (
                        (option.start >= item.start && option.start < item.end) || // Empieza dentro
                        (option.end > item.start && option.end <= item.end) ||     // Termina dentro
                        (option.start <= item.start && option.end >= item.end)     // Envuelve
                    )
                );

                if(!clash) {
                    // Si no choca, lo agregamos temporalmente
                    currentSchedule.push({
                        courseName: currentCourse.name,
                        day: option.day,
                        start: option.start,
                        end: option.end,
                        color: getRandomColorGen() // Asignamos color al azar
                    });

                    // Recursividad: Vamos al siguiente curso
                    findCombinations(courseIdx + 1, currentSchedule);

                    // Backtracking: Lo quitamos para probar la siguiente opci√≥n del bucle
                    currentSchedule.pop();
                }
            }
        }

        // Ejecutar algoritmo
        findCombinations(0, []);

        // C. Mostrar Resultados
        const resultsArea = document.getElementById('gen-results-area');
        if(generatedSchedules.length === 0) {
            alert("‚ö†Ô∏è ¬°Imposible! Todas las combinaciones tienen cruce de horarios. Intenta quitar alg√∫n curso o agregar m√°s opciones.");
            resultsArea.style.display = 'none';
        } else {
            currentGenIndex = 0;
            resultsArea.style.display = 'block';
            showGenPreview(); // Mostrar la primera opci√≥n
            alert(`‚úÖ ¬°√âxito! Se encontraron ${generatedSchedules.length} combinaciones posibles.`);
        }
    };

    // 5. Visualizar Horario (Miniatura)
    function showGenPreview() {
        const sched = generatedSchedules[currentGenIndex];
        const grid = document.getElementById('gen-preview-grid');
        grid.innerHTML = ''; // Limpiar

        document.getElementById('gen-counter-display').innerText = `Opci√≥n ${currentGenIndex + 1} de ${generatedSchedules.length}`;

        // Dibujar bloquecitos
        sched.forEach(item => {
            const div = document.createElement('div');
            div.className = 'gen-mini-block';
            div.style.background = item.color;
            
            // C√°lculos para posicionar en la miniatura
            // Ancho: 100% / 6 d√≠as = 16.6%
            div.style.left = `${(item.day - 1) * 16.66}%`;
            div.style.width = '16%';
            
            // Alto: Asumimos jornada de 7am a 10pm (15 horas)
            // 300px altura total / 15 horas = 20px por hora
            const startHour = 7; 
            const pxPerHour = 20;
            
            const top = (item.start - startHour) * pxPerHour;
            const height = (item.end - item.start) * pxPerHour;

            div.style.top = `${Math.max(0, top)}px`;
            div.style.height = `${Math.max(10, height)}px`;
            
            // Texto chiquito
            div.innerHTML = `<b>${item.courseName.substring(0,10)}..</b><br>${formatTimeGen(item.start)}-${formatTimeGen(item.end)}`;
            
            grid.appendChild(div);
        });
    }

    // 6. Botones Siguiente / Anterior
    window.nextSchedule = function() {
        if(currentGenIndex < generatedSchedules.length - 1) {
            currentGenIndex++;
            showGenPreview();
        }
    };
    window.prevSchedule = function() {
        if(currentGenIndex > 0) {
            currentGenIndex--;
            showGenPreview();
        }
    };

    // 7. Aplicar al Horario Real
    window.applyGeneratedSchedule = function() {
        if(confirm("¬øUsar este horario? Se reemplazar√° lo que tengas en el simulador principal.")) {
            const selected = generatedSchedules[currentGenIndex];
            
            // Convertimos al formato que usa tu simulador principal
            mySchedule = selected.map(item => ({
                courseId: item.courseName, // Usamos nombre como ID temporal
                day: item.day,
                start: item.start,
                end: item.end,
                color: item.color
            }));
            
            // Guardar y renderizar
            localStorage.setItem('unmsm_adm_v11_h', JSON.stringify(mySchedule));
            renderScheduleItems(); // Funci√≥n del simulador principal
            updateScheduleDropdowns(); 
            
            // Scroll hacia el horario grande
            document.querySelector('.scheduler-container').scrollIntoView({behavior: 'smooth'});
        }
    };

    // --- FUNCIONES AUXILIARES ---
    function timeToFloatGen(timeStr) {
        if(!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return h + (m / 60);
    }
    
    function formatTimeGen(floatTime) {
        const h = Math.floor(floatTime);
        const m = Math.round((floatTime - h) * 60);
        return `${h}:${m < 10 ? '0'+m : m}`;
    }

    function getRandomColorGen() {
        const colors = ['#e57373','#f06292','#ba68c8','#9575cd','#7986cb','#64b5f6','#4db6ac','#81c784','#ffb74d','#a1887f'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // ==========================================
    // EXPORTAR FUNCIONES AL HTML (NECESARIO PARA MODULE)
    // ==========================================
    window.showPage = showPage;
    window.toggleTheme = toggleTheme;
    window.resetMalla = resetMalla;
    window.exportPDF = exportPDF;
    window.addGradeRow = addGradeRow;
    window.calculateGrades = calculateGrades;
    window.resetCalculator = resetCalculator;
    window.addToSchedule = addToSchedule;
    window.clearSchedule = clearSchedule;
    window.removeFromSchedule = removeFromSchedule;
    window.downloadICS = downloadICS;
    window.exportSchedulePDF = exportSchedulePDF;
    window.downloadDeadlinesICS = downloadDeadlinesICS;
    window.addHellEvent = addHellEvent;
    window.removeHellEvent = removeHellEvent;
    window.sendMessage = sendMessage;
    window.handleChatEnter = handleChatEnter;
    window.askAI = askAI;
    
    // Gesti√≥n de Mallas
    window.restoreAdminMalla = restoreAdminMalla;
    window.importCustomMalla = importCustomMalla;
    window.copyExportJson = copyExportJson; // Agregu√© esta que faltaba exportar
    // window.exportCurrentMalla = exportCurrentMalla; <--- ESTA LINEA ERA EL ERROR (BORRADA)

    // Builder
    window.initBuilder = initBuilder;
    window.addBuilderCycle = addBuilderCycle;
    window.addBuilderCourse = addBuilderCourse;
    window.saveBuilderMalla = saveBuilderMalla;
    window.updateAllBuilderDropdowns = updateAllBuilderDropdowns;
    
    // Comunidad
    // window.loadRepoMalla = loadRepoMalla; // <--- ESTA LINEA SE BORRA PORQUE YA NO EXISTE
    window.renderComunidad = renderComunidad;
    
    window.loadCloudMalla = loadCloudMalla;

    // Gesti√≥n de √Åreas (Agregu√© estas por si acaso las necesitas en los botones HTML)
    window.addNewArea = addNewArea;
    window.resetAreas = resetAreas;
    window.removeCustomArea = removeCustomArea;

    window.deleteCloudMalla = deleteCloudMalla;
    // -----------------------------------------------
    window.toggleGoalsEdit = toggleGoalsEdit;
    window.saveDashboardSettings = saveDashboardSettings;

    window.logout = logout;

    // EXPORTAR FUNCIONES DEL GENERADOR IA
    window.toggleGenerator = toggleGenerator;
    window.addGenCourse = addGenCourse;
    window.addGenSection = addGenSection;
    window.runGenerator = runGenerator;
    window.nextSchedule = nextSchedule;
    window.prevSchedule = prevSchedule;
    window.applyGeneratedSchedule = applyGeneratedSchedule;

    // --- NUEVAS FUNCIONES DE SKILLS ---
    window.toggleSkillConfig = toggleSkillConfig;
    window.addNewSkill = addNewSkill;
    window.suggestSkillsWithAI = suggestSkillsWithAI;
    window.deleteSkill = deleteSkill;
    window.resetSkillsDB = resetSkillsDB;
    // ----------------------------------
    
    // Iniciar la app
    // Aseguramos que el DOM est√© listo antes de iniciar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
</script>
</body>
</html>